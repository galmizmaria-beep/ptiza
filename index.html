<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞: –ú–∞—Å—Ç–µ—Ä</title>
    <style>
        :root { 
            --primary: #00d2ff; 
            --bg: #040a18; 
            --panel: rgba(10, 16, 36, 0.7); 
            --text: #e0e0ff; 
            --accent: #ff00ff; 
            --success: #00ff88;
            --border-glow: #00a2ff80;
            --shadow-glow-soft: #00d2ff30;
            --shadow-glow-hard: #00d2ff;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: var(--bg) url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Cdefs%3E%3CradialGradient id="grad" cx="50%25" cy="50%25" r="50%25"%3E%3Cstop offset="0%25" stop-color="%23fff" stop-opacity="0.2" /%3E%3Cstop offset="100%25" stop-color="%23fff" stop-opacity="0" /%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx="20" cy="30" r="1.5" fill="url(%23grad)"/%3E%3Ccircle cx="80" cy="70" r="1" fill="url(%23grad)"/%3E%3Ccircle cx="50" cy="90" r="0.5" fill="url(%23grad)"/%3E%3Ccircle cx="90" cy="10" r="1.2" fill="url(%23grad)"/%3E%3C/svg%3E');
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
            font-size: 14px; 
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid var(--border-glow); 
            padding-bottom: 15px; 
            margin-bottom: 20px; 
            text-shadow: 0 0 10px var(--shadow-glow-hard);
        }
        h1 { margin: 0; color: var(--primary); text-transform: uppercase; font-size: 22px; }
        .lang-switch button { background: #333; color: #fff; border: 1px solid #555; padding: 5px 10px; cursor: pointer; transition: 0.3s; }
        .lang-switch button.active { background: var(--primary); color: #000; font-weight: bold; box-shadow: 0 0 10px var(--shadow-glow-hard); }

        .main-grid { 
            display: grid; 
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); 
            gap: 20px; 
        }
        .card { 
            background: var(--panel); 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid var(--border-glow);
            box-shadow: 0 0 15px var(--shadow-glow-soft), inset 0 0 10px var(--shadow-glow-soft);
            backdrop-filter: blur(5px);
            overflow-y: auto; 
            transition: all 0.3s ease;
        }
        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 25px var(--shadow-glow-soft), inset 0 0 15px var(--shadow-glow-soft);
        }
        
        .grid-col-span-2 { grid-column: 1 / -1; }

        h2 { margin-top: 0; color: var(--primary); border-bottom: 1px solid var(--border-glow); padding-bottom: 10px; font-size: 18px; text-shadow: 0 0 5px var(--primary); }
        h3 { font-size:16px; margin-top:15px; margin-bottom: 10px; color:#fff; border-top: 1px solid var(--border-glow); padding-top: 15px; }

        label { display: block; margin-top: 15px; font-weight: bold; color: #aaa; }
        input[type="text"], input[type="number"], textarea.bulk-input, select { 
            width: 100%; 
            padding: 8px; 
            margin-top: 5px; 
            background: #0a0a1a; 
            border: 1px solid #555; 
            color: #fff; 
            border-radius: 4px; 
            box-sizing: border-box; 
            transition: all 0.3s ease;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px var(--shadow-glow-hard);
        }
        input[type="range"] {
            width: 100%;
            margin-top: 8px;
            margin-bottom: 12px;
        }

        .char-previews { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 5px; min-height: 54px; max-height: 150px; overflow-y: auto; }
        .preview-item { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 4px; }
        .preview-item img { width: 40px; height: 40px; object-fit: cover; border: 2px solid var(--primary); border-radius: 5px; flex-shrink: 0; }
        .status-text { font-size: 12px; color: #aaa; }
        .status-text.ok { color: var(--success); }
        .status-text.error { color: #ff5555; }

        textarea.bulk-input { flex-grow: 1; min-height: 350px; resize: vertical; }
        .help-text { font-size: 12px; color: #888; margin-top: 5px; line-height: 1.4; }
        .warn-text { color: #ffab00; font-weight: bold; }

        #previewContainer { width: 100%; aspect-ratio: 16/9; border: 2px solid var(--primary); position: relative; background: #000; overflow: hidden; margin-bottom: 15px; box-shadow: 0 0 20px var(--shadow-glow-hard); border-radius: 5px;}
        #previewCanvas { width: 100%; height: 100%; display: block; }

        .btn-main { background: linear-gradient(45deg, var(--primary), #0088ff); color: #fff; border: none; padding: 15px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 10px; text-transform: uppercase; transition: 0.3s; text-shadow: 0 0 5px #fff;}
        .btn-main:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 0 20px var(--shadow-glow-hard); }
        .btn-main:disabled { filter: grayscale(0.7); cursor: wait; }
        
        #generation-status { color: var(--success); text-align: center; margin-top: 15px; font-weight: bold; display: none; }

        #copySection { display: none; margin-top: 20px; background: #111; padding: 15px; border-radius: 5px; text-align: center; }
        .btn-copy { background: #444; color: white; border: 2px solid #666; padding: 12px 30px; font-size: 16px; cursor: pointer; border-radius: 50px; display: inline-flex; align-items: center; gap: 10px; transition: all 0.3s ease; }
        .btn-copy:hover { box-shadow: 0 0 15px var(--primary);}
        .btn-copy.success { background: var(--success); color: #000; border-color: var(--success); box-shadow: 0 0 15px var(--success);}
        .hidden-code { position: absolute; left: -9999px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 data-key="title">–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞</h1>
        <div class="lang-switch">
            <button onclick="setLang('ru')" id="btn-ru" class="active">RU</button>
            <button onclick="setLang('en')" id="btn-en">EN</button>
        </div>
    </header>

    <div class="main-grid">
        <!-- –°–¢–†–û–ö–ê 1: –í–∏–∑—É–∞–ª –∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="card">
            <h2 data-key="sec_visual">üëÅÔ∏è –í–∏–∑—É–∞–ª</h2>
            <div id="previewContainer"><canvas id="previewCanvas"></canvas></div>
            <label data-key="lbl_size">–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞/—Å—É—â–µ—Å—Ç–≤–∞:</label>
            <input type="range" id="sizeRange" min="0.5" max="2.0" step="0.1" value="1.0">
            <label data-key="lbl_obj_size">–†–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–æ–≤:</label>
            <input type="range" id="objSizeRange" min="0.5" max="2.0" step="0.1" value="1.0">
            <label data-key="lbl_speed">–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–ª–µ—Ç–∞:</label>
            <input type="range" id="speedRange" min="1" max="10" value="3">
            
            <h3>–ê–≤–∞—Ç–∞—Ä—ã –∏ –°—É—â–µ—Å—Ç–≤–∞</h3>
            <label data-key="lbl_avatars">–ê–≤–∞—Ç–∞—Ä—ã (–¥–æ 6 —à—Ç.):</label>
            <input type="file" id="fAvatars" accept="image/*" multiple onchange="loadMultipleAssets('avatars', 'avatar-previews')">
            <div id="avatar-previews" class="char-previews"></div>
            
            <label data-key="lbl_creatures">–°—É—â–µ—Å—Ç–≤–∞ (–¥–æ 6 —à—Ç.):</label>
            <input type="file" id="fCreatures" accept="image/*" multiple onchange="loadMultipleAssets('creatures', 'creature-previews')">
            <div id="creature-previews" class="char-previews"></div>
        </div>

        <div class="card">
             <h2 data-key="sec_settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –†–µ—Å—É—Ä—Å—ã</h2>
             <label data-key="lbl_gameTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
             <input type="text" id="txtTitle" value="–ü–û–õ–ï–¢ –ê–í–ê–¢–ê–†–ê">
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div><label data-key="lbl_btnStart">–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç:</label><input type="text" id="txtStart" value="–ò–ì–†–ê–¢–¨"></div>
                <div><label data-key="lbl_time">–í—Ä–µ–º—è (—Å):</label><input type="number" id="valTime" value="60"></div>
                <div><label data-key="lbl_win">–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã:</label><input type="text" id="txtWin" value="–¢–´ –ü–û–ë–ï–î–ò–õ!"></div>
                <div><label data-key="lbl_lose">–¢–µ–∫—Å—Ç –ø–æ—Ä–∞–∂–µ–Ω–∏—è:</label><input type="text" id="txtLose" value="–í–†–ï–ú–Ø –í–´–®–õ–û"></div>
             </div>
             
             <label data-key="lbl_level_style">–°—Ç–∏–ª—å —É—Ä–æ–≤–Ω—è:</label>
             <select id="levelStyle">
                <option value="balanced" data-key="opt_balanced">–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π</option>
                <option value="sparse" data-key="opt_sparse">–†–µ–¥–∫–∏–µ (–¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤)</option>
                <option value="dense" data-key="opt_dense">–ü–ª–æ—Ç–Ω—ã–µ (–∞—Å—Ç–µ—Ä–æ–∏–¥–Ω—ã–π –¥–æ–∂–¥—å)</option>
             </select>

             <label data-key="lbl_bg">–§–æ–Ω:</label>
             <input type="file" id="fBg" accept="image/*" onchange="loadSingleAsset('bg')">
             <label data-key="lbl_obs">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ:</label>
             <input type="file" id="fObs" accept="image/*" onchange="loadSingleAsset('obs')">
             <label data-key="lbl_coin">–ú–æ–Ω–µ—Ç–∞ (–¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤):</label>
             <input type="file" id="fCoin" accept="image/*" onchange="loadSingleAsset('coin')">
             <label data-key="lbl_music">–ú—É–∑—ã–∫–∞:</label>
             <input type="file" id="fMusic" accept="audio/*" onchange="loadSingleAsset('music', false)">
             
             <h3 data-key="sec_compress">üñºÔ∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3>
             <label data-key="lbl_max_dim">–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä (px):</label>
             <input type="number" id="maxDim" value="1024">
             <label data-key="lbl_quality">–ö–∞—á–µ—Å—Ç–≤–æ JPEG (0.1-1.0):</label>
             <input type="range" id="jpegQuality" min="0.1" max="1.0" step="0.1" value="0.7">
             <p class="help-text" data-key="help_compress">–í—Å–µ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∂–∞—Ç—ã.</p>
        </div>

        <!-- –°–¢–†–û–ö–ê 2: –í–æ–ø—Ä–æ—Å—ã (—Ç–µ–ø–µ—Ä—å –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É) -->
        <div class="card grid-col-span-2" style="display:flex; flex-direction:column;">
            <h2 data-key="sec_questions">‚ùì –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤</h2>
            <textarea id="bulkQuestions" class="bulk-input" placeholder="..."></textarea>
            <div class="help-text" data-key="help_q">–§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π 1...</div>
        </div>
        
        <!-- –°–¢–†–û–ö–ê 3: –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
        <div class="grid-col-span-2">
             <button id="generateBtn" class="btn-main" onclick="generate()" data-key="btn_gen">üöÄ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
             <div id="generation-status" data-key="gen_status_ok">‚úÖ –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</div>
             <div id="copySection">
                <textarea id="finalCode" class="hidden-code"></textarea>
                <button class="btn-copy" id="copyBtn" onclick="doCopy()">
                    <span id="copyIcon">üìã</span> <span id="copyText" data-key="btn_copy">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</span>
                </button>
                <p class="help-text" data-key="lbl_copy_hint">–í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ Genially (Insert -> Others).</p>
            </div>
        </div>
    </div>
</div>

<script>
    const assets = { bg: null, obs: null, coin: null, music: null, avatars: [], creatures: [] };
    let currentLang = 'ru';
    let isProcessing = false;
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –†–∞–º–∫–∞ –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ –∫–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Base64, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∑–∞–¥–µ—Ä–∂–µ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.
    let frameImgBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPAAAADwCAYAAAA+VLovAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAjLSURBVHhe7d2/bxzHdeDx/zVj46zVWrJWgGjRIVcHiRwgK1AlURxKFCgSpGjhpUuQKB4KDlS4FygQBAUqLhzSFSmSIlGgiJIhRQLFTdEigYwF6iBJkiqJtffYnt/P/jS/mR2ZWWfnY+/tY+3b/SSPM/t5b2Z/ZnY+vN40TUMURVGUwnm+w/y6Pzz5wQ+P3t/3n+9fRVEUxTAzRVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVE-R7uN3R/b97AAAAAElFTkSuQmCC';

    const pImg = { 
        bg: new Image(), 
        obs: new Image(), 
        coin: new Image(),
        avatars: [],
        creatures: [] 
    };

    const dict = {
        ru: {
            title: "–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞: –ú–∞—Å—Ç–µ—Ä", sec_visual: "üëÅÔ∏è –í–∏–∑—É–∞–ª",
            lbl_bg: "–§–æ–Ω:", lbl_size: "–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞/—Å—É—â–µ—Å—Ç–≤–∞:", lbl_obj_size: "–†–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–æ–≤:", lbl_speed: "–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–ª–µ—Ç–∞:",
            sec_settings: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –†–µ—Å—É—Ä—Å—ã", lbl_gameTitle: "–ó–∞–≥–æ–ª–æ–≤–æ–∫:", lbl_btnStart: "–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç:",
            lbl_win: "–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã:", lbl_lose: "–¢–µ–∫—Å—Ç –ø–æ—Ä–∞–∂–µ–Ω–∏—è:", lbl_time: "–í—Ä–µ–º—è (—Å):",
            lbl_obs: "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ:", lbl_coin: "–ú–æ–Ω–µ—Ç–∞ (–¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤):", lbl_music: "–ú—É–∑—ã–∫–∞:",
            sec_questions: "‚ùì –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤", lbl_avatars: "–ê–≤–∞—Ç–∞—Ä—ã (–¥–æ 6 —à—Ç.):", lbl_creatures: "–°—É—â–µ—Å—Ç–≤–∞ (–¥–æ 6 —à—Ç.):",
            help_q: "–§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π 1 | –ù–µ–≤–µ—Ä–Ω—ã–π 2",
            btn_gen: "üöÄ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£", btn_copy: "–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î", btn_copied: "–°–ö–û–ü–ò–†–û–í–ê–ù–û!",
            lbl_copy_hint: "–í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ Genially (Insert -> Others) –∏ —Ä–∞—Å—Ç—è–Ω–∏—Ç–µ –Ω–∞ –≤–µ—Å—å —Å–ª–∞–π–¥.",
            ph_bulk: "–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2+2? | 4 | 5 | 6\n–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏? | –ü–∞—Ä–∏–∂ | –õ–æ–Ω–¥–æ–Ω | –ë–µ—Ä–ª–∏–Ω",
            val_title: "–ü–û–õ–ï–¢ –ê–í–ê–¢–ê–†–ê", val_start: "–ò–ì–†–ê–¢–¨", val_win: "–ü–û–ë–ï–î–ê!", val_lose: "–í–†–ï–ú–Ø –í–´–®–õ–û",
            game_avatar: "–ê–í–ê–¢–ê–†", game_creature: "–°–£–©–ï–°–¢–í–û",
            status_avatar_loaded: "–ê–≤–∞—Ç–∞—Ä", status_creature_loaded: "–°—É—â–µ—Å—Ç–≤–æ",
            status_loaded: "–∑–∞–≥—Ä—É–∂–µ–Ω", status_compressing: "–°–∂–∞—Ç–∏–µ...", status_error: "–û—à–∏–±–∫–∞!",
            gen_status_ok: "‚úÖ –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!", err_max_files: "–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ 6 —Ñ–∞–π–ª–æ–≤.",
            sec_compress: "üñºÔ∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π", lbl_max_dim: "–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä (px):",
            lbl_quality: "–ö–∞—á–µ—Å—Ç–≤–æ JPEG (0.1-1.0):", help_compress: "–í—Å–µ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∂–∞—Ç—ã.",
            lbl_level_style: "–°—Ç–∏–ª—å —É—Ä–æ–≤–Ω—è:", opt_balanced: "–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π",
            opt_sparse: "–†–µ–¥–∫–∏–µ (–¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤)", opt_dense: "–ü–ª–æ—Ç–Ω—ã–µ (–∞—Å—Ç–µ—Ä–æ–∏–¥–Ω—ã–π –¥–æ–∂–¥—å)"
        },
        en: {
            title: "Avatar Flight: Master", sec_visual: "üëÅÔ∏è Visuals",
            lbl_bg: "Background:", lbl_size: "Avatar/Creature Size:", lbl_obj_size: "Objects Size:", lbl_speed: "Flight Speed:",
            sec_settings: "‚öôÔ∏è Settings & Resources", lbl_gameTitle: "Title:", lbl_btnStart: "Start Button:",
            lbl_win: "Win Text:", lbl_lose: "Lose Text:", lbl_time: "Time (s):",
            lbl_obs: "Obstacle:", lbl_coin: "Coin (for questions):", lbl_music: "Music:",
            sec_questions: "‚ùì Questions List", lbl_avatars: "Avatars (up to 6):", lbl_creatures: "Creatures (up to 6):",
            help_q: "Format: Question | Correct | Wrong 1 | Wrong 2",
            btn_gen: "üöÄ CREATE GAME", btn_copy: "COPY CODE", btn_copied: "COPIED!",
            lbl_copy_hint: "Paste into Genially (Insert -> Others) and stretch full screen.",
            ph_bulk: "2+2? | 4 | 5 | 6\nCapital of France? | Paris | London",
            val_title: "AVATAR FLIGHT", val_start: "PLAY", val_win: "YOU WON!", val_lose: "GAME OVER",
            game_avatar: "AVATAR", game_creature: "CREATURE",
            status_avatar_loaded: "Avatar", status_creature_loaded: "Creature",
            status_loaded: "loaded", status_compressing: "Compressing...", status_error: "Error!",
            gen_status_ok: "‚úÖ Game created successfully!", err_max_files: "You can upload a maximum of 6 files.",
            sec_compress: "üñºÔ∏è Image Optimization", lbl_max_dim: "Max Dimension (px):",
            lbl_quality: "JPEG Quality (0.1-1.0):", help_compress: "All uploaded images will be compressed automatically.",
            lbl_level_style: "Level Style:", opt_balanced: "Balanced",
            opt_sparse: "Sparse (for beginners)", opt_dense: "Dense (asteroid rain)"
        }
    };
    
    function setLang(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.dataset.key;
            if (dict[lang][key]) {
                 if (el.tagName === 'OPTION') {
                    el.textContent = dict[lang][key];
                } else {
                    el.innerText = dict[lang][key];
                }
            }
        });
        document.getElementById('btn-ru').className = lang === 'ru' ? 'active' : '';
        document.getElementById('btn-en').className = lang === 'en' ? 'active' : '';
        const d = dict[lang];
        document.getElementById('txtTitle').value = d.val_title;
        document.getElementById('txtStart').value = d.val_start;
        document.getElementById('txtWin').value = d.val_win;
        document.getElementById('txtLose').value = d.val_lose;
        document.getElementById('bulkQuestions').placeholder = d.ph_bulk;
        const btn = document.getElementById('copyBtn');
        btn.className = 'btn-copy';
        document.getElementById('copyText').innerText = d.btn_copy;
    }

    function toggleGenerateButton(enabled) {
        const btn = document.getElementById('generateBtn');
        isProcessing = !enabled;
        btn.disabled = isProcessing;
        btn.style.cursor = isProcessing ? 'wait' : 'pointer';
    }

    function compressImage(file, settings) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let { width, height } = img;
                    const { maxDim, quality } = settings;
                    if (width > height) {
                        if (width > maxDim) { height *= maxDim / width; width = maxDim; }
                    } else {
                        if (height > maxDim) { width *= maxDim / height; height = maxDim; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = file.type === 'image/jpeg' ? canvas.toDataURL('image/jpeg', quality) : canvas.toDataURL('image/png');
                    resolve(dataUrl);
                };
                img.onerror = reject;
            };
            reader.onerror = reject;
        });
    }

    async function loadSingleAsset(key, isImg = true) {
        const input = document.getElementById('f' + key.charAt(0).toUpperCase() + key.slice(1));
        if (!input.files || !input.files[0]) return;
        
        toggleGenerateButton(false);
        try {
            if (isImg) {
                const file = input.files[0];
                const settings = {
                    maxDim: parseInt(document.getElementById('maxDim').value) || 1024,
                    quality: parseFloat(document.getElementById('jpegQuality').value) || 0.7
                };
                const compressedDataUrl = await compressImage(file, settings);
                assets[key] = compressedDataUrl;
                pImg[key].src = compressedDataUrl;
            } else {
                await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => { assets[key] = e.target.result; resolve(); };
                    reader.onerror = reject;
                    reader.readAsDataURL(input.files[0]);
                });
            }
        } catch (error) {
            console.error("Error processing file:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞.");
        }
        toggleGenerateButton(true);
    }
    
    async function loadMultipleAssets(key, previewId) {
        const input = document.getElementById('f' + key.charAt(0).toUpperCase() + key.slice(1));
        const previewContainer = document.getElementById(previewId);
        const MAX_FILES = 6;

        if (assets[key].length >= MAX_FILES) { alert(dict[currentLang].err_max_files); return; }

        const filesToLoad = Array.from(input.files).slice(0, MAX_FILES - assets[key].length);
        if(filesToLoad.length === 0) return;
        
        toggleGenerateButton(false);
        const settings = {
            maxDim: parseInt(document.getElementById('maxDim').value) || 1024,
            quality: parseFloat(document.getElementById('jpegQuality').value) || 0.7
        };

        for (const file of filesToLoad) {
            const currentAssetIndex = assets[key].length;
            assets[key].push(null); pImg[key].push(null);

            const itemDiv = document.createElement('div'); itemDiv.className = 'preview-item';
            const img = document.createElement('img');
            const statusSpan = document.createElement('span'); statusSpan.className = 'status-text';
            statusSpan.innerText = dict[currentLang].status_compressing;
            itemDiv.append(img, statusSpan);
            previewContainer.appendChild(itemDiv);
            
            try {
                const compressedDataUrl = await compressImage(file, settings);
                assets[key][currentAssetIndex] = compressedDataUrl;
                const pImage = new Image();
                pImage.src = compressedDataUrl;
                pImg[key][currentAssetIndex] = pImage;
                img.src = compressedDataUrl;
                const typeText = key === 'avatars' ? dict[currentLang].status_avatar_loaded : dict[currentLang].status_creature_loaded;
                statusSpan.innerText = `‚úÖ ${typeText} ${currentAssetIndex + 1} ${dict[currentLang].status_loaded}`;
                statusSpan.classList.add('ok');
            } catch (error) {
                console.error("Error processing file:", error);
                statusSpan.innerText = `‚ùå ${dict[currentLang].status_error}`;
                statusSpan.classList.add('error');
            }
        }
        toggleGenerateButton(true);
    }
    
    const pCanvas = document.getElementById('previewCanvas');
    const pCtx = pCanvas.getContext('2d');
    let pObjs = [], pBgY = 0, pFrame = 0, pMx = 0, pMy = 0, pAutoMoveDir = 1;

    function initPreview() {
        if(!pCanvas.parentElement) return;
        pCanvas.width = pCanvas.parentElement.offsetWidth;
        pCanvas.height = pCanvas.parentElement.offsetHeight;
        pMx = pCanvas.width / 2;
        pMy = pCanvas.height * 0.8;
        if (pFrame === 0) previewLoop();
    }

    function previewLoop() {
        if(!pCanvas.parentElement) { pFrame = 0; return; }
        requestAnimationFrame(previewLoop);

        let W = pCanvas.width, H = pCanvas.height;
        pCtx.clearRect(0, 0, W, H);
        const speed = parseInt(document.getElementById('speedRange').value);
        const scaleUser = parseFloat(document.getElementById('sizeRange').value);
        const objScale = parseFloat(document.getElementById('objSizeRange').value);
        const forwardSpeed = (speed) * (1.5 - (pMy / H));
        
        pBgY += forwardSpeed * 0.5;
        if(pImg.bg.src && pImg.bg.complete) {
            let ptrn = pCtx.createPattern(pImg.bg, 'repeat');
            if(ptrn) { pCtx.save(); pCtx.translate(0, pBgY % pImg.bg.height); pCtx.fillStyle = ptrn; pCtx.fillRect(0, -pImg.bg.height, W, H + pImg.bg.height*2); pCtx.restore(); }
        } else { pCtx.fillStyle = '#040a18'; pCtx.fillRect(0,0,W,H); }

        if(pFrame % Math.max(10, (90 - speed*4)) === 0) pObjs.push({x: (Math.random()-0.5)*W*1.5, y: (Math.random()-0.5)*H*1.5, z: 2000, t: Math.random() > 0.5 ? 'c' : 'o'});
        
        pObjs.sort((a,b)=>b.z-a.z);
        let pX = (W/2 - pMx) * 0.3;
        let pY = (H*0.75 - pMy) * 0.3;

        for(let i=pObjs.length-1; i>=0; i--) {
            let o = pObjs[i]; o.z -= forwardSpeed;
            if(o.z < 10) { pObjs.splice(i,1); continue; }
            let scale = 300 / o.z; 
            let sx = W/2 + (o.x + pX) * scale;
            let sy = H/2 + (o.y + pY) * scale;
            let size = 80 * scale * objScale, img = (o.t==='c')?pImg.coin:pImg.obs;
            if(img.src && img.complete) pCtx.drawImage(img, sx-size/2, sy-size/2, size, size);
        }
        
        pMx += pAutoMoveDir * 1.5;
        if(pMx > W * 0.9 || pMx < W * 0.1) pAutoMoveDir *= -1;

        let depthScale = 0.7 + (pMy / H) * 0.6;
        let pSize = 80 * scaleUser * depthScale;
        let creatureImg = pImg.creatures.length > 0 ? pImg.creatures[0] : null;
        let avatarImg = pImg.avatars.length > 0 ? pImg.avatars[0] : null;

        pCtx.save(); pCtx.translate(pMx, pMy);
        if(creatureImg && creatureImg.complete) pCtx.drawImage(creatureImg, -pSize/2, -pSize/2, pSize, pSize);
        if(avatarImg && avatarImg.complete) {
             const avatarSize = pSize * 0.5;
             pCtx.drawImage(avatarImg, -avatarSize/2, -pSize*0.4, avatarSize, avatarSize);
        }
        pCtx.restore();
        pFrame++; 
    }
    
    initPreview();
    new ResizeObserver(() => initPreview()).observe(pCanvas.parentElement);
    
    function parseQuestions() {
        return document.getElementById('bulkQuestions').value.trim().split('\n').filter(l => l.trim() !== '').map((l, i) => {
            const p = l.split('|').map(s => s.trim());
            return p.length > 2 ? {t:p[0],type:'choice',c:p[1],w:p.slice(2),id:i} : {t:p[0],type:'input',c:p[1],id:i};
        });
    }

    function generate() {
        const questions = parseQuestions();
        const langData = { lang: currentLang, dict: dict[currentLang] };
        const CONFIG = {
            title: document.getElementById('txtTitle').value, btn: document.getElementById('txtStart').value,
            win: document.getElementById('txtWin').value, lose: document.getElementById('txtLose').value,
            time: document.getElementById('valTime').value, speed: document.getElementById('speedRange').value,
            scale: document.getElementById('sizeRange').value, objScale: document.getElementById('objSizeRange').value,
            levelStyle: document.getElementById('levelStyle').value,
            frame_img: frameImgBase64,
            qs: questions, img: assets, lang: langData
        };

        const configJson = JSON.stringify(CONFIG);

        const CODE = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>@keyframes pulse-title{0%,100%{transform:scale(1);text-shadow:0 0 5px #fff,0 0 10px #fff,0 0 20px #00d2ff,0 0 35px #00d2ff}50%{transform:scale(1.05);text-shadow:0 0 8px #fff,0 0 18px #fff,0 0 35px #00d2ff,0 0 60px #00d2ff}}html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#040a18;color:#e0e0ff;font-family:'Segoe UI',sans-serif;user-select:none}#game-box{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;touch-action:none;background:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Cdefs%3E%3CradialGradient id="grad" cx="50%25" cy="50%25" r="50%25"%3E%3Cstop offset="0%25" stop-color="%23fff" stop-opacity="0.1" /%3E%3Cstop offset="100%25" stop-color="%23fff" stop-opacity="0" /%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx="20" cy="30" r="1.5" fill="url(%23grad)"/%3E%3Ccircle cx="80" cy="70" r="1" fill="url(%23grad)"/%3E%3Ccircle cx="50" cy="90" r="0.5" fill="url(%23grad)"/%3E%3Ccircle cx="90" cy="10" r="1.2" fill="url(%23grad)"/%3E%3C/svg%3E')}canvas{display:block;width:100%;height:100%;pointer-events:none;position:absolute;top:0;left:0;z-index:1}.hud{position:absolute;top:10px;color:#00d2ff;font-size:clamp(20px,4vw,30px);font-weight:700;text-shadow:0 0 5px #00d2ff, 2px 2px 0 #000;padding:5px 15px;background:rgba(0,0,0,.6);border-radius:10px;border:1px solid #00d2ff;z-index:50}.screen{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(4,10,24,.7);backdrop-filter:blur(5px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;pointer-events:auto;transition:opacity .5s}.screen.hidden{opacity:0;pointer-events:none}#mt-title{color:#fff;font-size:clamp(30px,6vw,60px);text-transform:uppercase;text-shadow:0 0 5px #fff,0 0 10px #fff,0 0 20px #00d2ff,0 0 35px #00d2ff;margin:20px;text-align:center;transition:all .3s ease;position:relative;animation:pulse-title 4s infinite ease-in-out}button.btn-play{background:linear-gradient(180deg,#00d2ff,#0088aa);border:4px solid #fff;padding:15px 60px;color:#fff;font-size:clamp(24px,5vw,40px);font-weight:700;text-transform:uppercase;border-radius:60px;cursor:pointer;box-shadow:0 0 15px #00d2ff,0 0 30px #00d2ff;transition:all .2s;text-shadow:1px 1px 2px #000;z-index:200}button.btn-play:hover:not(:disabled){transform:scale(1.05);box-shadow:0 0 25px #00d2ff,0 0 50px #00d2ff}button.btn-play:active:not(:disabled){transform:scale(.95)}button.btn-play:disabled{cursor:not-allowed;filter:grayscale(.8);opacity:.5}#quiz-box{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;background:rgba(4,10,24,.95);border:2px solid #00d2ff;padding:20px;border-radius:15px;text-align:center;z-index:200;pointer-events:auto;box-shadow:0 0 20px #000;backdrop-filter:blur(5px)}.q-btn{display:block;width:100%;padding:15px;margin:8px 0;background:#1a1a2d;border:1px solid #00a2ff80;color:#fff;font-size:18px;cursor:pointer;transition:all .2s}.q-btn:hover{background:#00d2ff;color:#000;box-shadow:0 0 10px #00d2ff}input.q-inp{width:80%;padding:10px;font-size:20px;text-align:center;margin-bottom:10px;color:#000}#char-select-screen{justify-content:center;padding-bottom:0}#char-select-screen h1{margin-bottom:50px}.selection-container{display:flex;justify-content:center;gap:5vw;width:100%;align-items:flex-start;margin-bottom:50px}.selection-group{display:flex;flex-direction:column;align-items:center;gap:15px;perspective:1000px}.selection-box{width:clamp(120px,25vw,250px);height:clamp(120px,25vw,250px);border:none;background-image:url('${CONFIG.frame_img}');background-size:contain;background-position:center;background-repeat:no-repeat;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer}.selection-box::before{content:attr(data-label);position:absolute;top:-40px;color:#fff;text-transform:uppercase;font-weight:700;font-size:clamp(16px,3vw,24px);text-shadow:0 0 5px #fff,0 0 10px #00d2ff}.selection-box img{max-width:70%;max-height:70%;object-fit:contain;transition:transform .5s cubic-bezier(.25,1,.5,1);animation:breath 4s infinite ease-in-out;transform-style:preserve-3d}.selection-box img.animate-3d{transform:scale(1.2) rotateY(360deg)!important}@keyframes breath{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}.choice-row{display:flex;gap:10px;justify-content:center;max-width:clamp(120px,25vw,250px);padding:5px;box-sizing:border-box;overflow-x:auto;background:rgba(0,0,0,.5);border-radius:10px;min-height:66px}.choice-thumb{width:50px;height:50px;object-fit:cover;border:3px solid #555;border-radius:5px;cursor:pointer;transition:all .2s;flex-shrink:0}.choice-thumb:hover{transform:scale(1.1);border-color:#fff}.choice-thumb.active{border-color:#00d2ff;box-shadow:0 0 10px #00d2ff}</style></head><body><div id="game-box"><div class="hud" style="left:10px;display:none;z-index:50">‚è± <span id="ui-time">0</span></div><div class="hud" style="right:10px;display:none;z-index:50">üèÜ <span id="ui-score">0</span></div><canvas id="cvs"></canvas><div id="char-select-screen" class="screen"><h1 id="mt-title"></h1><div class="selection-container"><div class="selection-group"><div class="selection-box" id="avatar-box"><img id="avatar-display"></div><div id="avatar-choices" class="choice-row"></div></div><div class="selection-group"><div class="selection-box" id="creature-box"><img id="creature-display"></div><div id="creature-choices" class="choice-row"></div></div></div><button id="btn-play-game" class="btn-play" disabled></button></div><div id="scr-end" class="screen hidden"><h1 id="mt-end"></h1><p style="font-size:30px">Score: <span id="end-score">0</span></p><button id="btn-restart" class="btn-play">‚Ü∫</button></div><div id="quiz-box"><h2 id="q-txt"></h2><div id="q-body"></div></div></div><script>
const CFG=${configJson};
const IMG=CFG.img,LANG=CFG.lang.dict;document.getElementById('mt-title').innerText=CFG.title;document.getElementById('btn-play-game').innerText=CFG.btn;document.getElementById('avatar-box').dataset.label=LANG.game_avatar;document.getElementById('creature-box').dataset.label=LANG.game_creature;const cvs=document.getElementById('cvs'),ctx=cvs.getContext('2d');let W,H;function resize(){W=cvs.width=window.innerWidth;H=cvs.height=window.innerHeight;if(!GM.run)GM.mx=W/2,GM.my=H*.8}
window.addEventListener('resize',resize);setTimeout(resize,100);const AC=new(window.AudioContext||window.webkitAudioContext);function sfx(type){if(!AC||AC.state==='suspended')AC.resume();const t=AC.currentTime,o=AC.createOscillator(),g=AC.createGain();o.connect(g),g.connect(AC.destination);if(type==='coin'){o.type='sine';o.frequency.setValueAtTime(1200,t);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.5)}else if(type==='boom'){o.type='sawtooth';o.frequency.setValueAtTime(120,t);o.frequency.exponentialRampToValueAtTime(20,t+.4);g.gain.setValueAtTime(.2,t);g.gain.linearRampToValueAtTime(0,t+.4)}else if(type==='win'){o.type='triangle';const notes=[659,783,987];notes.forEach((n,i)=>{o.frequency.setValueAtTime(n,t+i*.1)});g.gain.setValueAtTime(.1,t);g.gain.linearRampToValueAtTime(0,t+.4)}else if(type==='lose'){o.type='square';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(50,t+.4);g.gain.setValueAtTime(.15,t);g.gain.linearRampToValueAtTime(0,t+.4)}o.start(t),o.stop(t+.6)}
const iBg=new Image(),iObs=new Image(),iCoin=new Image(),iAvatar=new Image(),iCreature=new Image();if(IMG.bg)iBg.src=IMG.bg;if(IMG.obs)iObs.src=IMG.obs;if(IMG.coin)iCoin.src=IMG.coin;let music=null;if(IMG.music){music=new Audio(IMG.music);music.loop=true;music.volume=.4}
let selectedAvatar=null,selectedCreature=null;function setupChoices(){const avChoices=document.getElementById('avatar-choices'),crChoices=document.getElementById('creature-choices'),playBtn=document.getElementById('btn-play-game');function checkSelection(){if(selectedAvatar&&selectedCreature)playBtn.disabled=false}
IMG.avatars.forEach(src=>{const i=new Image();i.src=src,i.className='choice-thumb',i.onclick=()=>{selectedAvatar=src;document.getElementById('avatar-display').src=src;avChoices.querySelectorAll('img').forEach(c=>c.classList.remove('active'));i.classList.add('active');checkSelection()},avChoices.appendChild(i)});IMG.creatures.forEach(src=>{const i=new Image();i.src=src,i.className='choice-thumb',i.onclick=()=>{selectedCreature=src;document.getElementById('creature-display').src=src;crChoices.querySelectorAll('img').forEach(c=>c.classList.remove('active'));i.classList.add('active');checkSelection()},crChoices.appendChild(i)})}
['avatar-box','creature-box'].forEach(id=>{document.getElementById(id).onclick=e=>{const t=e.currentTarget.querySelector('img');if(t.src&&!t.classList.contains("animate-3d")){t.classList.add("animate-3d");setTimeout(()=>t.classList.remove("animate-3d"),1e3)}}});setupChoices();
const waveManager={timer:0,config:{},qIndex:0,wavePool:[],init:function(){const style=CFG.levelStyle;if(style==='sparse'){this.config={minTime:180,maxTime:300};this.wavePool=['single','double']}else if(style==='dense'){this.config={minTime:70,maxTime:120};this.wavePool=['wall','corridor','slalom','double']}else{this.config={minTime:120,maxTime:200};this.wavePool=['single','double','corridor','wall']}
this.timer=0;this.qIndex=0},setNextWaveTimer:function(){this.timer=this.config.minTime+Math.random()*(this.config.maxTime-this.config.minTime)},update:function(){if(GM.pause)return;this.timer--;if(this.timer<=0){const waveType=this.wavePool[Math.floor(Math.random()*this.wavePool.length)];this.spawnWave(waveType);this.setNextWaveTimer()}},spawnWave:function(type){const z=8e3,y=(Math.random()-.5)*H*.8,placeCoin=this.qIndex<CFG.qs.length;const addObj=(t,x,y,z,qid=null)=>{const obj={t,x,y,z};if(qid!==null)obj.qid=qid;GM.objs.push(obj)};if(type==='single'){addObj('o',(Math.random()-.5)*W*1.5,y,z)}else if(type==='double'){const x1=(Math.random()-.5)*W*1.5;addObj('o',x1,y,z);addObj('o',x1+(Math.random()>.5?W*.5:-W*.5),(Math.random()-.5)*H,z+500)}else if(type==='wall'){const gapIndex=Math.floor(Math.random()*5);for(let i=0;i<5;i++){const x=(i-2)*W*.4;if(i===gapIndex){if(placeCoin){addObj('c',x,y,z,this.qIndex);this.qIndex++}}else{addObj('o',x,y,z)}}}else if(type==='corridor'){const pathX=(Math.random()-.5)*W*.5;const width=W*(.4+Math.random()*.3);for(let i=0;i<6;i++){addObj('o',pathX-width,y+i*H/5-H/2,z+i*200);addObj('o',pathX+width,y+i*H/5-H/2,z+i*200)}
if(placeCoin){addObj('c',pathX,y,z-200,this.qIndex);this.qIndex++}}else if(type==='slalom'){const startX=(Math.random()-.5)*W;for(let i=0;i<4;i++){addObj('o',startX+W*.5*(i%2===0?1:-1),y,z+i*800)}
if(placeCoin){addObj('c',startX,y,z+1200,this.qIndex);this.qIndex++}}}};
const GM={run:false,pause:false,frame:0,time:0,score:0,objs:[],mx:0,my:0,bgY:0,hurt:0,timerInt:null,start:()=>{if(!selectedAvatar||!selectedCreature)return;iAvatar.src=selectedAvatar;iCreature.src=selectedCreature;document.getElementById('char-select-screen').classList.add('hidden');document.querySelectorAll('.hud').forEach(h=>h.style.display='block');resize();if(AC.state==='suspended')AC.resume();if(music)music.play().catch(e=>{});waveManager.init();GM.run=true;mainLoop();GM.timerInt=setInterval(()=>{if(GM.run&&!GM.pause){GM.time--;document.getElementById('ui-time').innerText=GM.time;if(GM.time<=0)GM.end(false)}},1e3);document.getElementById('ui-time').innerText=GM.time},end:win=>{if(!GM.run)return;GM.run=false;clearInterval(GM.timerInt);const scr=document.getElementById('scr-end');scr.classList.remove('hidden');document.getElementById('mt-end').innerText=win?CFG.win:CFG.lose;document.getElementById('end-score').innerText=GM.score;if(music)music.pause();sfx(win?'win':'lose')},reset:()=>{const scr=document.getElementById('scr-end');scr.classList.add('hidden');document.getElementById('char-select-screen').classList.remove('hidden');document.querySelectorAll('.hud').forEach(h=>h.style.display='none');GM.time=parseInt(CFG.time);GM.score=0;document.getElementById('ui-time').innerText=GM.time;document.getElementById('ui-score').innerText=GM.score;GM.objs=[];GM.hurt=0;GM.run=false;if(music)music.currentTime=0;preGameLoop()}};
document.getElementById('btn-play-game').addEventListener('click',GM.start);document.getElementById('btn-restart').addEventListener('click',GM.reset);window.addEventListener('mousemove',e=>{if(!GM.pause){GM.mx=e.clientX;GM.my=e.clientY}});window.addEventListener('touchmove',e=>{if(!GM.pause){e.preventDefault();GM.mx=e.touches[0].clientX;GM.my=e.touches[0].clientY}},{passive:false});
function drawBg(){if(iBg.src&&iBg.complete){let ptrn=ctx.createPattern(iBg,'repeat');if(ptrn){ctx.save();ctx.translate(0,GM.bgY%iBg.height);ctx.fillStyle=ptrn;ctx.fillRect(0,-iBg.height,W,H+iBg.height*2);ctx.restore()}}else{ctx.fillStyle='#040a18';ctx.fillRect(0,0,W,H)}}
function mainLoop(){if(!GM.run)return;requestAnimationFrame(mainLoop);ctx.clearRect(0,0,W,H);if(!GM.pause){let speed=parseInt(CFG.speed);let forwardSpeed=speed*(1.5-GM.my/H);GM.frame++;waveManager.update();GM.bgY+=forwardSpeed*.5;let pX=(W/2-GM.mx)*.3,pY=(H*.75-GM.my)*.3;for(let i=GM.objs.length-1;i>=0;i--){let o=GM.objs[i];o.z-=forwardSpeed;if(o.z<10){GM.objs.splice(i,1);continue}if(o.z<200&&o.z>20){let depthScale=.7+GM.my/H*.6,pSize=120*parseFloat(CFG.scale)*depthScale,scale=500/o.z,sx=W/2+(o.x+pX)*scale,sy=H/2+(o.y+pY)*scale,size=100*scale*parseFloat(CFG.objScale||1),dist=Math.hypot(sx-GM.mx,sy-GM.my),hitbox=size*.5+pSize*.4;if(dist<hitbox){let hitObject=GM.objs.splice(i,1)[0];hit(hitObject)}}}if(GM.hurt>0)GM.hurt--}
drawBg();GM.objs.sort((a,b)=>b.z-a.z);let objScaleUser=parseFloat(CFG.objScale||1);let pX=(W/2-GM.mx)*.3,pY=(H*.75-GM.my)*.3;for(let o of GM.objs){let scale=500/o.z,sx=W/2+(o.x+pX)*scale,sy=H/2+(o.y+pY)*scale,size=100*scale*objScaleUser;let img=o.t==='c'?iCoin:iObs;if(img.src&&img.complete)ctx.drawImage(img,sx-size/2,sy-size/2,size,size)}
if(!(GM.hurt>0&&Math.floor(GM.hurt/4)%2===0)){let depthScale=.7+GM.my/H*.6,pSize=120*parseFloat(CFG.scale)*depthScale,tilt=(GM.mx-W/2)*.05,avatarSize=pSize*.5;ctx.save();ctx.translate(GM.mx,GM.my);ctx.rotate(tilt*Math.PI/180);if(iCreature.src&&iCreature.complete)ctx.drawImage(iCreature,-pSize/2,-pSize/2,pSize,pSize);if(iAvatar.src&&iAvatar.complete)ctx.drawImage(iAvatar,-avatarSize/2,-pSize*.4,avatarSize,avatarSize);ctx.restore()}}
function preGameLoop(){if(GM.run)return;requestAnimationFrame(preGameLoop);GM.bgY+=.5;ctx.clearRect(0,0,W,H);drawBg()}
function hit(obj){if(obj.t==='o'){sfx('boom');GM.hurt=30;let f=document.createElement('div');f.style="position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center, rgba(255,0,0,0.5) 0%, rgba(255,0,0,0) 70%);pointer-events:none;z-index:99";document.body.appendChild(f);setTimeout(()=>f.remove(),150);GM.time-=5;if(GM.time<=0)GM.end(false)}else if(obj.t==='c'){sfx('coin');if(CFG.qs.length>0&&obj.qid!==undefined){GM.pause=true;quiz(obj.qid)}}document.getElementById('ui-time').innerText=GM.time;document.getElementById('ui-score').innerText=GM.score}
function quiz(q_idx){let q=CFG.qs[q_idx];if(!q){GM.pause=false;return}let box=document.getElementById('quiz-box'),body=document.getElementById('q-body');document.getElementById('q-txt').innerText=q.t;body.innerHTML='';box.style.display='block';const processAns=txt=>{box.style.display='none';if(txt.trim().toLowerCase()===q.c.trim().toLowerCase()){sfx('win');GM.score++;if(CFG.qs.length>0&&GM.score>=CFG.qs.length){setTimeout(()=>GM.end(true),500)}}else{sfx('lose');GM.time-=10}document.getElementById('ui-score').innerText=GM.score;document.getElementById('ui-time').innerText=GM.time;if(GM.time<=0)GM.end(false);setTimeout(()=>GM.pause=false,200)};if(q.type==='choice'){let arr=[q.c,...q.w].sort(()=>Math.random()-.5);arr.forEach(t=>{let b=document.createElement('button');b.className='q-btn';b.innerText=t;b.onclick=e=>{e.stopPropagation();processAns(t)};body.appendChild(b)})}else{let inp=document.createElement('input');inp.className='q-inp';let b=document.createElement('button');b.className='q-btn';b.innerText='OK';b.onclick=e=>{e.stopPropagation();processAns(inp.value)};body.appendChild(inp);body.appendChild(b);inp.focus()}}
GM.reset();
<\/script></body></html>`;
        
        const statusDiv = document.getElementById('generation-status');
        statusDiv.style.display = 'block';
        setTimeout(() => { statusDiv.style.display = 'none'; }, 4000);
        
        document.getElementById('finalCode').value = CODE;
        document.getElementById('copySection').style.display = 'block';
    }

    function doCopy() {
        document.getElementById('finalCode').select(); document.execCommand('copy');
        const btn = document.getElementById('copyBtn'), span = document.getElementById('copyText'), icon = document.getElementById('copyIcon');
        btn.classList.add('success'); span.innerText = dict[currentLang].btn_copied; icon.innerText = "‚úÖ";
        setTimeout(() => { btn.classList.remove('success'); span.innerText = dict[currentLang].btn_copy; icon.innerText = "üìã"; }, 3000);
    }
    
    setLang('ru');
</script>
</body>
</html>
