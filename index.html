<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genially Game Editor: Flight Edition</title>
    <style>
        :root { --primary: #00d2ff; --bg: #1a1a2d; --panel: #252540; --text: #e0e0ff; --accent: #ff00ff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header & Lang Switch */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 20px; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); text-transform: uppercase; text-shadow: 0 0 10px var(--primary); font-size: 24px; }
        .lang-switch button { background: #333; color: #fff; border: 1px solid #555; padding: 5px 10px; cursor: pointer; }
        .lang-switch button.active { background: var(--primary); color: #000; font-weight: bold; }

        /* Grid Layout */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid #444; position: relative; }
        .full-width { grid-column: 1 / -1; }
        
        h2 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 18px; }
        
        /* Form Inputs */
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 14px; color: #aaa; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 8px; margin-top: 5px; background: #111; border: 1px solid #555; color: #fff; border-radius: 4px; box-sizing: border-box;
        }
        input[type="range"] { width: 100%; margin: 10px 0; }
        input[type="file"] { margin-top: 5px; font-size: 12px; }

        /* Real-time Preview */
        #livePreview { 
            width: 100%; height: 250px; background: #000; border: 2px solid var(--primary); 
            margin-bottom: 15px; position: relative; overflow: hidden; 
            background-size: cover; background-position: center;
        }
        #previewBird {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            width: 80px; height: 80px; 
            background-size: contain; background-repeat: no-repeat; background-position: center;
            border: 1px dashed rgba(255,255,255,0.3);
        }
        .anim-bg { animation: scrollBg linear infinite; }
        @keyframes scrollBg { from { background-position: 0 0; } to { background-position: 0 500px; } }

        /* Questions */
        .q-list { max-height: 300px; overflow-y: auto; }
        .q-item { background: #1e1e30; padding: 10px; margin-bottom: 8px; border-left: 3px solid var(--accent); position: relative; }
        .del-btn { position: absolute; top: 5px; right: 5px; background: #f44; color: #fff; border: none; cursor: pointer; padding: 2px 8px; font-size: 12px; }

        /* Buttons */
        .btn-main { 
            background: linear-gradient(45deg, var(--primary), #0088ff); color: #fff; border: none; 
            padding: 15px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; 
            border-radius: 5px; margin-top: 10px; text-transform: uppercase;
        }
        .btn-small { background: #444; color: #fff; border: none; padding: 8px; cursor: pointer; width: 100%; margin-top: 10px; }
        
        textarea { width: 100%; height: 150px; background: #000; color: #0f0; margin-top: 10px; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 data-key="title">üíé Game Editor</h1>
        <div class="lang-switch">
            <button onclick="setLang('ru')" id="btn-ru" class="active">RU</button>
            <button onclick="setLang('en')" id="btn-en">EN</button>
        </div>
    </header>

    <div class="grid">
        
        <!-- Live Preview & Visuals -->
        <div class="card">
            <h2 data-key="sec_visual">üëÅÔ∏è –í–∏–∑—É–∞–ª –∏ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
            <div id="livePreview">
                <div id="previewBird"></div>
            </div>
            
            <label data-key="lbl_bg">–§–æ–Ω (–ë–µ—Å—à–æ–≤–Ω—ã–π –¥–ª—è –ª—É—á—à–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞):</label>
            <input type="file" id="fBg" accept="image/*" onchange="loadAsset('bg')">
            
            <label data-key="lbl_bird">–ê–≤–∞—Ç–∞—Ä (–ü—Ç–∏—Ü–∞):</label>
            <input type="file" id="fBird" accept="image/*" onchange="loadAsset('bird')">
            
            <label data-key="lbl_size">–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞:</label>
            <input type="range" id="sizeRange" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updatePreview()">
            
            <label data-key="lbl_speed">–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–ª–µ—Ç–∞:</label>
            <input type="range" id="speedRange" min="1" max="20" value="5" oninput="updatePreview()">
        </div>

        <!-- Texts & Settings -->
        <div class="card">
            <h2 data-key="sec_settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¢–µ–∫—Å—Ç</h2>
            
            <label data-key="lbl_gameTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã:</label>
            <input type="text" id="txtTitle" value="–ü–û–õ–ï–¢ –ê–í–ê–¢–ê–†–ê">
            
            <label data-key="lbl_btnStart">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ä—Ç:</label>
            <input type="text" id="txtStart" value="–ò–ì–†–ê–¢–¨">
            
            <label data-key="lbl_win">–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã:</label>
            <input type="text" id="txtWin" value="–¢–´ –ü–û–ë–ï–î–ò–õ!">
            
            <label data-key="lbl_lose">–¢–µ–∫—Å—Ç –ø–æ—Ä–∞–∂–µ–Ω–∏—è:</label>
            <input type="text" id="txtLose" value="–í–†–ï–ú–Ø –í–´–®–õ–û">

            <div style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <label data-key="lbl_time">–í—Ä–µ–º—è (—Å–µ–∫):</label>
                    <input type="number" id="valTime" value="60">
                </div>
            </div>

            <h3 style="font-size:14px; margin-top:15px; color:#fff;" data-key="sec_assets">–î–æ–ø. –ö–∞—Ä—Ç–∏–Ω–∫–∏</h3>
            <label data-key="lbl_obs">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ:</label>
            <input type="file" id="fObs" accept="image/*" onchange="loadAsset('obs')">
            
            <label data-key="lbl_coin">–ú–æ–Ω–µ—Ç–∞ (–í–æ–ø—Ä–æ—Å):</label>
            <input type="file" id="fCoin" accept="image/*" onchange="loadAsset('coin')">
            
            <label data-key="lbl_music">–ú—É–∑—ã–∫–∞ (MP3):</label>
            <input type="file" id="fMusic" accept="audio/*" onchange="loadAsset('music', false)">
        </div>

        <!-- Questions -->
        <div class="card full-width">
            <h2 data-key="sec_questions">‚ùì –í–æ–ø—Ä–æ—Å—ã</h2>
            <div id="qList" class="q-list"></div>
            <button class="btn-small" onclick="addQ()" data-key="btn_addQ">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
        </div>

        <!-- Generate -->
        <div class="card full-width" style="text-align: center;">
            <button class="btn-main" onclick="generate()" data-key="btn_gen">üöÄ –°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
            <div id="outputBlock" style="display:none; text-align: left; margin-top: 15px;">
                <label data-key="lbl_copy">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Genially (Insert -> Others):</label>
                <textarea id="outCode" readonly></textarea>
                <button class="btn-small" onclick="copyCode()" data-key="btn_copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
    // === DATA & LANG ===
    const assets = { bg: null, bird: null, obs: null, coin: null, music: null };
    let currentLang = 'ru';

    const dict = {
        ru: {
            title: "üíé –†–ï–î–ê–ö–¢–û–† –ò–ì–†–´",
            sec_visual: "üëÅÔ∏è –í–∏–∑—É–∞–ª –∏ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä",
            lbl_bg: "–§–æ–Ω (–ë–µ—Å—à–æ–≤–Ω—ã–π):",
            lbl_bird: "–ê–≤–∞—Ç–∞—Ä (–ü—Ç–∏—Ü–∞):",
            lbl_size: "–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞:",
            lbl_speed: "–°–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏:",
            sec_settings: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¢–µ–∫—Å—Ç",
            lbl_gameTitle: "–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã:",
            lbl_btnStart: "–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ä—Ç:",
            lbl_win: "–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã:",
            lbl_lose: "–¢–µ–∫—Å—Ç –ø–æ—Ä–∞–∂–µ–Ω–∏—è:",
            lbl_time: "–í—Ä–µ–º—è (—Å–µ–∫):",
            sec_assets: "–ò–≥—Ä–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã",
            lbl_obs: "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ:",
            lbl_coin: "–ú–æ–Ω–µ—Ç–∞:",
            lbl_music: "–ú—É–∑—ã–∫–∞:",
            sec_questions: "‚ùì –í–æ–ø—Ä–æ—Å—ã",
            btn_addQ: "+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å",
            btn_gen: "üöÄ –°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ –ö–û–î",
            lbl_copy: "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –¥–ª—è Genially:",
            btn_copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
            ph_q: "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞",
            ph_c: "–í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç",
            ph_w1: "–ù–µ–≤–µ—Ä–Ω—ã–π 1",
            ph_w2: "–ù–µ–≤–µ—Ä–Ω—ã–π 2",
            ph_i: "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (—Ç–µ–∫—Å—Ç)",
            val_title: "–ü–û–õ–ï–¢ –ê–í–ê–¢–ê–†–ê",
            val_start: "–ò–ì–†–ê–¢–¨",
            val_win: "–¢–´ –ü–û–ë–ï–î–ò–õ!",
            val_lose: "–¢–´ –ü–†–û–ò–ì–†–ê–õ"
        },
        en: {
            title: "üíé GAME EDITOR",
            sec_visual: "üëÅÔ∏è Visuals & Preview",
            lbl_bg: "Background (Seamless):",
            lbl_bird: "Avatar (Bird):",
            lbl_size: "Avatar Size:",
            lbl_speed: "Animation Speed:",
            sec_settings: "‚öôÔ∏è Settings & Text",
            lbl_gameTitle: "Game Title:",
            lbl_btnStart: "Start Button Text:",
            lbl_win: "Win Message:",
            lbl_lose: "Lose Message:",
            lbl_time: "Time (sec):",
            sec_assets: "Game Objects",
            lbl_obs: "Obstacle:",
            lbl_coin: "Coin:",
            lbl_music: "Music:",
            sec_questions: "‚ùì Questions",
            btn_addQ: "+ Add Question",
            btn_gen: "üöÄ GENERATE CODE",
            lbl_copy: "Copy code for Genially:",
            btn_copy: "Copy to clipboard",
            ph_q: "Question text",
            ph_c: "Correct answer",
            ph_w1: "Wrong 1",
            ph_w2: "Wrong 2",
            ph_i: "Correct answer (text)",
            val_title: "AVATAR FLIGHT",
            val_start: "PLAY",
            val_win: "YOU WON!",
            val_lose: "GAME OVER"
        }
    };

    function setLang(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-key]').forEach(el => {
            if(dict[lang][el.dataset.key]) el.innerText = dict[lang][el.dataset.key];
        });
        document.getElementById('btn-ru').className = lang === 'ru' ? 'active' : '';
        document.getElementById('btn-en').className = lang === 'en' ? 'active' : '';

        // Update default placeholders inputs
        const d = dict[lang];
        document.getElementById('txtTitle').value = d.val_title;
        document.getElementById('txtStart').value = d.val_start;
        document.getElementById('txtWin').value = d.val_win;
        document.getElementById('txtLose').value = d.val_lose;
        
        // Update placeholders in dynamic questions
        updatePlaceholders();
    }

    function updatePlaceholders() {
        const d = dict[currentLang];
        document.querySelectorAll('.ph-q').forEach(el => el.placeholder = d.ph_q);
        document.querySelectorAll('.ph-c').forEach(el => el.placeholder = d.ph_c);
        document.querySelectorAll('.ph-w').forEach(el => el.placeholder = d.ph_w1);
        document.querySelectorAll('.ph-i').forEach(el => el.placeholder = d.ph_i);
    }

    // === PREVIEW LOGIC ===
    function loadAsset(key, isImg=true) {
        const input = document.getElementById(key === 'bg' ? 'fBg' : key === 'bird' ? 'fBird' : key === 'obs' ? 'fObs' : key === 'coin' ? 'fCoin' : 'fMusic');
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                assets[key] = e.target.result;
                updatePreview();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function updatePreview() {
        const pv = document.getElementById('livePreview');
        const bird = document.getElementById('previewBird');
        const size = document.getElementById('sizeRange').value;
        const speed = document.getElementById('speedRange').value;

        if(assets.bg) pv.style.backgroundImage = `url('${assets.bg}')`;
        if(assets.bird) bird.style.backgroundImage = `url('${assets.bird}')`;
        
        // Scale bird
        bird.style.transform = `translate(-50%, -50%) scale(${size})`;
        
        // Animate BG
        pv.style.animationDuration = (11 - speed/2) + 's'; // simple visual mapping
        pv.classList.add('anim-bg');
    }

    // === QUESTIONS ===
    function addQ() {
        const d = dict[currentLang];
        const div = document.createElement('div');
        div.className = 'q-item';
        div.innerHTML = `
            <button class="del-btn" onclick="this.parentElement.remove()">x</button>
            <input type="text" class="q-txt ph-q" placeholder="${d.ph_q}">
            <select class="q-type" onchange="toggleType(this)">
                <option value="choice">Choice</option>
                <option value="input">Input</option>
            </select>
            <div class="opt-choice">
                <input type="text" class="c-ans ph-c" placeholder="${d.ph_c}" style="border-color: #0f0;">
                <input type="text" class="w-ans1 ph-w" placeholder="${d.ph_w1}">
                <input type="text" class="w-ans2 ph-w" placeholder="${d.ph_w2}">
            </div>
            <div class="opt-input" style="display:none">
                <input type="text" class="i-ans ph-i" placeholder="${d.ph_i}">
            </div>
        `;
        document.getElementById('qList').appendChild(div);
    }

    function toggleType(sel) {
        const p = sel.parentElement;
        p.querySelector('.opt-choice').style.display = sel.value === 'choice' ? 'block' : 'none';
        p.querySelector('.opt-input').style.display = sel.value === 'input' ? 'block' : 'none';
    }

    // === GENERATOR ===
    function copyCode() {
        document.getElementById('outCode').select();
        document.execCommand('copy');
        alert("Copied!");
    }

    function generate() {
        const questions = [];
        document.querySelectorAll('.q-item').forEach(el => {
            const type = el.querySelector('.q-type').value;
            const obj = { t: el.querySelector('.q-txt').value, type };
            if(type === 'choice') {
                obj.c = el.querySelector('.c-ans').value;
                obj.w = [el.querySelector('.w-ans1').value, el.querySelector('.w-ans2').value];
            } else {
                obj.c = el.querySelector('.i-ans').value;
            }
            questions.push(obj);
        });

        const CONFIG = {
            title: document.getElementById('txtTitle').value,
            btn: document.getElementById('txtStart').value,
            win: document.getElementById('txtWin').value,
            lose: document.getElementById('txtLose').value,
            time: document.getElementById('valTime').value,
            speed: document.getElementById('speedRange').value,
            scale: document.getElementById('sizeRange').value,
            qs: questions,
            img: assets,
            lang: currentLang
        };

        const CODE = `
<!DOCTYPE html>
<html>
<head>
<style>
    body { margin:0; overflow:hidden; background:#000; font-family:'Segoe UI',sans-serif; user-select:none; -webkit-user-select:none; }
    #game-box { position:relative; width:100vw; height:100vh; overflow:hidden; }
    canvas { display:block; width:100%; height:100%; position:absolute; top:0; left:0; z-index:0; }
    
    /* UI ELEMENTS */
    .ui-layer { position:absolute; width:100%; height:100%; top:0; left:0; pointer-events:none; z-index:10; }
    .hud { position:absolute; top:10px; color:#00d2ff; font-size:24px; font-weight:bold; text-shadow:2px 2px 0 #000; padding:5px 15px; background:rgba(0,0,0,0.6); border-radius:10px; border:1px solid #00d2ff; }
    
    /* MODALS */
    .screen { 
        position:absolute; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.85); display:flex; flex-direction:column; 
        align-items:center; justify-content:center; z-index:20; pointer-events:auto; 
    }
    
    h1 { color:#00d2ff; font-size:48px; text-transform:uppercase; text-shadow:0 0 20px #00d2ff; margin-bottom:10px; text-align:center; }
    
    button.btn-play {
        background: linear-gradient(180deg, #00d2ff, #0088aa);
        border: 3px solid #fff; padding: 15px 50px;
        color: #fff; font-size: 28px; font-weight: bold; text-transform: uppercase;
        border-radius: 50px; cursor: pointer; box-shadow: 0 0 25px #00d2ff;
        transition: transform 0.1s; text-shadow: 1px 1px 2px #000;
        pointer-events: auto;
    }
    button.btn-play:active { transform: scale(0.95); background: #fff; color: #00d2ff; }

    /* QUIZ MODAL */
    #quiz-box { 
        display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); 
        width:90%; max-width:450px; background:#1e293b; border:2px solid #00d2ff; 
        padding:20px; border-radius:15px; text-align:center; color:#fff; z-index:30; pointer-events:auto;
    }
    .q-btn { display:block; width:100%; padding:12px; margin:8px 0; background:#334; border:1px solid #556; color:#fff; font-size:18px; cursor:pointer; }
    .q-btn:hover { background:#00d2ff; color:#000; }
    input.q-inp { width:80%; padding:10px; font-size:18px; text-align:center; margin-bottom:10px; }

</style>
</head>
<body>

<div id="game-box">
    <canvas id="cvs"></canvas>
    
    <div class="ui-layer">
        <div class="hud" style="left:20px">‚è± <span id="ui-time">0</span></div>
        <div class="hud" style="right:20px">üèÜ <span id="ui-score">0</span></div>
    </div>

    <div id="scr-start" class="screen">
        <h1 id="mt-title">TITLE</h1>
        <p style="color:#aaa; margin-bottom:30px">Genially Game</p>
        <button class="btn-play" id="btn-start" onclick="GM.start()">START</button>
    </div>

    <div id="scr-end" class="screen" style="display:none">
        <h1 id="mt-end">END</h1>
        <p style="color:#fff; font-size:24px">Score: <span id="end-score">0</span></p>
        <button class="btn-play" onclick="location.reload()">‚Ü∫</button>
    </div>

    <div id="quiz-box">
        <h3 id="q-txt" style="color:#00d2ff; margin-top:0">Question</h3>
        <div id="q-body"></div>
    </div>
</div>

<script>
const CFG = ${JSON.stringify(CONFIG)};
const IMG = CFG.img;

// Set Texts
document.getElementById('mt-title').innerText = CFG.title;
document.getElementById('btn-start').innerText = CFG.btn;

const cvs = document.getElementById('cvs');
const ctx = cvs.getContext('2d');
let W, H;

// Audio Synth
const AC = new (window.AudioContext || window.webkitAudioContext)();
function sfx(type) {
    if(AC.state === 'suspended') AC.resume();
    const o = AC.createOscillator(); const g = AC.createGain();
    o.connect(g); g.connect(AC.destination);
    const t = AC.currentTime;
    if(type==='win') { 
        o.frequency.setValueAtTime(500, t); o.frequency.linearRampToValueAtTime(1000, t+0.2);
        g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.5);
    } else {
        o.type='sawtooth'; o.frequency.setValueAtTime(200, t); o.frequency.exponentialRampToValueAtTime(50, t+0.3);
        g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.3);
    }
    o.start(t); o.stop(t+0.5);
}

// Assets
const iBg = new Image(); if(IMG.bg) iBg.src = IMG.bg;
const iBird = new Image(); if(IMG.bird) iBird.src = IMG.bird;
const iObs = new Image(); if(IMG.obs) iObs.src = IMG.obs;
const iCoin = new Image(); if(IMG.coin) iCoin.src = IMG.coin;
let music = null; if(IMG.music) { music = new Audio(IMG.music); music.loop=true; music.volume=0.4; }

// Game Logic
const GM = {
    run: false, pause: false, frame: 0,
    time: parseInt(CFG.time), score: 0,
    objs: [],
    mx: 0, my: 0,
    bgY: 0, // For scroll effect
    
    resize: () => {
        W = cvs.width = document.body.clientWidth;
        H = cvs.height = document.body.clientHeight;
        GM.mx = W/2; GM.my = H-100;
    },

    start: () => {
        document.getElementById('scr-start').style.display = 'none';
        GM.resize();
        if(music) music.play().catch(e=>{});
        GM.run = true;
        loop();
        setInterval(() => {
            if(GM.run && !GM.pause) {
                GM.time--;
                document.getElementById('ui-time').innerText = GM.time;
                if(GM.time <= 0) GM.end(false);
            }
        }, 1000);
        document.getElementById('ui-time').innerText = GM.time;
    },

    end: (win) => {
        GM.run = false;
        document.getElementById('scr-end').style.display = 'flex';
        document.getElementById('mt-end').innerText = win ? CFG.win : CFG.lose;
        document.getElementById('mt-end').style.color = win ? '#0f0' : '#f00';
        document.getElementById('end-score').innerText = GM.score;
        sfx(win?'win':'lose');
    }
};

// Controls
window.addEventListener('mousemove', e => {
    const r = cvs.getBoundingClientRect();
    GM.mx = e.clientX - r.left;
    GM.my = e.clientY - r.top;
    if(GM.my < H/2) GM.my = H/2; // Limit height
});
window.addEventListener('resize', GM.resize);

function loop() {
    if(!GM.run) return;
    requestAnimationFrame(loop);
    if(GM.pause) return;

    ctx.clearRect(0,0,W,H);
    
    // 1. Moving Background (Flight Effect)
    // We scroll BG vertically to simulate moving forward over ground
    GM.bgY += parseInt(CFG.speed) * 0.5; 
    if(iBg.src) {
        let sc = Math.max(W/iBg.width, H/iBg.height);
        let bw = iBg.width * sc; let bh = iBg.height * sc;
        
        // Draw twice for seamless loop
        let offY = GM.bgY % bh;
        ctx.drawImage(iBg, (W-bw)/2, offY, bw, bh); 
        ctx.drawImage(iBg, (W-bw)/2, offY - bh, bw, bh);
    } else {
        ctx.fillStyle = '#112'; ctx.fillRect(0,0,W,H);
    }

    // 2. Speed Lines (Starfield effect)
    ctx.fillStyle = "rgba(255,255,255,0.4)";
    for(let i=0; i<4; i++) {
        let x = Math.random()*W;
        let y = Math.random()*H;
        ctx.fillRect(x, y, 2, Math.random()*40);
    }

    // 3. Spawner
    if(GM.frame % (60 - parseInt(CFG.speed)*2) === 0) {
        let isCoin = (CFG.qs.length > 0 && Math.random() > 0.6);
        // Spawn spread out
        GM.objs.push({ x: (Math.random()-0.5)*W*2.5, y: (Math.random()-0.5)*H*2, z: 2000, t: isCoin?'c':'o' });
    }

    // 4. Objects
    GM.objs.sort((a,b) => b.z - a.z);
    for(let i=0; i<GM.objs.length; i++) {
        let o = GM.objs[i];
        o.z -= (10 + parseInt(CFG.speed)*2); // Move closer
        
        if(o.z < 10) { GM.objs.splice(i,1); i--; continue; }

        let scale = 500 / o.z;
        let sx = W/2 + o.x * scale;
        let sy = H/2 + o.y * scale;
        let size = 100 * scale;

        let img = (o.t==='c') ? iCoin : iObs;
        if(img.src) ctx.drawImage(img, sx-size/2, sy-size/2, size, size);
        else {
            ctx.fillStyle = (o.t==='c') ? 'gold' : 'red';
            ctx.fillRect(sx-size/2, sy-size/2, size, size);
        }

        // Collision
        if(o.z < 150 && o.z > 50) {
            let dist = Math.hypot(sx - GM.mx, sy - GM.my);
            // Player Radius approx 40 * scale setting
            if(dist < (size/2) + (30 * parseFloat(CFG.scale))) {
                GM.objs.splice(i,1); i--;
                hit(o.t);
            }
        }
    }

    // 5. Player
    let pSize = 120 * parseFloat(CFG.scale);
    if(iBird.src) {
        // Tilt effect
        let tilt = (GM.mx - W/2) * 0.05;
        ctx.save();
        ctx.translate(GM.mx, GM.my);
        ctx.rotate(tilt * Math.PI/180);
        ctx.drawImage(iBird, -pSize/2, -pSize/2, pSize, pSize);
        ctx.restore();
    } else {
        ctx.fillStyle = '#0ff'; 
        ctx.beginPath(); ctx.arc(GM.mx, GM.my, 20, 0, 7); ctx.fill();
    }

    GM.frame++;
}

function hit(type) {
    if(type === 'o') {
        sfx('lose');
        ctx.fillStyle = 'rgba(255,0,0,0.5)';
        ctx.fillRect(0,0,W,H);
        GM.time -= 5;
    } else {
        sfx('win');
        GM.pause = true;
        quiz();
    }
}

function quiz() {
    if(CFG.qs.length === 0) {
        GM.score++; document.getElementById('ui-score').innerText = GM.score; GM.pause = false; return;
    }
    
    let idx = Math.floor(Math.random()*CFG.qs.length);
    let q = CFG.qs[idx];
    CFG.qs.splice(idx, 1);

    let box = document.getElementById('quiz-box');
    let body = document.getElementById('q-body');
    document.getElementById('q-txt').innerText = q.t;
    body.innerHTML = '';
    box.style.display = 'block';

    const ans = (txt) => {
        box.style.display = 'none';
        if(txt.trim().toLowerCase() === q.c.trim().toLowerCase()) {
            sfx('win'); GM.score++;
        } else {
            sfx('lose'); GM.time -= 10;
        }
        document.getElementById('ui-score').innerText = GM.score;
        if(CFG.qs.length===0) GM.end(true);
        else GM.pause = false;
    };

    if(q.type === 'choice') {
        let arr = [q.c, ...q.w].sort(() => Math.random()-0.5);
        arr.forEach(t => {
            let b = document.createElement('button'); b.className='q-btn'; b.innerText=t;
            b.onclick = () => ans(t);
            body.appendChild(b);
        });
    } else {
        let inp = document.createElement('input'); inp.className='q-inp';
        let b = document.createElement('button'); b.className='q-btn'; b.innerText='OK';
        b.onclick = () => ans(inp.value);
        body.appendChild(inp); body.appendChild(b);
    }
}

<\/script>
</body>
</html>`;
        document.getElementById('outCode').value = CODE;
        document.getElementById('outputBlock').style.display = 'block';
    }

    // Init with defaults
    setLang('ru');
</script>
</body>
</html>
