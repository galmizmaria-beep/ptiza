<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Конструктор образовательной игры ULTRA</title>
<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
.container{display:flex;height:100vh}
.editor{width:40%;padding:15px;overflow:auto;background:#fff;border-right:2px solid #ddd}
.preview{flex:1;background:#000}
h2{margin:10px 0}
input,button{margin:5px 0;padding:6px;width:100%;box-sizing:border-box}
button{cursor:pointer}
.grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:5px}
.thumb{position:relative;border:2px solid #ccc;border-radius:6px;overflow:hidden}
.thumb img{width:100%;height:70px;object-fit:cover}
.thumb span{position:absolute;top:0;right:0;background:red;color:#fff;font-size:12px;padding:2px 5px;cursor:pointer}
iframe{width:100%;height:100%;border:0}
</style>
</head>
<body>

<div class="container">
<div class="editor">

<h2>Фон</h2>
<input type="file" id="bgUpload">

<h2>Задания</h2>
<div id="tasks"></div>
<button onclick="addTask()">Добавить задание</button>

<h2>АВАТАРЫ (до 5)</h2>
<input type="file" id="avatarUpload">
<div id="avatarList" class="grid5"></div>

<h2>СУЩЕСТВА (до 5)</h2>
<input type="file" id="creatureUpload">
<div id="creatureList" class="grid5"></div>

<button onclick="exportGame()">Экспортировать игру</button>

</div>

<div class="preview">
<iframe id="gameFrame"></iframe>
</div>
</div>

<script>
const STATE={background:null,tasks:[],avatars:[],creatures:[]}
const frame=document.getElementById("gameFrame")

function updatePreview(){frame.contentWindow.postMessage({type:"update",state:STATE},"*")}
let t;function autoUpdate(){clearTimeout(t);t=setTimeout(updatePreview,300)}

function addTask(){STATE.tasks.push({q:"",a:""});renderTasks();autoUpdate()}
function renderTasks(){
const box=document.getElementById("tasks");box.innerHTML=""
STATE.tasks.forEach((t,i)=>{
let q=document.createElement("input")
q.placeholder="Вопрос";q.value=t.q
q.oninput=e=>{STATE.tasks[i].q=e.target.value;autoUpdate()}
let a=document.createElement("input")
a.placeholder="Ответ";a.value=t.a
a.oninput=e=>{STATE.tasks[i].a=e.target.value;autoUpdate()}
box.appendChild(q);box.appendChild(a)
})
}
function renderImages(list,container,key){
container.innerHTML=""
list.forEach((src,i)=>{
let div=document.createElement("div")
div.className="thumb"
div.innerHTML='<img src="'+src+'"><span>x</span>'
div.querySelector("span").onclick=()=>{
STATE[key].splice(i,1)
renderImages(STATE[key],container,key)
autoUpdate()
}
container.appendChild(div)
})
}
bgUpload.onchange=e=>{
let r=new FileReader()
r.onload=()=>{STATE.background=r.result;autoUpdate()}
r.readAsDataURL(e.target.files[0])
}
avatarUpload.onchange=e=>{
if(STATE.avatars.length>=5)return
let r=new FileReader()
r.onload=()=>{STATE.avatars.push(r.result);renderImages(STATE.avatars,avatarList,"avatars");autoUpdate()}
r.readAsDataURL(e.target.files[0])
}
creatureUpload.onchange=e=>{
if(STATE.creatures.length>=5)return
let r=new FileReader()
r.onload=()=>{STATE.creatures.push(r.result);renderImages(STATE.creatures,creatureList,"creatures");autoUpdate()}
r.readAsDataURL(e.target.files[0])
}

function exportGame(){
const blob=new Blob([frame.srcdoc],{type:"text/html"})
const a=document.createElement("a")
a.href=URL.createObjectURL(blob)
a.download="game.html"
a.click()
}

/* ---------------- GAME ENGINE ULTRA ---------------- */

frame.srcdoc=\`
<!DOCTYPE html>
<html>
<head>
<style>
body{margin:0;overflow:hidden;background:#000;color:#fff;font-family:Arial}
#bg1,#bg2{position:absolute;width:200%;height:100%;background-size:cover;background-repeat:repeat-x}
#bg1{animation:bg1 30s linear infinite;opacity:0.6}
#bg2{animation:bg2 15s linear infinite}
@keyframes bg1{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
@keyframes bg2{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.entity{position:absolute;width:100px;height:100px}
.coin{position:absolute;width:40px;height:40px;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.obstacle{position:absolute;width:60px;height:200px;background:red}
#ui{position:absolute;top:10px;left:10px}
.overlay{position:absolute;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.7)}
button{padding:10px 20px}
.taskBox{position:absolute;top:30%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);padding:20px;border-radius:15px}
</style>
</head>
<body>
<div id="bg1"></div>
<div id="bg2"></div>
<div id="ui"></div>
<div id="game"></div>
<div id="overlay" class="overlay"></div>

<script>
let DATA=null
let y=200,velocity=0,gravity=0.6,jump=-10
let timer=0,coinsCollected=0
let recordList=JSON.parse(localStorage.getItem("records")||"[]")
let speed=2
let interval

window.onmessage=e=>{
if(e.data.type==="update"){DATA=e.data.state;init()}
}

function init(){
if(!DATA)return
bg1.style.backgroundImage="url("+DATA.background+")"
bg2.style.backgroundImage="url("+DATA.background+")"
overlay.innerHTML='<button onclick="start()">СТАРТ</button>'
}

function start(){
overlay.style.display="none"
game.innerHTML=""
timer=0;coinsCollected=0;speed=2

let entity=document.createElement("div")
entity.className="entity"
entity.id="player"
entity.innerHTML='<img src="'+DATA.creatures[0]+'" style="width:100%"><img src="'+DATA.avatars[0]+'" style="position:absolute;width:60%;top:20%;left:20%">'
game.appendChild(entity)

spawnLevel()
document.onkeydown=e=>{if(e.code==="Space")velocity=jump}
interval=setInterval(update,20)
}

function spawnLevel(){
DATA.tasks.forEach((t,i)=>{
let coin=document.createElement("img")
coin.src="https://cdn-icons-png.flaticon.com/512/138/138292.png"
coin.className="coin"
coin.style.left=(500+i*300)+"px"
coin.style.top=(Math.random()*400)+"px"
coin.dataset.index=i
game.appendChild(coin)
})
for(let i=0;i<5;i++){
let obs=document.createElement("div")
obs.className="obstacle"
obs.style.left=(600+i*400)+"px"
obs.style.top=(Math.random()>0.5?0:300)+"px"
game.appendChild(obs)
}
}

function update(){
velocity+=gravity
y+=velocity
let player=document.getElementById("player")
player.style.top=y+"px"
player.style.left="150px"

timer+=0.02
speed+=0.0005

ui.innerHTML="Время: "+timer.toFixed(1)+" | Монеты: "+coinsCollected+"/"+DATA.tasks.length

document.querySelectorAll(".coin,.obstacle").forEach(el=>{
el.style.left=(parseFloat(el.style.left)-speed)+"px"
})

checkCollisions(player)

if(y>window.innerHeight-100||y<0)gameOver()
}

function checkCollisions(player){
document.querySelectorAll(".coin").forEach(c=>{
if(hit(player,c)){
showTask(DATA.tasks[c.dataset.index])
c.remove()
}
})
document.querySelectorAll(".obstacle").forEach(o=>{
if(hit(player,o))gameOver()
})
}

function hit(a,b){
let r1=a.getBoundingClientRect(),r2=b.getBoundingClientRect()
return!(r2.left>r1.right||r2.right<r1.left||r2.top>r1.bottom||r2.bottom<r1.top)
}

function showTask(task){
clearInterval(interval)
let box=document.createElement("div")
box.className="taskBox"
box.innerHTML='<div>'+task.q+'</div><input id="ans"><button onclick="checkAnswer(\\''+task.a+'\\')">OK</button>'
game.appendChild(box)
}

function checkAnswer(a){
if(document.getElementById("ans").value==a){
coinsCollected++
document.querySelector(".taskBox").remove()
if(coinsCollected==DATA.tasks.length)win()
else interval=setInterval(update,20)
}else alert("Неверно")
}

function win(){
clearInterval(interval)
recordList.push(timer)
recordList.sort((a,b)=>a-b)
recordList=recordList.slice(0,5)
localStorage.setItem("records",JSON.stringify(recordList))
overlay.style.display="flex"
overlay.innerHTML="<h1>ПОБЕДА!</h1><div>ТОП-5:<br>"+recordList.map(r=>r.toFixed(1)).join("<br>")+"</div><button onclick='start()'>Снова</button>"
}

function gameOver(){
clearInterval(interval)
overlay.style.display="flex"
overlay.innerHTML="<h1>ПОРАЖЕНИЕ</h1><button onclick='start()'>Попробовать снова</button>"
}
<\/script>
</body>
</html>
\`
</script>
</body>
</html>
