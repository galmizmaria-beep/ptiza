<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞: –ú–∞—Å—Ç–µ—Ä v2.0</title>
    <style>
        :root { --primary: #00d2ff; --bg: #1a1a2d; --panel: #252540; --text: #e0e0ff; --accent: #ff00ff; --success: #00ff88; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 20px; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); text-transform: uppercase; text-shadow: 0 0 10px var(--primary); font-size: 24px; }
        
        /* Inputs & Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid #444; }
        .full-width { grid-column: 1 / -1; }
        h2 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 18px; }
        
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 14px; color: #aaa; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px; margin-top: 5px; background: #111; border: 1px solid #555; color: #fff; box-sizing: border-box; }
        input[type="range"] { width: 100%; margin: 10px 0; }
        
        .file-group { margin-top: 5px; border: 1px dashed #555; padding: 5px; border-radius: 5px; }
        .status-badge { display:none; color: var(--success); font-size: 12px; font-weight: bold; margin-left: 10px; }
        .status-badge.visible { display: inline; }

        /* Preview */
        #previewContainer { width: 100%; height: 250px; border: 2px solid var(--primary); margin-bottom: 15px; position: relative; background: #000; overflow: hidden; }
        #previewCanvas { width: 100%; height: 100%; display: block; }

        textarea.bulk-input { width: 100%; height: 150px; background: #111; color: #fff; border: 1px solid #555; padding: 10px; box-sizing: border-box; resize: vertical; margin-top: 5px; }

        .btn-main { background: linear-gradient(45deg, var(--primary), #0088ff); color: #fff; border: none; padding: 15px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 10px; text-transform: uppercase; transition: 0.3s; }
        .btn-main:hover { transform: scale(1.02); }

        #copySection { display: none; margin-top: 20px; background: #111; padding: 15px; border-radius: 5px; text-align: center; border: 1px solid var(--success); }
        .btn-copy { background: #444; color: white; border: 2px solid #666; padding: 12px 30px; font-size: 16px; cursor: pointer; border-radius: 50px; }
        .hidden-code { position: absolute; left: -9999px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞: –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</h1>
    </header>

    <div class="grid">
        <!-- Visuals -->
        <div class="card">
            <h2>üëÅÔ∏è –í–∏–∑—É–∞–ª</h2>
            <div id="previewContainer"><canvas id="previewCanvas"></canvas></div>
            
            <label>–§–æ–Ω (–ö–∞—Ä—Ç–∏–Ω–∫–∞):</label>
            <div class="file-group"><input type="file" id="fBg" accept="image/*" onchange="loadAsset('bg')"><span id="st-bg" class="status-badge">‚úî –û–ö</span></div>
            
            <label>–ê–≤–∞—Ç–∞—Ä (–ö–∞—Ä—Ç–∏–Ω–∫–∞):</label>
            <div class="file-group"><input type="file" id="fBird" accept="image/*" onchange="loadAsset('bird')"><span id="st-bird" class="status-badge">‚úî –û–ö</span></div>
            
            <label>–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞:</label><input type="range" id="sizeRange" min="0.5" max="2.0" step="0.1" value="1.0">
            <label>–†–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–æ–≤:</label><input type="range" id="objSizeRange" min="0.5" max="2.0" step="0.1" value="1.0">
            <label>–°–∫–æ—Ä–æ—Å—Ç—å:</label><input type="range" id="speedRange" min="1" max="15" value="5">
        </div>

        <!-- Settings -->
        <div class="card">
            <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã:</label><input type="text" id="txtTitle" value="–ü–û–õ–ï–¢ –ê–í–ê–¢–ê–†–ê">
            <label>–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –°—Ç–∞—Ä—Ç:</label><input type="text" id="txtStart" value="–ò–ì–†–ê–¢–¨">
            <label>–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã:</label><input type="text" id="txtWin" value="–ü–û–ë–ï–î–ê!">
            <label>–¢–µ–∫—Å—Ç –ø–æ—Ä–∞–∂–µ–Ω–∏—è:</label><input type="text" id="txtLose" value="–í–†–ï–ú–Ø –í–´–®–õ–û">
            <label>–í—Ä–µ–º—è (—Å–µ–∫):</label><input type="number" id="valTime" value="60">

            <h3 style="margin-top:20px; color:#fff;">–û–±—ä–µ–∫—Ç—ã</h3>
            <label>–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ (–í—Ä–∞–≥):</label>
            <div class="file-group"><input type="file" id="fObs" accept="image/*" onchange="loadAsset('obs')"><span id="st-obs" class="status-badge">‚úî –û–ö</span></div>
            <label>–ú–æ–Ω–µ—Ç–∞ (–ë–æ–Ω—É—Å):</label>
            <div class="file-group"><input type="file" id="fCoin" accept="image/*" onchange="loadAsset('coin')"><span id="st-coin" class="status-badge">‚úî –û–ö</span></div>
        </div>

        <!-- Questions -->
        <div class="card full-width">
            <h2>‚ùì –í–æ–ø—Ä–æ—Å—ã (–ï—Å–ª–∏ –Ω—É–∂–Ω—ã)</h2>
            <textarea id="bulkQuestions" class="bulk-input" placeholder="–í–æ–ø—Ä–æ—Å | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π1 | –ù–µ–≤–µ—Ä–Ω—ã–π2&#10;–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2+2? | 4 | 5 | 6"></textarea>
        </div>

        <!-- Generate -->
        <div class="card full-width" style="text-align: center;">
            <button class="btn-main" onclick="generate()">üöÄ –°–û–ó–î–ê–¢–¨ –ö–û–î –ò–ì–†–´</button>
            <div id="copySection">
                <textarea id="finalCode" class="hidden-code"></textarea>
                <button class="btn-copy" id="copyBtn" onclick="doCopy()">üìã –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –í –ë–£–§–ï–†</button>
                <p style="color:#aaa; font-size:13px; margin-top:10px;">–í Genially: Insert -> Others -> –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ -> Insert. –ó–∞—Ç–µ–º —Ä–∞—Å—Ç—è–Ω–∏—Ç–µ —Ä–∞–º–∫—É –Ω–∞ –≤–µ—Å—å —Å–ª–∞–π–¥.</p>
            </div>
        </div>
    </div>
</div>

<script>
    const assets = { bg: null, bird: null, obs: null, coin: null, music: null };
    const pImg = { bg: new Image(), bird: new Image(), obs: new Image(), coin: new Image() };

    function loadAsset(key) {
        const input = document.getElementById(key === 'bg' ? 'fBg' : key === 'bird' ? 'fBird' : key === 'obs' ? 'fObs' : 'fCoin');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                assets[key] = e.target.result;
                if(pImg[key]) pImg[key].src = e.target.result;
                document.getElementById('st-'+key).classList.add('visible');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- PREVIEW LOGIC ---
    const pCanvas = document.getElementById('previewCanvas');
    const pCtx = pCanvas.getContext('2d');
    let pFrame = 0, pBgX = 0;

    function previewLoop() {
        if(pCanvas.parentElement) {
            pCanvas.width = pCanvas.parentElement.offsetWidth;
            pCanvas.height = pCanvas.parentElement.offsetHeight;
        }
        let W = pCanvas.width, H = pCanvas.height;
        pCtx.clearRect(0,0,W,H);

        // BG
        pBgX -= (parseInt(document.getElementById('speedRange').value) * 0.5);
        if(pImg.bg.src && pImg.bg.complete) {
            let ptrn = pCtx.createPattern(pImg.bg, 'repeat');
            if(ptrn) { pCtx.fillStyle = ptrn; pCtx.save(); pCtx.translate(pBgX, 0); pCtx.fillRect(-pBgX, 0, W*2, H); pCtx.restore(); }
        } else {
            pCtx.fillStyle = '#111'; pCtx.fillRect(0,0,W,H);
        }

        // Bird
        let sz = 80 * parseFloat(document.getElementById('sizeRange').value);
        if(pImg.bird.src && pImg.bird.complete) {
            pCtx.drawImage(pImg.bird, W/2 - sz/2, H/2 - sz/2, sz, sz);
        } else {
            pCtx.fillStyle = '#00d2ff'; pCtx.beginPath(); pCtx.arc(W/2, H/2, 20, 0, 7); pCtx.fill();
        }

        pFrame++;
        requestAnimationFrame(previewLoop);
    }
    previewLoop();

    // --- GENERATOR ---
    function parseQuestions() {
        const raw = document.getElementById('bulkQuestions').value.trim();
        if(!raw) return [];
        return raw.split('\n').filter(line => line.trim() !== '').map(line => {
            const parts = line.split('|').map(s => s.trim());
            return parts.length > 2 
                ? { t: parts[0], type: 'choice', c: parts[1], w: parts.slice(2) }
                : { t: parts[0], type: 'input', c: parts[1] };
        });
    }

    function generate() {
        const CONFIG = {
            title: document.getElementById('txtTitle').value,
            btn: document.getElementById('txtStart').value,
            win: document.getElementById('txtWin').value,
            lose: document.getElementById('txtLose').value,
            time: document.getElementById('valTime').value,
            speed: document.getElementById('speedRange').value,
            scale: document.getElementById('sizeRange').value,
            objScale: document.getElementById('objSizeRange').value,
            qs: parseQuestions(),
            img: assets
        };

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –∏–≥—Ä—ã. –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª—ç—à–µ–π.
        const CODE = `
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
    /* CSS RESET */
    html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: transparent; font-family: sans-serif; }
    
    #game-container {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        width: 100%; height: 100%;
        overflow: hidden;
    }

    canvas { display: block; width: 100%; height: 100%; }

    /* UI LAYERS */
    .screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.8); z-index: 100;
        transition: opacity 0.5s;
    }
    .hidden { opacity: 0; pointer-events: none; }

    h1 { color: #00d2ff; text-shadow: 0 0 20px #00d2ff; font-size: clamp(30px, 8vw, 60px); text-align: center; margin-bottom: 30px; }
    
    .btn {
        background: #00d2ff; color: #000; border: none; padding: 15px 40px;
        font-size: 24px; font-weight: bold; border-radius: 50px; cursor: pointer;
        box-shadow: 0 0 20px #00d2ff; text-transform: uppercase;
    }
    .btn:hover { transform: scale(1.1); background: #fff; }

    .hud { position: absolute; top: 10px; font-weight: bold; font-size: 24px; color: #fff; text-shadow: 2px 2px 0 #000; z-index: 50; }
    
    /* Quiz Modal */
    #quiz-wrap {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center;
    }
    #quiz-box { background: #223; padding: 20px; border-radius: 10px; border: 2px solid #00d2ff; text-align: center; color: #fff; width: 80%; max-width: 400px; }
    .q-btn { display: block; width: 100%; padding: 10px; margin: 5px 0; background: #445; color: white; border: 1px solid #666; cursor: pointer; font-size: 18px; }
    .q-btn:hover { background: #00d2ff; color: #000; }

</style>
</head>
<body>

<div id="game-container">
    <canvas id="cvs"></canvas>
    
    <div class="hud" style="left: 10px;">‚è± <span id="ui-time">60</span></div>
    <div class="hud" style="right: 10px;">‚≠ê <span id="ui-score">0</span></div>

    <!-- START SCREEN -->
    <div id="scr-start" class="screen">
        <h1 id="txt-title">GAME</h1>
        <button class="btn" onclick="startGame()">START</button>
    </div>

    <!-- END SCREEN -->
    <div id="scr-end" class="screen hidden">
        <h1 id="txt-end">END</h1>
        <p style="color:#fff; font-size:24px;">Score: <span id="end-score">0</span></p>
        <button class="btn" onclick="location.reload()">‚Ü∫</button>
    </div>

    <!-- QUIZ -->
    <div id="quiz-wrap">
        <div id="quiz-box">
            <h2 id="q-text">Question</h2>
            <div id="q-opts"></div>
        </div>
    </div>
    
    <!-- ERROR LOG -->
    <div id="err-log" style="position:absolute; bottom:0; left:0; color:red; font-size:12px; background:rgba(0,0,0,0.8); pointer-events:none; z-index:999;"></div>
</div>

<script>
// --- ERROR HANDLING FOR GENIALLY ---
window.onerror = function(msg, url, line) {
    document.getElementById('err-log').innerHTML += "Err: " + msg + "<br>";
};

try {
    const CFG = ${JSON.stringify(CONFIG)};
    
    // SETUP
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    const container = document.getElementById('game-container');
    
    document.getElementById('txt-title').innerText = CFG.title;
    document.querySelector('#scr-start button').innerText = CFG.btn;
    
    let W, H;
    let gameRunning = false;
    let gamePaused = false;
    let frame = 0;
    let score = 0;
    let time = parseInt(CFG.time);
    let mx = 0, my = 0;
    let timerInt = null;

    // IMAGES
    const img = { bg: new Image(), bird: new Image(), obs: new Image(), coin: new Image() };
    if(CFG.img.bg) img.bg.src = CFG.img.bg;
    if(CFG.img.bird) img.bird.src = CFG.img.bird;
    if(CFG.img.obs) img.obs.src = CFG.img.obs;
    if(CFG.img.coin) img.coin.src = CFG.img.coin;

    // GAME OBJECTS
    let objs = [];
    let bgX = 0;

    // --- RESIZE LOGIC (CRITICAL FOR GENIALLY) ---
    function resize() {
        // Use container dimensions, not window
        W = container.clientWidth;
        H = container.clientHeight;
        cvs.width = W;
        cvs.height = H;
        if(!gameRunning) { mx = W/2; my = H/2; }
    }
    window.addEventListener('resize', resize);
    // Force check every 500ms because Genially animates iframe size
    setInterval(resize, 500);
    resize();

    // --- INPUT ---
    container.addEventListener('mousemove', e => {
        const rect = container.getBoundingClientRect();
        mx = e.clientX - rect.left;
        my = e.clientY - rect.top;
    });
    container.addEventListener('touchmove', e => {
        e.preventDefault();
        const rect = container.getBoundingClientRect();
        mx = e.touches[0].clientX - rect.left;
        my = e.touches[0].clientY - rect.top;
    }, {passive: false});

    // --- GAME LOOP ---
    function loop() {
        if(!gameRunning) return;
        requestAnimationFrame(loop);
        if(gamePaused) return;

        ctx.clearRect(0,0,W,H);
        
        // 1. BG
        bgX -= parseInt(CFG.speed);
        if(bgX <= -W) bgX = 0;
        
        if(img.bg.src && img.bg.complete) {
            // Draw 2 images for loop
            ctx.drawImage(img.bg, bgX, 0, W, H);
            ctx.drawImage(img.bg, bgX + W, 0, W, H);
        } else {
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,W,H);
        }

        // 2. SPAWN
        if(frame % (60 - parseInt(CFG.speed)*2) === 0) {
            let isCoin = (CFG.qs.length > 0 && Math.random() > 0.6) || (CFG.qs.length === 0 && Math.random() > 0.5);
            objs.push({
                x: W + 50,
                y: Math.random() * (H - 100) + 50,
                type: isCoin ? 'coin' : 'obs',
                active: true
            });
        }

        // 3. MOVE & DRAW OBJECTS
        let objSize = 60 * parseFloat(CFG.objScale);
        for(let i=0; i<objs.length; i++) {
            let o = objs[i];
            o.x -= (parseInt(CFG.speed) + 3);
            
            let sprite = o.type === 'coin' ? img.coin : img.obs;
            if(sprite.src && sprite.complete) {
                ctx.drawImage(sprite, o.x - objSize/2, o.y - objSize/2, objSize, objSize);
            } else {
                ctx.fillStyle = o.type === 'coin' ? 'yellow' : 'red';
                ctx.fillRect(o.x - objSize/2, o.y - objSize/2, objSize, objSize);
            }

            // COLLISION
            if(o.active && Math.hypot(o.x - mx, o.y - my) < objSize/2 + 30) {
                o.active = false;
                if(o.type === 'obs') {
                    time -= 5;
                    flashRed();
                } else {
                    if(CFG.qs.length > 0) startQuiz();
                    else { score++; updateUI(); }
                }
            }
            
            if(o.x < -100) { objs.splice(i,1); i--; }
        }

        // 4. BIRD
        let pSize = 80 * parseFloat(CFG.scale);
        if(img.bird.src && img.bird.complete) {
            ctx.drawImage(img.bird, mx - pSize/2, my - pSize/2, pSize, pSize);
        } else {
            ctx.fillStyle = '#00d2ff'; ctx.beginPath(); ctx.arc(mx, my, 20, 0, 7); ctx.fill();
        }

        frame++;
    }

    // --- LOGIC ---
    window.startGame = function() {
        document.getElementById('scr-start').classList.add('hidden');
        resize();
        gameRunning = true;
        score = 0;
        time = parseInt(CFG.time);
        objs = [];
        updateUI();
        loop();
        
        timerInt = setInterval(() => {
            if(!gamePaused && gameRunning) {
                time--;
                updateUI();
                if(time <= 0) endGame(false);
            }
        }, 1000);
    };

    function endGame(win) {
        gameRunning = false;
        clearInterval(timerInt);
        const endScr = document.getElementById('scr-end');
        endScr.classList.remove('hidden');
        document.getElementById('txt-end').innerText = win ? CFG.win : CFG.lose;
        document.getElementById('txt-end').style.color = win ? '#0f0' : '#f00';
        document.getElementById('end-score').innerText = score;
    }

    function updateUI() {
        document.getElementById('ui-time').innerText = time;
        document.getElementById('ui-score').innerText = score;
    }

    function flashRed() {
        cvs.style.opacity = 0.5; cvs.style.background = 'red';
        setTimeout(() => { cvs.style.opacity = 1; cvs.style.background = 'transparent'; }, 100);
    }

    // --- QUIZ ---
    function startQuiz() {
        gamePaused = true;
        const qWrap = document.getElementById('quiz-wrap');
        const qOpts = document.getElementById('q-opts');
        const qText = document.getElementById('q-text');
        
        let q = CFG.qs[Math.floor(Math.random() * CFG.qs.length)];
        qText.innerText = q.t;
        qOpts.innerHTML = '';
        
        let answers = [q.c, ...(q.w || [])].sort(() => Math.random() - 0.5);
        
        answers.forEach(ans => {
            let btn = document.createElement('button');
            btn.className = 'q-btn';
            btn.innerText = ans;
            btn.onclick = () => {
                qWrap.style.display = 'none';
                if(ans === q.c) { score++; } else { time -= 10; }
                updateUI();
                gamePaused = false;
            };
            qOpts.appendChild(btn);
        });
        
        qWrap.style.display = 'flex';
    }

} catch(err) {
    document.body.innerHTML = '<h2 style="color:red">CRITICAL ERROR: ' + err.message + '</h2>';
}
<\/script>
</body>
</html>`;
        
        document.getElementById('finalCode').value = CODE;
        document.getElementById('copySection').style.display = 'block';
    }

    function doCopy() {
        document.getElementById('finalCode').select();
        document.execCommand('copy');
        document.getElementById('copyBtn').innerText = "‚úÖ –°–ö–û–ü–ò–†–û–í–ê–ù–û!";
    }
</script>
</body>
</html>
