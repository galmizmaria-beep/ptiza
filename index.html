<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞: –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä PRO</title>
    <style>
        :root { --primary: #00d2ff; --bg: #1a1a2d; --panel: #252540; --text: #e0e0ff; --accent: #ff00ff; --success: #00ff88; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 20px; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); text-transform: uppercase; text-shadow: 0 0 10px var(--primary); font-size: 24px; }
        .lang-switch button { background: #333; color: #fff; border: 1px solid #555; padding: 5px 10px; cursor: pointer; transition: 0.3s; }
        .lang-switch button.active { background: var(--primary); color: #000; font-weight: bold; }

        /* Layout */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid #444; position: relative; }
        .full-width { grid-column: 1 / -1; }
        
        h2 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 18px; }
        
        /* Inputs */
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 14px; color: #aaa; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 8px; margin-top: 5px; background: #111; border: 1px solid #555; color: #fff; border-radius: 4px; box-sizing: border-box;
        }
        input[type="range"] { width: 100%; margin: 10px 0; }
        input[type="file"] { margin-top: 5px; font-size: 12px; }
        
        .status-check { color: var(--success); font-weight: bold; font-size: 12px; margin-left: 10px; display: none; }

        /* Questions Textarea */
        textarea.bulk-input {
            width: 100%; height: 200px; background: #111; color: #fff; border: 1px solid #555; 
            font-family: monospace; padding: 10px; box-sizing: border-box; resize: vertical; margin-top: 5px;
        }
        .help-text { font-size: 12px; color: #888; margin-top: 5px; line-height: 1.4; }

        /* STATIC PREVIEW GALLERY */
        #staticPreview {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;
        }
        .prev-box {
            background: #000; border: 1px solid #555; border-radius: 5px; 
            height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden; text-align: center;
        }
        .prev-box img { max-width: 100%; max-height: 80px; object-fit: contain; }
        .prev-box span { font-size: 10px; color: #888; margin-top: 5px; }
        #questionsPreview {
            grid-column: 1 / -1; height: auto; padding: 10px; text-align: left; font-size: 12px; color: #fff;
            background: #112; align-items: flex-start;
        }

        /* Main Buttons */
        .btn-main { 
            background: linear-gradient(45deg, var(--primary), #0088ff); color: #fff; border: none; 
            padding: 15px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; 
            border-radius: 5px; margin-top: 10px; text-transform: uppercase; transition: 0.3s;
        }
        .btn-main:hover { transform: scale(1.02); }

        /* Copy Section */
        #copySection { display: none; margin-top: 20px; background: #111; padding: 15px; border-radius: 5px; text-align: center; }
        .btn-copy {
            background: #444; color: white; border: 2px solid #666; padding: 12px 30px; 
            font-size: 16px; cursor: pointer; border-radius: 50px; display: inline-flex; align-items: center; gap: 10px;
            transition: all 0.3s ease;
        }
        .btn-copy.success { background: var(--success); color: #000; border-color: var(--success); }
        .hidden-code { position: absolute; left: -9999px; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 data-key="title">–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞</h1>
        <div class="lang-switch">
            <button onclick="setLang('ru')" id="btn-ru" class="active">RU</button>
            <button onclick="setLang('en')" id="btn-en">EN</button>
        </div>
    </header>

    <div class="grid">
        
        <!-- Preview -->
        <div class="card">
            <h2 data-key="sec_visual">üëÅÔ∏è –ê–∫—Ç–∏–≤—ã (–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)</h2>
            
            <div id="staticPreview">
                <div class="prev-box">
                    <img id="view-bg" alt="–ù–µ—Ç —Ñ–æ–Ω–∞">
                    <span data-key="lbl_bg">–§–æ–Ω</span>
                </div>
                <div class="prev-box">
                    <img id="view-bird" alt="–ù–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞">
                    <span data-key="lbl_bird">–ê–≤–∞—Ç–∞—Ä</span>
                </div>
                <div class="prev-box">
                    <img id="view-obs" alt="–ù–µ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è">
                    <span data-key="lbl_obs">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ</span>
                </div>
                <div class="prev-box">
                    <img id="view-coin" alt="–ù–µ—Ç –º–æ–Ω–µ—Ç—ã">
                    <span data-key="lbl_coin">–ú–æ–Ω–µ—Ç–∞</span>
                </div>
                <div class="prev-box" id="questionsPreview">
                    <div id="q-count">–í–æ–ø—Ä–æ—Å–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: 0</div>
                </div>
            </div>
            
            <label>–§–æ–Ω (–ö–∞—Ä—Ç–∏–Ω–∫–∞): <span id="st-bg" class="status-check">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ</span></label>
            <input type="file" id="fBg" accept="image/*" onchange="loadAsset('bg')">
            
            <label>–ê–≤–∞—Ç–∞—Ä (–ö–∞—Ä—Ç–∏–Ω–∫–∞): <span id="st-bird" class="status-check">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ</span></label>
            <input type="file" id="fBird" accept="image/*" onchange="loadAsset('bird')">
            
            <label data-key="lbl_size">–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞:</label>
            <input type="range" id="sizeRange" min="0.5" max="2.0" step="0.1" value="1.0">
            
            <label data-key="lbl_obj_size">–†–∞–∑–º–µ—Ä –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π/–º–æ–Ω–µ—Ç:</label>
            <input type="range" id="objSizeRange" min="0.5" max="2.0" step="0.1" value="1.0">
            
            <label data-key="lbl_speed">–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–ª–µ—Ç–∞:</label>
            <input type="range" id="speedRange" min="1" max="10" value="3">
        </div>

        <!-- Settings -->
        <div class="card">
            <h2 data-key="sec_settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            
            <label data-key="lbl_gameTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
            <input type="text" id="txtTitle" value="–ü–û–õ–ï–¢ –ê–í–ê–¢–ê–†–ê">
            
            <label data-key="lbl_btnStart">–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç:</label>
            <input type="text" id="txtStart" value="–ò–ì–†–ê–¢–¨">
            
            <label data-key="lbl_win">–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã:</label>
            <input type="text" id="txtWin" value="–¢–´ –ü–û–ë–ï–î–ò–õ!">
            
            <label data-key="lbl_lose">–¢–µ–∫—Å—Ç –ø–æ—Ä–∞–∂–µ–Ω–∏—è:</label>
            <input type="text" id="txtLose" value="–í–†–ï–ú–Ø –í–´–®–õ–û">

            <div style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <label data-key="lbl_time">–í—Ä–µ–º—è (—Å):</label>
                    <input type="number" id="valTime" value="60">
                </div>
            </div>

            <h3 style="font-size:14px; margin-top:15px; color:#fff;" data-key="sec_assets">–û–±—ä–µ–∫—Ç—ã</h3>
            
            <label>–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ: <span id="st-obs" class="status-check">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ</span></label>
            <input type="file" id="fObs" accept="image/*" onchange="loadAsset('obs')">
            
            <label>–ú–æ–Ω–µ—Ç–∞: <span id="st-coin" class="status-check">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ</span></label>
            <input type="file" id="fCoin" accept="image/*" onchange="loadAsset('coin')">
            
            <label>–ú—É–∑—ã–∫–∞: <span id="st-music" class="status-check">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ</span></label>
            <input type="file" id="fMusic" accept="audio/*" onchange="loadAsset('music', false)">
        </div>

        <!-- Questions Bulk -->
        <div class="card full-width">
            <h2 data-key="sec_questions">‚ùì –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤</h2>
            <textarea id="bulkQuestions" class="bulk-input" placeholder="" oninput="updateQCount()"></textarea>
            <div class="help-text" data-key="help_q">
                –í—Å—Ç–∞–≤–ª—è–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã —Å–ø–∏—Å–∫–æ–º. –§–æ—Ä–º–∞—Ç:<br>
                <b>–í–æ–ø—Ä–æ—Å | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç | –ù–µ–≤–µ—Ä–Ω—ã–π 1 | –ù–µ–≤–µ—Ä–Ω—ã–π 2</b><br>
                <i>–ü—Ä–∏–º–µ—Ä: –°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2+2? | 4 | 5 | 6</i>
            </div>
        </div>

        <!-- Generate -->
        <div class="card full-width" style="text-align: center;">
            <button class="btn-main" onclick="generate()" data-key="btn_gen">üöÄ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
            
            <div id="copySection">
                <textarea id="finalCode" class="hidden-code"></textarea>
                <button class="btn-copy" id="copyBtn" onclick="doCopy()">
                    <span id="copyIcon">üìã</span> 
                    <span id="copyText" data-key="btn_copy">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</span>
                </button>
                <p style="color:#666; font-size:12px; margin-top:10px;" data-key="lbl_copy_hint">–í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ Genially (Insert -> Others) –∏ —Ä–∞—Å—Ç—è–Ω–∏—Ç–µ –Ω–∞ –≤–µ—Å—å —Å–ª–∞–π–¥.</p>
            </div>
        </div>
    </div>
</div>

<script>
    const assets = { bg: null, bird: null, obs: null, coin: null, music: null };
    let currentLang = 'ru';

    const dict = {
        ru: {
            title: "–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞",
            sec_visual: "üëÅÔ∏è –ê–∫—Ç–∏–≤—ã (–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)",
            lbl_bg: "–§–æ–Ω", lbl_bird: "–ê–≤–∞—Ç–∞—Ä", lbl_size: "–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞:", lbl_obj_size: "–†–∞–∑–º–µ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤:", lbl_speed: "–°–∫–æ—Ä–æ—Å—Ç—å:",
            sec_settings: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏",
            lbl_gameTitle: "–ù–∞–∑–≤–∞–Ω–∏–µ:", lbl_btnStart: "–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç:", lbl_win: "–ü–æ–±–µ–¥–∞:", lbl_lose: "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ:",
            lbl_time: "–í—Ä–µ–º—è (—Å–µ–∫):", sec_assets: "–û–±—ä–µ–∫—Ç—ã", lbl_obs: "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ", lbl_coin: "–ú–æ–Ω–µ—Ç–∞",
            sec_questions: "‚ùì –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤",
            help_q: "–§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π 1 | –ù–µ–≤–µ—Ä–Ω—ã–π 2",
            btn_gen: "üöÄ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£",
            btn_copy: "–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î",
            btn_copied: "–°–ö–û–ü–ò–†–û–í–ê–ù–û!",
            lbl_copy_hint: "–í—Å—Ç–∞–≤—å—Ç–µ –≤ Genially (Insert -> Others) –∏ —Ä–∞—Å—Ç—è–Ω–∏—Ç–µ.",
            ph_bulk: "–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2+2? | 4 | 5 | 6\n–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏? | –ü–∞—Ä–∏–∂ | –õ–æ–Ω–¥–æ–Ω | –ë–µ—Ä–ª–∏–Ω\n–ù–∞–ø–∏—à–∏ —Å–ª–æ–≤–æ –ü—Ä–∏–≤–µ—Ç | –ü—Ä–∏–≤–µ—Ç",
            val_title: "–ü–û–õ–ï–¢ –ê–í–ê–¢–ê–†–ê", val_start: "–ò–ì–†–ê–¢–¨", val_win: "–ü–û–ë–ï–î–ê!", val_lose: "–í–†–ï–ú–Ø –í–´–®–õ–û",
            loaded: "‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ", q_count: "–í–æ–ø—Ä–æ—Å–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: "
        },
        en: {
            title: "Avatar Flight",
            sec_visual: "üëÅÔ∏è Assets (Preview)",
            lbl_bg: "Background", lbl_bird: "Avatar", lbl_size: "Avatar Size:", lbl_obj_size: "Objects Size:", lbl_speed: "Speed:",
            sec_settings: "‚öôÔ∏è Settings",
            lbl_gameTitle: "Title:", lbl_btnStart: "Start Button:", lbl_win: "Win Text:", lbl_lose: "Lose Text:",
            lbl_time: "Time (s):", sec_assets: "Objects", lbl_obs: "Obstacle", lbl_coin: "Coin",
            sec_questions: "‚ùì Questions List",
            help_q: "Format: Question | Correct | Wrong 1 | Wrong 2",
            btn_gen: "üöÄ CREATE GAME",
            btn_copy: "COPY CODE",
            btn_copied: "COPIED!",
            lbl_copy_hint: "Paste into Genially (Insert -> Others) and stretch full screen.",
            ph_bulk: "2+2? | 4 | 5 | 6\nCapital of France? | Paris | London\nType Hello | Hello",
            val_title: "AVATAR FLIGHT", val_start: "PLAY", val_win: "YOU WON!", val_lose: "GAME OVER",
            loaded: "‚úÖ Loaded", q_count: "Questions loaded: "
        }
    };

    function setLang(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-key]').forEach(el => {
            if(dict[lang][el.dataset.key]) el.innerText = dict[lang][el.dataset.key];
        });
        document.getElementById('btn-ru').className = lang === 'ru' ? 'active' : '';
        document.getElementById('btn-en').className = lang === 'en' ? 'active' : '';
        
        const d = dict[lang];
        document.getElementById('txtTitle').value = d.val_title;
        document.getElementById('txtStart').value = d.val_start;
        document.getElementById('txtWin').value = d.val_win;
        document.getElementById('txtLose').value = d.val_lose;
        document.getElementById('bulkQuestions').placeholder = d.ph_bulk;
        
        const btn = document.getElementById('copyBtn');
        btn.className = 'btn-copy';
        document.getElementById('copyText').innerText = d.btn_copy;
        
        document.querySelectorAll('.status-check').forEach(el => el.innerText = d.loaded);
        updateQCount();
    }

    function loadAsset(key, isImg=true) {
        const input = document.getElementById(key === 'bg' ? 'fBg' : key === 'bird' ? 'fBird' : key === 'obs' ? 'fObs' : key === 'coin' ? 'fCoin' : 'fMusic');
        const status = document.getElementById(key === 'bg' ? 'st-bg' : key === 'bird' ? 'st-bird' : key === 'obs' ? 'st-obs' : key === 'coin' ? 'st-coin' : 'st-music');
        
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                assets[key] = e.target.result;
                // Update Status
                if(status) {
                    status.style.display = 'inline';
                    status.innerText = dict[currentLang].loaded;
                }
                // Update Preview Image
                if(isImg) {
                    const imgId = 'view-' + key;
                    const imgEl = document.getElementById(imgId);
                    if(imgEl) imgEl.src = e.target.result;
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function updateQCount() {
        const qs = parseQuestions();
        document.getElementById('q-count').innerText = dict[currentLang].q_count + qs.length;
    }

    // === GENERATE ===
    function parseQuestions() {
        const raw = document.getElementById('bulkQuestions').value.trim();
        if(!raw) return [];
        return raw.split('\n').filter(line => line.trim() !== '').map(line => {
            const parts = line.split('|').map(s => s.trim());
            return parts.length > 2 
                ? { t: parts[0], type: 'choice', c: parts[1], w: parts.slice(2) }
                : { t: parts[0], type: 'input', c: parts[1] };
        });
    }

    function generate() {
        const questions = parseQuestions();
        const CONFIG = {
            title: document.getElementById('txtTitle').value,
            btn: document.getElementById('txtStart').value,
            win: document.getElementById('txtWin').value,
            lose: document.getElementById('txtLose').value,
            time: document.getElementById('valTime').value,
            speed: document.getElementById('speedRange').value,
            scale: document.getElementById('sizeRange').value,
            objScale: document.getElementById('objSizeRange').value,
            qs: questions,
            img: assets
        };

        const CODE = `
<!DOCTYPE html>
<html>
<head>
<style>
    /* RESET */
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; }
    body { font-family:'Segoe UI',sans-serif; user-select:none; -webkit-user-select:none; }
    
    #game-box { position:absolute; top:0; left:0; width:100%; height:100%; overflow:hidden; touch-action: none; }
    canvas { display:block; width:100%; height:100%; } 
    
    /* UI HUD */
    .hud { position:absolute; top:10px; color:#00d2ff; font-size:clamp(20px, 4vw, 30px); font-weight:bold; text-shadow:2px 2px 0 #000; padding:5px 15px; background:rgba(0,0,0,0.6); border-radius:10px; border:1px solid #00d2ff; z-index: 50; }
    
    /* SCREENS - MENUS */
    .screen { 
        position:absolute; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.85); display:flex; flex-direction:column; 
        align-items:center; justify-content:center; 
        z-index:100; pointer-events:auto; 
    }
    
    h1 { color:#00d2ff; font-size:clamp(30px, 6vw, 60px); text-transform:uppercase; text-shadow:0 0 20px #00d2ff; margin-bottom:20px; text-align:center; }
    
    button.btn-play {
        background: linear-gradient(180deg, #00d2ff, #0088aa);
        border: 4px solid #fff; padding: 15px 60px;
        color: #fff; font-size: clamp(24px, 5vw, 40px); font-weight: bold; text-transform: uppercase;
        border-radius: 60px; cursor: pointer; box-shadow: 0 0 30px #00d2ff;
        transition: transform 0.1s; text-shadow: 1px 1px 2px #000;
        z-index: 200; pointer-events: auto;
    }
    button.btn-play:hover { transform: scale(1.05); background: #fff; color: #0088aa; }
    button.btn-play:active { transform: scale(0.95); }

    /* QUIZ BOX - OVERLAY ON GAME */
    #quiz-overlay {
        display:none; position:absolute; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.7); /* Semi-transparent */
        z-index: 150;
        align-items: center; justify-content: center;
    }
    #quiz-box { 
        width:90%; max-width:500px; background:#1e293b; border:3px solid #00d2ff; 
        padding:20px; border-radius:15px; text-align:center; color:#fff; 
        box-shadow: 0 0 50px #000;
    }
    .q-btn { display:block; width:100%; padding:15px; margin:8px 0; background:#334; border:1px solid #556; color:#fff; font-size:18px; cursor:pointer; position:relative; }
    .q-btn:hover { background:#00d2ff; color:#000; }
    input.q-inp { width:80%; padding:10px; font-size:20px; text-align:center; margin-bottom:10px; color:#000; }

</style>
</head>
<body>

<div id="game-box">
    <!-- UI -->
    <div class="hud" style="left:10px">‚è± <span id="ui-time">0</span></div>
    <div class="hud" style="right:10px">üèÜ <span id="ui-score">0</span></div>

    <!-- CANVAS -->
    <canvas id="cvs"></canvas>

    <!-- START SCREEN -->
    <div id="scr-start" class="screen">
        <h1 id="mt-title">TITLE</h1>
        <button class="btn-play" id="btn-start">START</button>
    </div>

    <!-- END SCREEN -->
    <div id="scr-end" class="screen" style="display:none">
        <h1 id="mt-end">END</h1>
        <p style="color:#fff; font-size:30px">Score: <span id="end-score">0</span></p>
        <button class="btn-play" onclick="GM.reset()">‚Ü∫</button>
    </div>

    <!-- QUIZ OVERLAY -->
    <div id="quiz-overlay">
        <div id="quiz-box">
            <h2 id="q-txt" style="color:#00d2ff; margin-top:0">Question</h2>
            <div id="q-body"></div>
        </div>
    </div>
</div>

<script>
const CFG = ${JSON.stringify(CONFIG)};
const IMG = CFG.img;

document.getElementById('mt-title').innerText = CFG.title;
document.getElementById('btn-start').innerText = CFG.btn;

const cvs = document.getElementById('cvs');
const ctx = cvs.getContext('2d');
let W, H;

function resize() {
    W = cvs.width = window.innerWidth;
    H = cvs.height = window.innerHeight;
    if(!GM.run) { GM.playerX = 0; GM.playerY = 0; }
}
window.addEventListener('resize', resize);
setTimeout(resize, 100);

const AC = new (window.AudioContext || window.webkitAudioContext)();
function sfx(type) {
    if(AC.state === 'suspended') AC.resume();
    const o = AC.createOscillator(); const g = AC.createGain();
    o.connect(g); g.connect(AC.destination);
    const t = AC.currentTime;
    
    if(type==='coin') {
        o.type = 'sine'; o.frequency.setValueAtTime(1200, t);
        g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.5);
        o.start(t); o.stop(t+0.5);
    } else if(type==='boom') {
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(100, t); o.frequency.exponentialRampToValueAtTime(10, t+0.3);
        g.gain.setValueAtTime(0.3, t); g.gain.linearRampToValueAtTime(0, t+0.3);
        o.start(t); o.stop(t+0.3);
    } else if(type==='win') { 
        o.type='triangle'; 
        o.frequency.setValueAtTime(523, t); o.frequency.linearRampToValueAtTime(1000, t+0.3);
        g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.6);
        o.start(t); o.stop(t+0.6);
    } else if (type==='lose') {
        o.type='triangle';
        o.frequency.setValueAtTime(300, t); o.frequency.linearRampToValueAtTime(100, t+0.4);
        g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.4);
        o.start(t); o.stop(t+0.4);
    }
}

const iBg = new Image(); if(IMG.bg) iBg.src = IMG.bg;
const iBird = new Image(); if(IMG.bird) iBird.src = IMG.bird;
const iObs = new Image(); if(IMG.obs) iObs.src = IMG.obs;
const iCoin = new Image(); if(IMG.coin) iCoin.src = IMG.coin;
let music = null; if(IMG.music) { music = new Audio(IMG.music); music.loop=true; music.volume=0.4; }

const GM = {
    run: false, pause: false, frame: 0,
    time: parseInt(CFG.time), score: 0,
    objs: [], 
    mx: 0, my: 0, 
    playerX: 0, playerY: 0, // Virtual Camera Position
    hurt: 0,
    timerInt: null,
    
    start: () => {
        document.getElementById('scr-start').style.display = 'none';
        resize();
        GM.mx = W/2; GM.my = H/2;
        GM.playerX = 0; GM.playerY = 0;
        
        if(AC.state === 'suspended') AC.resume();
        if(music) music.play().catch(e=>{});
        
        GM.run = true;
        GM.objs = [];
        GM.frame = 0;
        GM.score = 0;
        GM.time = parseInt(CFG.time);
        document.getElementById('ui-score').innerText = "0";
        document.getElementById('ui-time').innerText = GM.time;
        
        loop();
        
        GM.timerInt = setInterval(() => {
            if(GM.run && !GM.pause) {
                GM.time--;
                document.getElementById('ui-time').innerText = GM.time;
                if(GM.time <= 0) GM.end(false);
            }
        }, 1000);
    },

    reset: () => {
        clearInterval(GM.timerInt);
        GM.run = false;
        GM.pause = false;
        // Hide End Screen, Show Start
        document.getElementById('scr-end').style.display = 'none';
        document.getElementById('scr-start').style.display = 'flex';
        document.getElementById('quiz-overlay').style.display = 'none';
        
        // Music reset
        if(music) { music.pause(); music.currentTime = 0; }
    },

    end: (win) => {
        GM.run = false;
        clearInterval(GM.timerInt);
        document.getElementById('scr-end').style.display = 'flex';
        document.getElementById('mt-end').innerText = win ? CFG.win : CFG.lose;
        document.getElementById('mt-end').style.color = win ? '#0f0' : '#f00';
        document.getElementById('end-score').innerText = GM.score;
        sfx(win?'win':'lose');
    }
};

document.getElementById('btn-start').addEventListener('click', GM.start);

window.addEventListener('mousemove', e => {
    GM.mx = e.clientX;
    GM.my = e.clientY;
});
window.addEventListener('touchmove', e => {
    e.preventDefault();
    GM.mx = e.touches[0].clientX;
    GM.my = e.touches[0].clientY;
}, {passive:false});

function loop() {
    if(!GM.run) return;
    requestAnimationFrame(loop);
    
    ctx.clearRect(0,0,W,H);
    if(GM.pause) return; 

    // --- 1. PLAYER MOVEMENT & INFINITE BG ---
    // Instead of objects moving relative to screen, 
    // The Player moves through the "World".
    // dx/dy is how much the player moves this frame based on mouse pos relative to center
    let dx = (GM.mx - W/2) * 0.1;
    let dy = (GM.my - H/2) * 0.1;
    
    GM.playerX += dx;
    GM.playerY += dy + parseInt(CFG.speed); // Fly forward (Y is forward in 2D topdown scrolling logic)
    
    // Background Tiling (Infinite)
    // We move the background pattern opposite to player X
    let bgScrollX = -GM.playerX;
    let bgScrollY = GM.frame * parseInt(CFG.speed); // Simple forward scroll for speed sensation

    if(iBg.src && iBg.complete) {
        let ptrn = ctx.createPattern(iBg, 'repeat');
        if(ptrn) {
            ctx.save();
            ctx.fillStyle = ptrn;
            // Shift pattern based on player X position to simulate turning
            ctx.translate(bgScrollX % iBg.width, bgScrollY % iBg.height);
            // Draw a huge rectangle to cover all edges even when turning hard
            // This prevents "white slides"
            ctx.fillRect(-W*2 + (-bgScrollX%iBg.width), -H*2, W*5, H*5);
            ctx.restore();
        }
    } else {
        ctx.fillStyle = '#112'; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = "rgba(255,255,255,0.4)";
        // Simple starfield that reacts to camera
        for(let i=0; i<40; i++) {
            let x = (Math.sin(i*99) * W * 2 - GM.playerX * 0.5) % W;
            if(x < 0) x += W;
            let y = (i*44 + GM.frame*parseInt(CFG.speed)) % H;
            ctx.fillRect(x, y, 3, 3);
        }
    }

    // --- 2. SPAWN OBJECTS ---
    // Spawn objects relative to the player's current X position
    // so they appear "ahead"
    if(GM.frame % (60 - parseInt(CFG.speed)*2) === 0) {
        let isCoin = (CFG.qs.length > 0 && Math.random() > 0.6);
        // Spawn X is relative to PlayerX + random offset
        // We create a wide "world"
        let spawnWorldX = GM.playerX + (Math.random()-0.5) * W * 1.5; 
        
        GM.objs.push({ 
            wx: spawnWorldX, // World X coordinate (fixed)
            z: 2000,         // Distance (comes closer)
            t: isCoin?'c':'o' 
        });
    }

    // --- 3. DRAW OBJECTS ---
    GM.objs.sort((a,b) => b.z - a.z);
    let objScaleUser = parseFloat(CFG.objScale || 1.0);
    let speed = parseInt(CFG.speed);

    for(let i=0; i<GM.objs.length; i++) {
        let o = GM.objs[i];
        o.z -= (2 + speed); // Object comes towards camera

        // Calculate Screen X based on World X minus Player X (Parallax)
        // If Object is at 100 and Player is at 100, Object is center screen.
        let relX = (o.wx - GM.playerX);
        
        // Remove if behind camera
        if(o.z < 10) { GM.objs.splice(i,1); i--; continue; }

        // Perspective projection
        let scale = 500 / o.z;
        let sx = W/2 + relX * scale; // Position on screen
        
        // Floating Y effect
        let hover = Math.sin(GM.frame * 0.05 + i) * 100;
        let sy = H/2 + (0 + (o.t==='o' ? hover : 0)) * scale; // Keep Y centered but scale
        
        // Make objects move "down" visually as they get closer (standard runner perspective)
        // Adjust SY slightly based on Z to fake ground plane
        sy += (2000 - o.z) * 0.1;

        let size = 100 * scale * objScaleUser;

        // Visual guide line (optional, helps depth)
        // ctx.strokeStyle="rgba(255,255,255,0.1)"; ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(sx,H); ctx.stroke();

        let img = (o.t==='c') ? iCoin : iObs;
        
        if (o.t === 'c') {
            // Coin spin
            let spin = Math.abs(Math.sin(GM.frame * 0.1 + i));
            let w = size * spin;
            if(img.src) ctx.drawImage(img, sx - w/2, sy - size/2, w, size);
            else { ctx.fillStyle = 'gold'; ctx.beginPath(); ctx.ellipse(sx, sy, w/2, size/2, 0, 0, 6.28); ctx.fill(); }
        } else {
            // Obstacle
            if(img.src) ctx.drawImage(img, sx-size/2, sy-size/2, size, size);
            else { ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(sx, sy, size/2, 0, 6.28); ctx.fill(); }
        }

        // HIT DETECTION
        // Check depth first (Z)
        if(o.z < 200 && o.z > 20) {
            // Then check 2D distance on screen
            // Since we control bird with mouse, bird is at GM.mx, GM.my
            // But visually bird is center-ish. 
            // Actually, in this logic, we are flying PAST objects.
            // If screen X of object is close to screen X of Bird...
            
            // Where is the bird drawn?
            // The bird is drawn at mouse position (GM.mx, GM.my).
            
            let dist = Math.hypot(sx - GM.mx, sy - GM.my);
            let hitbox = (size * 0.8) + (60 * parseFloat(CFG.scale));
            
            if(dist < hitbox) {
                GM.objs.splice(i,1); i--;
                hit(o.t);
            }
        }
    }

    // --- 4. DRAW BIRD ---
    if(GM.hurt > 0) {
        GM.hurt--;
        if(Math.floor(GM.hurt / 5) % 2 === 0) return;
    }

    let pSize = 120 * parseFloat(CFG.scale);
    if(iBird.src) {
        let tilt = (GM.mx - W/2) * 0.05;
        ctx.save();
        ctx.translate(GM.mx, GM.my);
        ctx.rotate(tilt * Math.PI/180);
        ctx.drawImage(iBird, -pSize/2, -pSize/2, pSize, pSize);
        ctx.restore();
    } else {
        ctx.fillStyle = '#0ff'; ctx.beginPath(); ctx.arc(GM.mx, GM.my, 20, 0, 7); ctx.fill();
    }
    GM.frame++;
}

function hit(type) {
    if(type === 'o') {
        sfx('boom');
        GM.hurt = 30;
        let f = document.createElement('div');
        f.style = "position:absolute;top:0;left:0;width:100%;height:100%;background:red;opacity:0.5;pointer-events:none;z-index:99";
        document.body.appendChild(f);
        setTimeout(()=>f.remove(), 100);
        GM.time -= 5;
        document.getElementById('ui-time').innerText = GM.time;
        if(GM.time<=0) GM.end(false);
    } else {
        sfx('coin');
        if(CFG.qs.length > 0) {
            GM.pause = true; 
            quiz();
        } else {
            GM.score++; 
            document.getElementById('ui-score').innerText = GM.score; 
        }
    }
}

function quiz() {
    let idx = Math.floor(Math.random()*CFG.qs.length);
    let q = CFG.qs[idx];

    let overlay = document.getElementById('quiz-overlay');
    let body = document.getElementById('q-body');
    document.getElementById('q-txt').innerText = q.t;
    body.innerHTML = '';
    
    // Show Overlay
    overlay.style.display = 'flex';

    const processAns = (txt) => {
        overlay.style.display = 'none';
        if(txt.trim().toLowerCase() === q.c.trim().toLowerCase()) {
            sfx('win'); GM.score++;
        } else {
            sfx('lose'); GM.time -= 10;
        }
        document.getElementById('ui-score').innerText = GM.score;
        document.getElementById('ui-time').innerText = GM.time;
        
        setTimeout(() => { GM.pause = false; }, 200);
    };

    if(q.type === 'choice') {
        let arr = [q.c, ...q.w].sort(() => Math.random()-0.5);
        arr.forEach(t => {
            let b = document.createElement('button'); 
            b.className='q-btn'; 
            b.innerText=t;
            b.onclick = (e) => { e.stopPropagation(); processAns(t); };
            body.appendChild(b);
        });
    } else {
        let inp = document.createElement('input'); 
        inp.className='q-inp';
        let b = document.createElement('button'); 
        b.className='q-btn'; 
        b.innerText='OK';
        b.onclick = (e) => { e.stopPropagation(); processAns(inp.value); };
        body.appendChild(inp); body.appendChild(b);
        inp.focus();
    }
}
<\/script>
</body>
</html>`;
        document.getElementById('finalCode').value = CODE;
        document.getElementById('copySection').style.display = 'block';
    }

    function doCopy() {
        const txt = document.getElementById('finalCode');
        txt.select();
        document.execCommand('copy');
        
        const btn = document.getElementById('copyBtn');
        const span = document.getElementById('copyText');
        const icon = document.getElementById('copyIcon');
        
        btn.classList.add('success');
        span.innerText = dict[currentLang].btn_copied;
        icon.innerText = "‚úÖ";
        
        setTimeout(() => {
            btn.classList.remove('success');
            span.innerText = dict[currentLang].btn_copy;
            icon.innerText = "üìã";
        }, 3000);
    }

    setLang('ru');
</script>
</body>
</html>
