<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞: –ú–∞—Å—Ç–µ—Ä</title>
    <style>
        :root { --primary: #00d2ff; --bg: #1a1a2d; --panel: #252540; --text: #e0e0ff; --accent: #ff00ff; --success: #00ff88; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 20px; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); text-transform: uppercase; text-shadow: 0 0 10px var(--primary); font-size: 24px; }
        .lang-switch button { background: #333; color: #fff; border: 1px solid #555; padding: 5px 10px; cursor: pointer; transition: 0.3s; }
        .lang-switch button.active { background: var(--primary); color: #000; font-weight: bold; }

        /* Layout */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid #444; position: relative; }
        .full-width { grid-column: 1 / -1; }
        
        h2 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 18px; }
        
        /* Inputs */
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 14px; color: #aaa; }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%; padding: 8px; margin-top: 5px; background: #111; border: 1px solid #555; color: #fff; border-radius: 4px; box-sizing: border-box;
        }
        input[type="range"] { width: 100%; margin: 10px 0; }
        
        /* File Input Wrapper */
        .file-group { margin-top: 5px; }
        input[type="file"] { font-size: 12px; color: #aaa; }
        .status-badge { display:none; color: var(--success); font-size: 12px; font-weight: bold; margin-left: 10px; }
        .status-badge.visible { display: inline; }

        /* Questions Textarea */
        textarea.bulk-input {
            height: 200px;
            font-family: monospace;
            resize: vertical;
        }
        .help-text { font-size: 12px; color: #888; margin-top: 5px; line-height: 1.4; }

        /* PREVIEW CANVAS */
        #previewContainer {
            width: 100%; height: 250px; border: 2px solid var(--primary); 
            margin-bottom: 15px; position: relative; background: #000; overflow: hidden;
        }
        #previewCanvas { width: 100%; height: 100%; display: block; }

        /* Main Buttons */
        .btn-main { 
            background: linear-gradient(45deg, var(--primary), #0088ff); color: #fff; border: none; 
            padding: 15px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; 
            border-radius: 5px; margin-top: 10px; text-transform: uppercase; transition: 0.3s;
        }
        .btn-main:hover { transform: scale(1.02); }

        /* Copy Section */
        #copySection { display: none; margin-top: 20px; background: #111; padding: 15px; border-radius: 5px; text-align: center; }
        .btn-copy {
            background: #444; color: white; border: 2px solid #666; padding: 12px 30px; 
            font-size: 16px; cursor: pointer; border-radius: 50px; display: inline-flex; align-items: center; gap: 10px;
            transition: all 0.3s ease;
        }
        .btn-copy.success { background: var(--success); color: #000; border-color: var(--success); }
        .hidden-code { position: absolute; left: -9999px; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 data-key="title">–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞</h1>
        <div class="lang-switch">
            <button onclick="setLang('ru')" id="btn-ru" class="active">RU</button>
            <button onclick="setLang('en')" id="btn-en">EN</button>
        </div>
    </header>

    <div class="grid">
        
        <!-- Visuals and Avatars -->
        <div class="card">
            <h2 data-key="sec_visual">üëÅÔ∏è –í–∏–∑—É–∞–ª (–ñ–∏–≤–æ–π –ø—Ä–æ—Å–º–æ—Ç—Ä)</h2>
            <div id="previewContainer"><canvas id="previewCanvas"></canvas></div>
            
            <label data-key="lbl_bg">–§–æ–Ω (–ö–∞—Ä—Ç–∏–Ω–∫–∞):</label>
            <div class="file-group">
                <input type="file" id="fBg" accept="image/*" onchange="loadAsset('bg')">
                <span id="st-bg" class="status-badge"></span>
            </div>
            
            <label data-key="lbl_birds">–ê–≤–∞—Ç–∞—Ä—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):</label>
            <div class="file-group">
                <input type="file" id="fBirds" accept="image/*" multiple onchange="loadAvatars()">
                <span id="st-birds" class="status-badge"></span>
            </div>
            
            <label data-key="lbl_bird_desc">–û–ø–∏—Å–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤ (–∫–∞–∂–¥–æ–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
            <textarea id="txtAvatarDescriptions" rows="4" data-placeholder-key="ph_avatar_desc"></textarea>

            <label data-key="lbl_size">–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞:</label>
            <input type="range" id="sizeRange" min="0.5" max="2.0" step="0.1" value="1.0">
            
            <label data-key="lbl_obj_size">–†–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–æ–≤:</label>
            <input type="range" id="objSizeRange" min="0.5" max="2.0" step="0.1" value="1.0">
            
            <label data-key="lbl_speed">–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–ª–µ—Ç–∞:</label>
            <input type="range" id="speedRange" min="1" max="10" value="3">
        </div>

        <!-- Settings -->
        <div class="card">
            <h2 data-key="sec_settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            
            <label data-key="lbl_gameTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
            <input type="text" id="txtTitle" value="–ü–û–õ–ï–¢ –ê–í–ê–¢–ê–†–ê">
            
            <label data-key="lbl_btnStart">–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç:</label>
            <input type="text" id="txtStart" value="–ò–ì–†–ê–¢–¨">
            
            <label data-key="lbl_win">–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã:</label>
            <input type="text" id="txtWin" value="–¢–´ –ü–û–ë–ï–î–ò–õ!">
            
            <label data-key="lbl_lose">–¢–µ–∫—Å—Ç –ø–æ—Ä–∞–∂–µ–Ω–∏—è:</label>
            <input type="text" id="txtLose" value="–í–†–ï–ú–Ø –í–´–®–õ–û">

            <label data-key="lbl_time">–í—Ä–µ–º—è (—Å):</label>
            <input type="number" id="valTime" value="60">

            <h3 style="font-size:14px; margin-top:15px; color:#fff;" data-key="sec_assets">–û–±—ä–µ–∫—Ç—ã</h3>
            <label data-key="lbl_obs">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ:</label>
            <div class="file-group">
                <input type="file" id="fObs" accept="image/*" onchange="loadAsset('obs')">
                <span id="st-obs" class="status-badge"></span>
            </div>

            <label data-key="lbl_coin">–ú–æ–Ω–µ—Ç–∞:</label>
            <div class="file-group">
                <input type="file" id="fCoin" accept="image/*" onchange="loadAsset('coin')">
                <span id="st-coin" class="status-badge"></span>
            </div>

            <label data-key="lbl_music">–ú—É–∑—ã–∫–∞:</label>
            <div class="file-group">
                <input type="file" id="fMusic" accept="audio/*" onchange="loadAsset('music', false)">
                <span id="st-music" class="status-badge"></span>
            </div>
        </div>

        <!-- Questions Bulk -->
        <div class="card full-width">
            <h2 data-key="sec_questions">‚ùì –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤</h2>
            <textarea id="bulkQuestions" class="bulk-input" data-placeholder-key="ph_bulk"></textarea>
            <div class="help-text" data-key="help_q">
                 –§–æ—Ä–º–∞—Ç: <b>–í–æ–ø—Ä–æ—Å | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç | –ù–µ–≤–µ—Ä–Ω—ã–π 1 | –ù–µ–≤–µ—Ä–Ω—ã–π 2</b><br>
                –î–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞: <b>–í–æ–ø—Ä–æ—Å | –û—Ç–≤–µ—Ç</b>
            </div>
        </div>

        <!-- Generate -->
        <div class="card full-width" style="text-align: center;">
            <button class="btn-main" onclick="generate()" data-key="btn_gen">üöÄ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
            
            <div id="copySection">
                <textarea id="finalCode" class="hidden-code"></textarea>
                <button class="btn-copy" id="copyBtn" onclick="doCopy()">
                    <span id="copyIcon">üìã</span> 
                    <span id="copyText" data-key="btn_copy">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</span>
                </button>
                <p style="color:#666; font-size:12px; margin-top:10px;" data-key="lbl_copy_hint">–í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ Genially (Insert -> Others) –∏ —Ä–∞—Å—Ç—è–Ω–∏—Ç–µ –Ω–∞ –≤–µ—Å—å —Å–ª–∞–π–¥.</p>
            </div>
        </div>
    </div>
</div>

<script>
    const assets = { bg: null, birds: [], obs: null, coin: null, music: null };
    let currentLang = 'ru';

    const pImg = { bg: new Image(), bird: new Image(), obs: new Image(), coin: new Image() };

    const dict = {
        ru: {
            title: "–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞",
            sec_visual: "üëÅÔ∏è –í–∏–∑—É–∞–ª –∏ –ê–≤–∞—Ç–∞—Ä—ã",
            lbl_bg: "–§–æ–Ω:", lbl_birds: "–ê–≤–∞—Ç–∞—Ä—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):", lbl_bird_desc: "–û–ø–∏—Å–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤ (–∫–∞–∂–¥–æ–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):",
            lbl_size: "–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞:", lbl_obj_size: "–†–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–æ–≤:", lbl_speed: "–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–ª–µ—Ç–∞:",
            sec_settings: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏",
            lbl_gameTitle: "–ó–∞–≥–æ–ª–æ–≤–æ–∫:", lbl_btnStart: "–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç:", lbl_win: "–ü–æ–±–µ–¥–∞:", lbl_lose: "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ:",
            lbl_time: "–í—Ä–µ–º—è (—Å–µ–∫):", sec_assets: "–û–±—ä–µ–∫—Ç—ã", lbl_obs: "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ:", lbl_coin: "–ú–æ–Ω–µ—Ç–∞:", lbl_music: "–ú—É–∑—ã–∫–∞:",
            sec_questions: "‚ùì –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤",
            help_q: "–§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π 1 | –ù–µ–≤–µ—Ä–Ω—ã–π 2\n–î–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ—Å—Ç–æ: –í–æ–ø—Ä–æ—Å | –û—Ç–≤–µ—Ç",
            btn_gen: "üöÄ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£", btn_copy: "–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î", btn_copied: "–°–ö–û–ü–ò–†–û–í–ê–ù–û!",
            lbl_copy_hint: "–í—Å—Ç–∞–≤—å—Ç–µ –≤ Genially (Insert -> Others) –∏ —Ä–∞—Å—Ç—è–Ω–∏—Ç–µ.",
            ph_bulk: "–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2+2? | 4 | 5 | 6\n–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏? | –ü–∞—Ä–∏–∂ | –õ–æ–Ω–¥–æ–Ω | –ë–µ—Ä–ª–∏–Ω\n–ù–∞–ø–∏—à–∏ —Å–ª–æ–≤–æ –ü—Ä–∏–≤–µ—Ç | –ü—Ä–∏–≤–µ—Ç",
            ph_avatar_desc: "–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞...\n–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ...",
            val_title: "–ü–û–õ–ï–¢ –ê–í–ê–¢–ê–†–ê", val_start: "–ò–ì–†–ê–¢–¨", val_win: "–ü–û–ë–ï–î–ê!", val_lose: "–í–†–ï–ú–Ø –í–´–®–õ–û",
            loaded: "‚úî –ó–∞–≥—Ä—É–∂–µ–Ω–æ", loaded_multi: (n) => `‚úî –ó–∞–≥—Ä—É–∂–µ–Ω–æ (${n})`
        },
        en: {
            title: "Avatar Flight",
            sec_visual: "üëÅÔ∏è Visuals & Avatars",
            lbl_bg: "Background:", lbl_birds: "Avatars (multiple allowed):", lbl_bird_desc: "Avatar descriptions (one per line):",
            lbl_size: "Avatar Size:", lbl_obj_size: "Objects Size:", lbl_speed: "Flight Speed:",
            sec_settings: "‚öôÔ∏è Settings",
            lbl_gameTitle: "Title:", lbl_btnStart: "Start Button:", lbl_win: "Win Text:", lbl_lose: "Lose Text:",
            lbl_time: "Time (s):", sec_assets: "Objects", lbl_obs: "Obstacle:", lbl_coin: "Coin:", lbl_music: "Music:",
            sec_questions: "‚ùì Questions List",
            help_q: "Format: Question | Correct | Wrong 1 | Wrong 2\nFor text input: Question | Answer",
            btn_gen: "üöÄ CREATE GAME", btn_copy: "COPY CODE", btn_copied: "COPIED!",
            lbl_copy_hint: "Paste into Genially (Insert -> Others) and stretch full screen.",
            ph_bulk: "2+2? | 4 | 5 | 6\nCapital of France? | Paris | London\nType Hello | Hello",
            ph_avatar_desc: "Description for the first avatar...\nDescription for the second...",
            val_title: "AVATAR FLIGHT", val_start: "PLAY", val_win: "YOU WON!", val_lose: "GAME OVER",
            loaded: "‚úî Loaded", loaded_multi: (n) => `‚úî Loaded (${n})`
        }
    };

    function setLang(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.dataset.key;
            if(dict[lang][key] && typeof dict[lang][key] === 'string') el.innerText = dict[lang][key];
        });
        document.querySelectorAll('[data-placeholder-key]').forEach(el => {
            const key = el.dataset.placeholderKey;
            if(dict[lang][key]) el.placeholder = dict[lang][key];
        });

        document.getElementById('btn-ru').className = lang === 'ru' ? 'active' : '';
        document.getElementById('btn-en').className = lang === 'en' ? 'active' : '';
        
        const d = dict[lang];
        document.getElementById('txtTitle').value = d.val_title;
        document.getElementById('txtStart').value = d.val_start;
        document.getElementById('txtWin').value = d.val_win;
        document.getElementById('txtLose').value = d.val_lose;
        
        // Update loaded badges text
        document.querySelectorAll('.status-badge').forEach(el => {
            if(el.classList.contains('visible') && !el.id.includes('birds')) el.innerText = d.loaded;
        });
        const birdsBadge = document.getElementById('st-birds');
        if(birdsBadge.classList.contains('visible')) {
             birdsBadge.innerText = d.loaded_multi(assets.birds.length);
        }

        const btn = document.getElementById('copyBtn');
        if(btn.className.includes('success')) {
            document.getElementById('copyText').innerText = d.btn_copied;
        } else {
            document.getElementById('copyText').innerText = d.btn_copy;
        }
    }

    function loadAsset(key, isImg=true) {
        const input = document.getElementById(`f${key.charAt(0).toUpperCase() + key.slice(1)}`);
        const badge = document.getElementById(`st-${key}`);
        
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                assets[key] = e.target.result;
                if(isImg) pImg[key].src = e.target.result;
                badge.classList.add('visible');
                badge.innerText = dict[currentLang].loaded;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function loadAvatars() {
        const input = document.getElementById('fBirds');
        const badge = document.getElementById('st-birds');
        assets.birds = [];
        if (input.files.length === 0) {
            badge.classList.remove('visible');
            pImg.bird.src = '';
            return;
        }

        let loadedCount = 0;
        for(let i=0; i < input.files.length; i++) {
            const reader = new FileReader();
            reader.onload = e => {
                assets.birds.push({ src: e.target.result, desc: '' });
                loadedCount++;
                if (loadedCount === input.files.length) {
                    badge.classList.add('visible');
                    badge.innerText = dict[currentLang].loaded_multi(loadedCount);
                    if(assets.birds.length > 0) pImg.bird.src = assets.birds[0].src;
                }
            }
            reader.readAsDataURL(input.files[i]);
        }
    }

    // --- PREVIEW ---
    const pCanvas = document.getElementById('previewCanvas');
    const pCtx = pCanvas.getContext('2d');
    let pObjs = []; let pBgY = 0; let pBgX = 0; let pFrame = 0;
    
    function initPreview() {
        if(pCanvas.parentElement) {
            pCanvas.width = pCanvas.parentElement.offsetWidth;
            pCanvas.height = pCanvas.parentElement.offsetHeight;
        }
        requestAnimationFrame(previewLoop);
    }

    function previewLoop() {
        requestAnimationFrame(previewLoop);
        if(!pCanvas.parentElement) return;
        let W = pCanvas.width = pCanvas.parentElement.offsetWidth;
        let H = pCanvas.height = pCanvas.parentElement.offsetHeight;
        pCtx.clearRect(0, 0, W, H);
        
        const speed = parseInt(document.getElementById('speedRange').value);
        const scaleUser = parseFloat(document.getElementById('sizeRange').value);
        const objScale = parseFloat(document.getElementById('objSizeRange').value);
        
        // Mock mouse for parallax
        const pMx = W / 2 + Math.sin(pFrame * 0.01) * W * 0.2;

        pBgY += speed * 0.5;
        pBgX += (W/2 - pMx) * 0.1;

        if(pImg.bg.src && pImg.bg.complete) {
            let ptrn = pCtx.createPattern(pImg.bg, 'repeat');
            pCtx.save(); pCtx.translate(pBgX, pBgY); pCtx.fillStyle = ptrn; pCtx.fillRect(-W, -H, W*2, H*2); pCtx.restore();
        } else { pCtx.fillStyle = '#000'; pCtx.fillRect(0,0,W,H); }

        if(pFrame % (60 - speed*2) === 0) {
            pObjs.push({ x: (Math.random() - 0.5) * W * 2, y: (Math.random()-0.5) * H, z: 2000, t: Math.random() > 0.5 ? 'c' : 'o' });
        }
        pObjs.sort((a,b) => b.z - a.z);

        let camOffset = (pMx - W/2) * 2;
        for(let i=pObjs.length-1; i>=0; i--) {
            let o = pObjs[i];
            o.z -= (2 + speed); 
            if(o.z < 10) { pObjs.splice(i,1); continue; }

            let scale = 500 / o.z; 
            let bob = Math.sin(o.z * 0.1 + pFrame * 0.05) * 15;
            let sx = W/2 + (o.x - camOffset) * scale;
            let sy = H/2 + (o.y + bob) * scale;
            let size = 100 * scale * objScale;
            let img = (o.t === 'c') ? pImg.coin : pImg.obs;
            if(img.src && img.complete) pCtx.drawImage(img, sx-size/2, sy-size/2, size, size);
        }

        let pSize = 100 * scaleUser;
        if(pImg.bird.src && pImg.bird.complete) {
            let tilt = (pMx - W/2) * 0.05;
            pCtx.save();
            pCtx.translate(pMx, H - pSize/2 - 20);
            pCtx.rotate(tilt * Math.PI/180);
            pCtx.drawImage(pImg.bird, -pSize/2, -pSize/2, pSize, pSize);
            pCtx.restore();
        }
        pFrame++;
    }
    
    initPreview();

    // === GENERATE ===
    function parseQuestions() {
        const raw = document.getElementById('bulkQuestions').value.trim();
        if(!raw) return [];
        return raw.split('\n').filter(line => line.trim() !== '').map(line => {
            const parts = line.split('|').map(s => s.trim());
            return parts.length > 2 
                ? { t: parts[0], type: 'choice', c: parts[1], w: parts.slice(2) }
                : { t: parts[0], type: 'input', c: parts[1] };
        });
    }

    function generate() {
        const descriptions = document.getElementById('txtAvatarDescriptions').value.trim().split('\n');
        assets.birds.forEach((bird, i) => {
            bird.desc = descriptions[i] || '';
        });

        const questions = parseQuestions();
        const CONFIG = {
            title: document.getElementById('txtTitle').value,
            btn: document.getElementById('txtStart').value,
            win: document.getElementById('txtWin').value,
            lose: document.getElementById('txtLose').value,
            time: document.getElementById('valTime').value,
            speed: document.getElementById('speedRange').value,
            scale: document.getElementById('sizeRange').value,
            objScale: document.getElementById('objSizeRange').value,
            qs: questions,
            img: assets
        };

        const CODE = `
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; }
    body { font-family:'Segoe UI',sans-serif; user-select:none; -webkit-user-select:none; }
    #game-box { position:absolute; top:0; left:0; width:100%; height:100%; overflow:hidden; touch-action: none; }
    canvas { display:block; width:100%; height:100%; }
    .hud { position:absolute; top:10px; color:#00d2ff; font-size:clamp(20px, 4vw, 30px); font-weight:bold; text-shadow:2px 2px 0 #000; padding:5px 15px; background:rgba(0,0,0,0.6); border-radius:10px; border:1px solid #00d2ff; z-index: 50; }
    .screen { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100; pointer-events:auto; transition: opacity 0.5s; }
    h1 { color:#00d2ff; font-size:clamp(30px, 6vw, 60px); text-transform:uppercase; text-shadow:0 0 20px #00d2ff; margin-bottom:20px; text-align:center; padding: 0 10px; }
    button.btn-play { background: linear-gradient(180deg, #00d2ff, #0088aa); border: 4px solid #fff; padding: 15px 60px; color: #fff; font-size: clamp(24px, 5vw, 40px); font-weight: bold; text-transform: uppercase; border-radius: 60px; cursor: pointer; box-shadow: 0 0 30px #00d2ff; transition: transform 0.1s; text-shadow: 1px 1px 2px #000; }
    button.btn-play:hover { transform: scale(1.05); } button.btn-play:active { transform: scale(0.95); }
    #quiz-box { display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:500px; background: rgba(30, 41, 59, 0.95); border:3px solid #00d2ff; padding:20px; border-radius:15px; text-align:center; color:#fff; z-index:200; pointer-events: auto; box-shadow: 0 0 50px #000; backdrop-filter: blur(5px); }
    .q-btn { display:block; width:100%; padding:15px; margin:8px 0; background:#334; border:1px solid #556; color:#fff; font-size:18px; cursor:pointer; } .q-btn:hover { background:#00d2ff; color:#000; }
    input.q-inp { width:80%; padding:10px; font-size:20px; text-align:center; margin-bottom:10px; color:#000; }
    /* Avatar Selection */
    #scr-select { justify-content: start; padding-top: 20px; }
    #avatar-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-height: 80vh; overflow-y: auto; }
    .avatar-choice { width: 120px; height: 120px; border: 3px solid #00d2ff; border-radius: 10px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .avatar-choice:hover { transform: scale(1.1); box-shadow: 0 0 20px #00d2ff; }
    /* Avatar Viewer */
    #avatar-viewer { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:300; display:none; flex-direction:column; align-items:center; justify-content:center; }
    #viewer-container { width: 95%; height: 70%; max-width: 800px; max-height: 80vh; border: 2px solid #00d2ff; overflow: hidden; position: relative; cursor: grab; }
    #viewer-img { position:absolute; width:100%; height:auto; transform-origin: center center; transition: transform 0.1s linear; }
    #viewer-desc { background: rgba(0,0,0,0.7); color: #fff; padding: 15px; margin-top: 10px; border-radius: 5px; max-width: 80%; text-align: center; }
    #viewer-btn { margin-top: 15px; }
</style>
</head>
<body>
<div id="game-box">
    <div class="hud" style="left:10px">‚è± <span id="ui-time">0</span></div>
    <div class="hud" style="right:10px">üèÜ <span id="ui-score">0</span></div>
    <canvas id="cvs"></canvas>

    <div id="scr-select" class="screen"><h1 data-key="title_select">–í—ã–±–µ—Ä–∏—Ç–µ –ê–≤–∞—Ç–∞—Ä–∞</h1><div id="avatar-grid"></div></div>
    <div id="scr-start" class="screen" style="opacity:0; pointer-events:none;"><h1 id="mt-title"></h1><button class="btn-play" id="btn-start"></button></div>
    <div id="scr-end" class="screen" style="display:none"><h1 id="mt-end"></h1><p style="color:#fff; font-size:30px">Score: <span id="end-score">0</span></p><button class="btn-play" onclick="location.reload()">‚Ü∫</button></div>
    <div id="quiz-box"><h2 id="q-txt"></h2><div id="q-body"></div></div>
    
    <div id="avatar-viewer">
        <div id="viewer-container"><img id="viewer-img" draggable="false"></div>
        <p id="viewer-desc"></p>
        <button id="viewer-btn" class="btn-play" data-key="btn_select">–í—ã–±—Ä–∞—Ç—å</button>
    </div>
</div>

<script>
const CFG = ${JSON.stringify(CONFIG)};
const IMG = CFG.img;

document.getElementById('mt-title').innerText = CFG.title;
document.getElementById('btn-start').innerText = CFG.btn;

const cvs = document.getElementById('cvs'), ctx = cvs.getContext('2d');
let W, H;
const iBg=new Image(), iBird=new Image(), iObs=new Image(), iCoin=new Image();
if(IMG.bg) iBg.src = IMG.bg; if(IMG.obs) iObs.src = IMG.obs; if(IMG.coin) iCoin.src = IMG.coin;
let music = null; if(IMG.music) { music = new Audio(IMG.music); music.loop=true; music.volume=0.4; }

const AC = new (window.AudioContext || window.webkitAudioContext)();
function sfx(type){ if(AC.state === 'suspended') AC.resume(); const o=AC.createOscillator(),g=AC.createGain(),t=AC.currentTime; o.connect(g);g.connect(AC.destination); if(type==='coin'){o.type='sine';o.frequency.setValueAtTime(1200,t);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.start(t);o.stop(t+0.5)}else if(type==='boom'){o.type='sawtooth';o.frequency.setValueAtTime(100,t);o.frequency.exponentialRampToValueAtTime(10,t+0.3);g.gain.setValueAtTime(0.3,t);g.gain.linearRampToValueAtTime(0,t+0.3);o.start(t);o.stop(t+0.3)}else if(type==='win'){o.type='triangle';o.frequency.setValueAtTime(523,t);o.frequency.linearRampToValueAtTime(1000,t+0.3);g.gain.setValueAtTime(0.1,t);g.gain.linearRampToValueAtTime(0,t+0.6);o.start(t);o.stop(t+0.6)}else if(type==='lose'){o.type='triangle';o.frequency.setValueAtTime(300,t);o.frequency.linearRampToValueAtTime(100,t+0.4);g.gain.setValueAtTime(0.2,t);g.gain.linearRampToValueAtTime(0,t+0.4);o.start(t);o.stop(t+0.4)}}

const GM = {
    run: false, pause: false, frame: 0,
    time: parseInt(CFG.time), score: 0, objs: [], mx: 0, my: 0, 
    bgX: 0, bgY: 0, hurt: 0, timerInt: null,
    
    init: () => {
        const grid = document.getElementById('avatar-grid');
        if (!IMG.birds || IMG.birds.length === 0) { GM.selectAvatar(null); return; }
        IMG.birds.forEach((avatar, i) => {
            const div = document.createElement('div');
            div.className = 'avatar-choice';
            div.style.backgroundImage = \`url(\${avatar.src})\`;
            div.onclick = () => GM.viewAvatar(i);
            grid.appendChild(div);
        });
    },
    
    viewAvatar: (index) => {
        const viewer = document.getElementById('avatar-viewer');
        const img = document.getElementById('viewer-img');
        const desc = document.getElementById('viewer-desc');
        const avatar = IMG.birds[index];
        
        img.src = avatar.src;
        desc.innerText = avatar.desc;
        viewer.style.display = 'flex';
        document.getElementById('viewer-btn').onclick = () => GM.selectAvatar(index);

        // Pan & Zoom logic
        let scale = 1, panning = false, pointX = 0, pointY = 0, start = { x: 0, y: 0 };
        const setTransform = () => img.style.transform = \`translate(\${pointX}px, \${pointY}px) scale(\${scale})\`;
        img.onload = () => { scale = 1; pointX = 0; pointY = 0; setTransform(); };
        
        const container = document.getElementById('viewer-container');
        container.onmousedown = (e) => { e.preventDefault(); start = { x: e.clientX - pointX, y: e.clientY - pointY }; panning = true; container.style.cursor = 'grabbing'; };
        container.onmouseup = () => { panning = false; container.style.cursor = 'grab';};
        container.onmouseleave = () => { panning = false; container.style.cursor = 'grab'; };
        container.onmousemove = (e) => { if (!panning) return; e.preventDefault(); pointX = (e.clientX - start.x); pointY = (e.clientY - start.y); setTransform(); };
        container.onwheel = (e) => { e.preventDefault(); let xs = (e.clientX - pointX) / scale, ys = (e.clientY - pointY) / scale, delta = -e.deltaY; scale *= (delta > 0) ? 1.1 : 0.9; scale = Math.min(Math.max(1, scale), 5); pointX = e.clientX - xs * scale; pointY = e.clientY - ys * scale; setTransform(); };
    },

    selectAvatar: (index) => {
        document.getElementById('avatar-viewer').style.display = 'none';
        document.getElementById('scr-select').style.display = 'none';
        
        if (index !== null && IMG.birds[index]) iBird.src = IMG.birds[index].src;
        else if (IMG.bird) iBird.src = IMG.bird; // Fallback for old config
        
        const scrStart = document.getElementById('scr-start');
        scrStart.style.opacity = '1';
        scrStart.style.pointerEvents = 'auto';
    },

    start: () => {
        document.getElementById('scr-start').style.display = 'none';
        resize(); GM.mx = W/2;
        if(AC.state === 'suspended') AC.resume(); if(music) music.play().catch(e=>{});
        GM.run = true;
        
        // Pre-generate all objects
        GM.objs = [];
        const numCoins = CFG.qs.length;
        const numObs = numCoins * 2;
        let objTypes = Array(numCoins).fill('c').concat(Array(numObs).fill('o'));
        for(let i = objTypes.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [objTypes[i], objTypes[j]] = [objTypes[j], objTypes[i]]; } // Shuffle
        
        for(let i=0; i<objTypes.length; i++) {
            GM.objs.push({
                t: objTypes[i],
                x: (Math.random() - 0.5) * W * 4,
                y: (Math.random() - 0.5) * H * 1.5,
                z: 2000 + (i * (40000 / objTypes.length)) + (Math.random()-0.5) * 100
            });
        }
        
        loop();
        GM.timerInt = setInterval(() => { if(GM.run && !GM.pause) { GM.time--; document.getElementById('ui-time').innerText = GM.time; if(GM.time <= 0) GM.end(false); }}, 1000);
        document.getElementById('ui-time').innerText = GM.time;
    },

    end: (win) => {
        GM.run = false; clearInterval(GM.timerInt);
        document.getElementById('scr-end').style.display = 'flex';
        document.getElementById('mt-end').innerText = win ? CFG.win : CFG.lose;
        document.getElementById('mt-end').style.color = win ? '#0f0' : '#f00';
        document.getElementById('end-score').innerText = GM.score;
        sfx(win?'win':'lose');
    }
};

document.getElementById('btn-start').addEventListener('click', GM.start);
window.addEventListener('resize', resize);
window.addEventListener('mousemove', e => { GM.mx = e.clientX; });
window.addEventListener('touchmove', e => { e.preventDefault(); GM.mx = e.touches[0].clientX; }, {passive:false});

function resize() { W = cvs.width = window.innerWidth; H = cvs.height = window.innerHeight; if(!GM.run) GM.mx = W/2; }

function loop() {
    if(!GM.run) return; requestAnimationFrame(loop);
    ctx.clearRect(0,0,W,H); if(GM.pause) return; 

    GM.bgY += parseInt(CFG.speed) * 0.5; GM.bgX += (W/2 - GM.mx) * 0.05;
    if(iBg.src && iBg.complete) { let ptrn = ctx.createPattern(iBg, 'repeat'); if(ptrn) { ctx.save(); ctx.translate(GM.bgX, GM.bgY); ctx.fillStyle = ptrn; ctx.fillRect(-W, -H, W*2, H*2); ctx.restore(); }}

    GM.objs.sort((a,b) => b.z - a.z);
    let objScaleUser = parseFloat(CFG.objScale || 1.0);
    let speed = parseInt(CFG.speed);
    let camOffset = (GM.mx - W/2) * 2;
    let pSize = 100 * parseFloat(CFG.scale);

    for(let i=GM.objs.length-1; i>=0; i--) {
        let o = GM.objs[i];
        o.z -= (2 + speed); if(o.z < 10) { GM.objs.splice(i,1); continue; }
        
        let scale = 500 / o.z;
        let bob = Math.sin(o.z * 0.01 + GM.frame * 0.03) * 20;
        let sx = W/2 + (o.x - camOffset) * scale;
        let sy = H/2 + (o.y + bob) * scale;
        let size = 100 * scale * objScaleUser;
        let img = (o.t==='c') ? iCoin : iObs;
        if(img.src) ctx.drawImage(img, sx-size/2, sy-size/2, size, size);

        if(o.z < 200 && o.z > 20) {
            let avatarY = H - pSize/2 - 20;
            let dist = Math.hypot(sx - GM.mx, sy - avatarY);
            if(dist < (size * 0.5) + (pSize * 0.5)) { GM.objs.splice(i,1); hit(o.t); }
        }
    }
    
    if(GM.hurt > 0) { GM.hurt--; if(Math.floor(GM.hurt/5)%2===0) return; }
    if(iBird.src) { let tilt = (GM.mx - W/2) * 0.05; ctx.save(); ctx.translate(GM.mx, H - pSize/2 - 20); ctx.rotate(tilt*Math.PI/180); ctx.drawImage(iBird, -pSize/2, -pSize/2, pSize, pSize); ctx.restore(); }
    GM.frame++;
}

function hit(type) {
    if(type === 'o') { sfx('boom'); GM.hurt = 30; GM.time = Math.max(0, GM.time - 5); } 
    else { sfx('coin'); if(CFG.qs.length > 0) { GM.pause = true; quiz(); } else { GM.score++; } }
    document.getElementById('ui-time').innerText = GM.time; document.getElementById('ui-score').innerText = GM.score;
}

function quiz() {
    let q = CFG.qs[GM.score % CFG.qs.length]; // Cycle through questions
    let box = document.getElementById('quiz-box'), body = document.getElementById('q-body');
    document.getElementById('q-txt').innerText = q.t; body.innerHTML = ''; box.style.display = 'block';

    const processAns = (txt) => {
        box.style.display = 'none';
        if(txt.trim().toLowerCase() === q.c.trim().toLowerCase()) { sfx('win'); GM.score++; } 
        else { sfx('lose'); GM.time = Math.max(0, GM.time - 10); }
        document.getElementById('ui-score').innerText = GM.score; document.getElementById('ui-time').innerText = GM.time;
        setTimeout(() => { GM.pause = false; }, 200);
    };

    if(q.type === 'choice') {
        let arr = [q.c, ...q.w].sort(()=>Math.random()-0.5);
        arr.forEach(t => { let b = document.createElement('button'); b.className='q-btn'; b.innerText=t; b.onclick = (e)=>{e.stopPropagation();processAns(t)}; body.appendChild(b); });
    } else {
        let inp = document.createElement('input'); inp.className='q-inp';
        let b = document.createElement('button'); b.className='q-btn'; b.innerText='OK';
        b.onclick = (e) => { e.stopPropagation(); processAns(inp.value); };
        body.appendChild(inp); body.appendChild(b); inp.focus();
    }
}

// Init
resize();
GM.init();
<\/script>
</body>
</html>`;
        document.getElementById('finalCode').value = CODE;
        document.getElementById('copySection').style.display = 'block';
    }

    function doCopy() {
        const txt = document.getElementById('finalCode');
        txt.select(); document.execCommand('copy');
        const btn = document.getElementById('copyBtn'), span = document.getElementById('copyText'), icon = document.getElementById('copyIcon');
        btn.classList.add('success'); span.innerText = dict[currentLang].btn_copied; icon.innerText = "‚úÖ";
        setTimeout(() => { btn.classList.remove('success'); span.innerText = dict[currentLang].btn_copy; icon.innerText = "üìã"; }, 3000);
    }
    
    setLang('ru');
</script>
</body>
</html>
