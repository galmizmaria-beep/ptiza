<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞ ‚Äî Genially friendly</title>
<style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; }
    body { font-family:'Segoe UI',sans-serif; user-select:none; -webkit-user-select:none; }
    #game-box { position:absolute; top:0; left:0; width:100%; height:100%; overflow:hidden; touch-action: none; }
    canvas { display:block; width:100%; height:100%; pointer-events:none; }

    .hud { position:absolute; top:10px; color:#00d2ff; font-size:clamp(20px, 4vw, 30px); font-weight:bold; text-shadow:2px 2px 0 #000; padding:5px 15px; background:rgba(0,0,0,0.6); border-radius:10px; border:1px solid #00d2ff; z-index: 50; }
    .screen { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100; pointer-events:auto; }
    h1 { color:#00d2ff; font-size:clamp(30px, 6vw, 60px); text-transform:uppercase; text-shadow:0 0 20px #00d2ff; margin-bottom:20px; text-align:center; }
    button.btn-play {
        background: linear-gradient(180deg, #00d2ff, #0088aa);
        border: 4px solid #fff; padding: 15px 60px;
        color: #fff; font-size: clamp(24px, 5vw, 40px); font-weight: bold; text-transform: uppercase;
        border-radius: 60px; cursor: pointer; box-shadow: 0 0 30px #00d2ff;
        transition: transform 0.1s; text-shadow: 1px 1px 2px #000;
        z-index: 200; pointer-events: auto;
    }
    button.btn-play:hover { transform: scale(1.05); background: #fff; color: #0088aa; }
    #quiz-box {
        display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
        width:90%; max-width:500px;
        background: rgba(30, 41, 59, 0.95); border:3px solid #00d2ff; padding:20px; border-radius:15px; text-align:center; color:#fff; z-index:200;
        pointer-events: auto !important; box-shadow: 0 0 50px #000; backdrop-filter: blur(5px);
    }
    .q-btn { display:block; width:100%; padding:15px; margin:8px 0; background:#334; border:1px solid #556; color:#fff; font-size:18px; cursor:pointer; z-index:201; position:relative; }
    .q-btn:hover { background:#00d2ff; color:#000; }
    input.q-inp { width:80%; padding:10px; font-size:20px; text-align:center; margin-bottom:10px; color:#000; }
</style>
</head>
<body>
<div id="game-box">
    <div class="hud" style="left:10px">‚è± <span id="ui-time">0</span></div>
    <div class="hud" style="right:10px">üèÜ <span id="ui-score">0</span></div>

    <canvas id="cvs"></canvas>

    <div id="scr-start" class="screen">
        <h1 id="mt-title">TITLE</h1>
        <button class="btn-play" id="btn-start">START</button>
        <div id="start-hint" style="margin-top:10px;color:#ccc;font-size:14px;"></div>
    </div>

    <div id="scr-end" class="screen" style="display:none">
        <h1 id="mt-end">END</h1>
        <p style="color:#fff; font-size:30px">Score: <span id="end-score">0</span></p>
        <button class="btn-play" id="btn-restart">‚Ü∫</button>
    </div>

    <div id="quiz-box">
        <h2 id="q-txt" style="color:#00d2ff; margin-top:0">Question</h2>
        <div id="q-body"></div>
    </div>
</div>

<script>
/*
  This is the single-file game build with Genially integration fixes:
  - Proper canvas sizing with devicePixelRatio (high-DPI)
  - Heuristics to detect Genially Editor vs Present/Viewer
  - Autostart disabled inside Genially editor; start via button
  - Images use onload to trigger redraw/resizing
*/

/* -------------------- Genially context detection -------------------- */
function isLikelyGeniallyEditor() {
    try {
        return /app\.genially\.com\/editor/.test(document.referrer) || /\/editor(\/|$)/.test(window.location.href);
    } catch(e) { return false; }
}
function isLikelyGeniallyPresent() {
    try {
        return /app\.genially\.com\/viewer|\/present|\/p\//.test(window.location.href) || /app\.genially\.com\/viewer/.test(document.referrer);
    } catch(e) { return false; }
}
const IN_GENIALLY_EDITOR = isLikelyGeniallyEditor();
const IN_GENIALLY_PRESENT = isLikelyGeniallyPresent();

/* -------------------- Configuration (placeholder) -------------------- */
/* CFG and IMG will be injected by the generator. If you paste this file,
   make sure to replace the CFG/IMG variables with actual values or inject
   them from the outer generator like before. For convenience in standalone
   mode, below we try to use a window-provided CFG if exists. */
const CFG = window.__CFG__ || {
    title: "–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞",
    btn: "START",
    win: "YOU WON",
    lose: "GAME OVER",
    time: 60,
    speed: 3,
    scale: 1.0,
    objScale: 1.0,
    qs: [],
    img: {} // img keys: bg, bird, obs, coin, music (data URLs or remote)
};
const IMG = CFG.img || {};

/* -------------------- Elements & Canvas (DPR-aware) -------------------- */
const container = document.getElementById('game-box');
const cvs = document.getElementById('cvs');
const ctx = cvs.getContext('2d');
let W = 800, H = 600;

/* Provide GM object used across game logic */
const GM = {
    run: false,
    pause: false,
    frame: 0,
    time: parseInt(CFG.time) || 60,
    score: 0,
    objs: [],
    mx: 0, my: 0,
    bgX: 0, bgY: 0,
    hurt: 0,
    timerInt: null,
    start: function(){ console.warn('GM.start not yet implemented'); },
    reset: function(){ console.warn('GM.reset not yet implemented'); }
};

/* DPR-aware size setter */
function setCanvasSize() {
    if(!cvs || !ctx) return;
    const dpr = window.devicePixelRatio || 1;
    const cw = Math.max(1, container.clientWidth || window.innerWidth);
    const ch = Math.max(1, container.clientHeight || window.innerHeight);

    // Visible (CSS) size
    cvs.style.width = cw + 'px';
    cvs.style.height = ch + 'px';

    // Real internal pixel size
    cvs.width = Math.floor(cw * dpr);
    cvs.height = Math.floor(ch * dpr);

    // Make drawing calls use CSS pixel coordinates by applying DPR transform
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    // Update logical sizes used in game code (CSS coordinates)
    W = cw;
    H = ch;

    if(!GM.run) { GM.mx = W/2; GM.my = H/2; }
}

/* Call initially and on resize */
window.addEventListener('resize', setCanvasSize);
setTimeout(setCanvasSize, 50);

/* -------------------- Assets (with onload hooks) -------------------- */
const iBg = new Image();
const iBird = new Image();
const iObs = new Image();
const iCoin = new Image();
let music = null;

if(IMG.bg) { iBg.src = IMG.bg; }
if(IMG.bird) { iBird.src = IMG.bird; }
if(IMG.obs) { iObs.src = IMG.obs; }
if(IMG.coin) { iCoin.src = IMG.coin; }
if(IMG.music) { music = new Audio(IMG.music); music.loop = true; music.volume = 0.4; }

// When images load, ensure we recalc canvas and redraw so patterns appear immediately
[iBg, iBird, iObs, iCoin].forEach(img => {
    if(!img) return;
    img.onload = function() {
        // small timeout to ensure layout stabilized in hosts like Genially
        setTimeout(() => {
            try { setCanvasSize(); } catch(e) {}
        }, 20);
    };
});

/* -------------------- UI setup -------------------- */
document.getElementById('mt-title').innerText = CFG.title || "GAME";
document.getElementById('btn-start').innerText = CFG.btn || "START";
document.getElementById('btn-restart').addEventListener('click', function(){ GM.reset(); });

/* If we are in Genially editor, show hint that auto-start is disabled */
if(IN_GENIALLY_EDITOR) {
    const hint = document.getElementById('start-hint');
    if(hint) hint.innerText = "Editor preview ‚Äî –Ω–∞–∂–º–∏—Ç–µ START, —á—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–¥–µ—Å—å. –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –æ—Ç–∫–ª—é—á—ë–Ω –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ.";
}

/* -------------------- Sound helper -------------------- */
const AC = new (window.AudioContext || window.webkitAudioContext)();
function sfx(type) {
    try {
        if(AC.state === 'suspended') AC.resume();
    } catch(e){}
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.connect(g); g.connect(AC.destination);
    const t = AC.currentTime;

    if(type === 'coin') {
        o.type = 'sine'; o.frequency.setValueAtTime(1200, t);
        g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.5);
        o.start(t); o.stop(t+0.5);
    } else if(type === 'boom') {
        o.type = 'sawtooth'; o.frequency.setValueAtTime(100, t); o.frequency.exponentialRampToValueAtTime(10, t+0.3);
        g.gain.setValueAtTime(0.3, t); g.gain.linearRampToValueAtTime(0, t+0.3);
        o.start(t); o.stop(t+0.3);
    } else if(type === 'win') {
        o.type = 'triangle'; o.frequency.setValueAtTime(523, t); o.frequency.linearRampToValueAtTime(1000, t+0.3);
        g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.6);
        o.start(t); o.stop(t+0.6);
    } else if(type === 'lose') {
        o.type = 'triangle'; o.frequency.setValueAtTime(300, t); o.frequency.linearRampToValueAtTime(100, t+0.4);
        g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.4);
        o.start(t); o.stop(t+0.4);
    }
}

/* -------------------- Core game logic (adapted from your code) -------------------- */

/* initialize GM.start and GM.reset implementations */
GM.start = function() {
    document.getElementById('scr-start').style.display = 'none';
    setCanvasSize();
    GM.mx = W/2; GM.my = H/2;
    try { if(AC.state === 'suspended') AC.resume(); } catch(e){}
    if(music) music.play().catch(()=>{});
    GM.run = true;
    GM.objs = [];
    GM.frame = 0;
    GM.time = parseInt(CFG.time) || GM.time;
    GM.timerInt = setInterval(() => {
        if(GM.run && !GM.pause) {
            GM.time--;
            document.getElementById('ui-time').innerText = GM.time;
            if(GM.time <= 0) GM.end(false);
        }
    }, 1000);
    document.getElementById('ui-time').innerText = GM.time;
    // start loop
    requestAnimationFrame(loop);
};

GM.reset = function() {
    clearInterval(GM.timerInt);
    GM.run = false;
    GM.pause = false;
    GM.score = 0;
    GM.time = parseInt(CFG.time) || 60;
    GM.objs = [];
    GM.frame = 0;
    document.getElementById('ui-score').innerText = "0";
    document.getElementById('ui-time').innerText = GM.time;
    document.getElementById('scr-end').style.display = 'none';
    document.getElementById('scr-start').style.display = 'flex';
    document.getElementById('quiz-box').style.display = 'none';
};

/* Called when game ends */
GM.end = function(win) {
    GM.run = false;
    clearInterval(GM.timerInt);
    document.getElementById('scr-end').style.display = 'flex';
    document.getElementById('mt-end').innerText = win ? CFG.win : CFG.lose;
    document.getElementById('mt-end').style.color = win ? '#0f0' : '#f00';
    document.getElementById('end-score').innerText = GM.score;
    sfx(win ? 'win' : 'lose');
};

/* input handlers (mouse/touch) */
window.addEventListener('mousemove', e => { GM.mx = e.clientX; GM.my = e.clientY; });
window.addEventListener('touchmove', e => {
    if(!e.touches || !e.touches[0]) return;
    GM.mx = e.touches[0].clientX; GM.my = e.touches[0].clientY;
    e.preventDefault();
}, {passive:false});

/* Hook start button; it's a user gesture so audio autoplay won't be blocked */
document.getElementById('btn-start').addEventListener('click', () => { GM.start(); });

/* Optional: Auto-start when embedded in Genially Present (viewer) ‚Äî disabled by default.
   If you want the game to auto-start when Genially opens Present/view mode, uncomment below.
   Note: browsers may still block audio until a user gesture happens. */
if(IN_GENIALLY_PRESENT && !IN_GENIALLY_EDITOR) {
    // GM.start(); // <-- enable if you want auto-start in Present mode
}

/* -------------------- Main loop (drawing & gameplay) -------------------- */
function loop() {
    if(!GM.run) return;
    requestAnimationFrame(loop);

    // clear in CSS pixels
    ctx.clearRect(0,0,W,H);
    if(GM.pause) return;

    // 1. Background infinite movement
    let dx = (W/2 - GM.mx) * 0.1;
    let dy = (H/2 - GM.my) * 0.05;
    GM.bgX += dx;
    GM.bgY += parseInt(CFG.speed || 3) + dy;

    if(iBg.src && iBg.complete && iBg.width > 0) {
        let ptrn = ctx.createPattern(iBg, 'repeat');
        if(ptrn) {
            ctx.save();
            ctx.translate(GM.bgX, GM.bgY);
            ctx.fillStyle = ptrn;
            ctx.fillRect(-W*5, -H*5, W*10, H*10);
            ctx.restore();
        }
    } else {
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,W,H);
    }

    // 2. Spawn objects
    if(GM.frame % Math.max(6, (60 - parseInt(CFG.speed || 3)*2)) === 0) {
        let isCoin = (CFG.qs && CFG.qs.length > 0 && Math.random() > 0.6);
        let sX = (Math.random()-0.5) * W * 3;
        let sY = (Math.random()-0.5) * H * 1.5;
        GM.objs.push({ x: sX, y: sY, z: 2000, t: isCoin ? 'c' : 'o' });
    }

    // 3. Draw objects (perspective)
    GM.objs.sort((a,b) => b.z - a.z);
    let objScaleUser = parseFloat(CFG.objScale || 1.0);
    let speed = parseInt(CFG.speed || 3);
    let camOffset = (GM.mx - W/2) * 2;

    for(let i=0;i<GM.objs.length;i++){
        let o = GM.objs[i];
        o.z -= (2 + speed);
        if(o.z < 10) { GM.objs.splice(i,1); i--; continue; }

        let scale = 500 / o.z;
        let sx = W/2 + (o.x - camOffset) * scale;
        let sy = H/2 + o.y * scale;
        let size = 100 * scale * objScaleUser;
        let img = (o.t === 'c') ? iCoin : iObs;

        if(img && img.src && img.complete && img.width > 0) {
            if(o.t === 'c') {
                let spin = Math.abs(Math.sin(GM.frame * 0.1 + i));
                let w = size * spin;
                ctx.drawImage(img, sx - w/2, sy - size/2, w, size);
            } else {
                ctx.drawImage(img, sx-size/2, sy-size/2, size, size);
            }
        }

        // Hit detection
        if(o.z < 200 && o.z > 20) {
            let dist = Math.hypot(sx - GM.mx, sy - GM.my);
            let hitbox = (size * 0.6) + (60 * parseFloat(CFG.scale || 1.0));
            if(dist < hitbox) {
                GM.objs.splice(i,1); i--;
                hit(o.t);
            }
        }
    }

    // 4. Draw bird (avatar)
    if(GM.hurt > 0) {
        GM.hurt--;
        if(Math.floor(GM.hurt / 5) % 2 === 0) return;
    }

    let pSize = 120 * parseFloat(CFG.scale || 1.0);
    if(iBird.src && iBird.complete && iBird.width > 0) {
        let tilt = (GM.mx - W/2) * 0.05;
        ctx.save();
        ctx.translate(GM.mx, GM.my);
        ctx.rotate(tilt * Math.PI/180);
        ctx.drawImage(iBird, -pSize/2, -pSize/2, pSize, pSize);
        ctx.restore();
    } else {
        ctx.fillStyle = '#0ff'; ctx.beginPath(); ctx.arc(GM.mx, GM.my, 20, 0, Math.PI*2); ctx.fill();
    }

    GM.frame++;
}

/* -------------------- hit & quiz logic -------------------- */
function hit(type) {
    if(type === 'o') {
        sfx('boom');
        GM.hurt = 30;
        let f = document.createElement('div');
        f.style = "position:absolute;top:0;left:0;width:100%;height:100%;background:red;opacity:0.5;pointer-events:none;z-index:99";
        document.body.appendChild(f);
        setTimeout(()=>f.remove(), 100);
        GM.time -= 5;
        document.getElementById('ui-time').innerText = GM.time;
        if(GM.time <= 0) GM.end(false);
    } else {
        sfx('coin');
        if(CFG.qs && CFG.qs.length > 0) {
            GM.pause = true;
            quiz();
        } else {
            GM.score++;
            document.getElementById('ui-score').innerText = GM.score;
        }
    }
}

function quiz() {
    if(!CFG.qs || CFG.qs.length === 0) {
        GM.pause = false;
        return;
    }
    let idx = Math.floor(Math.random() * CFG.qs.length);
    let q = CFG.qs[idx];

    let box = document.getElementById('quiz-box');
    let body = document.getElementById('q-body');
    document.getElementById('q-txt').innerText = q.t;
    body.innerHTML = '';
    box.style.display = 'block';

    const processAns = (txt) => {
        box.style.display = 'none';
        if(String(txt).trim().toLowerCase() === String(q.c).trim().toLowerCase()) {
            sfx('win'); GM.score++;
        } else {
            sfx('lose'); GM.time -= 10;
        }
        document.getElementById('ui-score').innerText = GM.score;
        document.getElementById('ui-time').innerText = GM.time;
        setTimeout(()=>{ GM.pause = false; }, 200);
    };

    if(q.type === 'choice') {
        let arr = [q.c, ...(q.w||[])].sort(()=>Math.random()-0.5);
        arr.forEach(t => {
            let b = document.createElement('button');
            b.className = 'q-btn';
            b.innerText = t;
            b.onclick = (e) => { e.stopPropagation(); processAns(t); };
            body.appendChild(b);
        });
    } else {
        let inp = document.createElement('input');
        inp.className = 'q-inp';
        let b = document.createElement('button');
        b.className = 'q-btn';
        b.innerText = 'OK';
        b.onclick = (e) => { e.stopPropagation(); processAns(inp.value); };
        body.appendChild(inp); body.appendChild(b);
        inp.focus();
    }
}

/* -------------------- Ensure initial sizing and draw (preview) -------------------- */
setTimeout(setCanvasSize, 100);
</script>
</body>
</html>
