<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Конструктор игры</title>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#0f172a;
    color:#fff;
}

#editor{
    width:400px;
    height:100vh;
    overflow:auto;
    padding:20px;
    box-sizing:border-box;
    background:#111827;
    float:left;
}

#preview{
    margin-left:400px;
    height:100vh;
    background:#000;
    position:relative;
}

canvas{
    display:block;
}

input,textarea,select,button{
    width:100%;
    margin-bottom:10px;
    padding:6px;
    box-sizing:border-box;
}

button{
    background:#2563eb;
    border:none;
    color:#fff;
    cursor:pointer;
}

button:hover{
    background:#1d4ed8;
}

#quiz-box{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.55);
    backdrop-filter:blur(8px);
    padding:20px;
    display:none;
}
</style>
</head>

<body>

<div id="editor">
<h2>Редактор</h2>

<label>Фон</label>
<input type="file" id="bgInput">

<label>Монета</label>
<input type="file" id="coinInput">

<label>Препятствие</label>
<input type="file" id="obsInput">

<label>Скорость</label>
<input type="range" id="speed" min="1" max="10" value="3">

<label>Размер объектов</label>
<input type="range" id="objScale" min="0.5" max="2" step="0.1" value="1">

<label>Задания (вопрос|ответ)</label>
<textarea id="questions" rows="6"></textarea>

<button onclick="generate()">Сгенерировать</button>
</div>

<div id="preview">
<canvas id="pCanvas"></canvas>
<div id="quiz-box"></div>
</div>

<script>
const pCanvas = document.getElementById("pCanvas");
const pCtx = pCanvas.getContext("2d");

let W,H;

function resize(){
    W = pCanvas.width = window.innerWidth - 400;
    H = pCanvas.height = window.innerHeight;
}
window.onresize = resize;
resize();

let pImg = {
    bg:new Image(),
    coin:new Image(),
    obs:new Image()
};

bgInput.onchange = e=>{
    pImg.bg.src = URL.createObjectURL(e.target.files[0]);
};
coinInput.onchange = e=>{
    pImg.coin.src = URL.createObjectURL(e.target.files[0]);
};
obsInput.onchange = e=>{
    pImg.obs.src = URL.createObjectURL(e.target.files[0]);
};

let pBgX=0,pBgY=0;
let pFrame=0;

function previewLoop(){
    requestAnimationFrame(previewLoop);
    pFrame++;    pCtx.clearRect(0,0,W,H);

    // бесконечный фон в preview
    if(pImg.bg.src && pImg.bg.complete && pImg.bg.width>0){
        let bw=pImg.bg.width;
        let bh=pImg.bg.height;

        let offsetX=pBgX % bw;
        let offsetY=pBgY % bh;

        for(let x=-bw;x<W+bw;x+=bw){
            for(let y=-bh;y<H+bh;y+=bh){
                pCtx.drawImage(pImg.bg,x+offsetX,y+offsetY,bw,bh);
            }
        }
    }else{
        pCtx.fillStyle="#000";
        pCtx.fillRect(0,0,W,H);
    }

    pBgX-=0.5;
    pBgY-=0.2;

    // простые демонстрационные объекты
    if(pImg.coin.complete){
        pCtx.drawImage(pImg.coin,W/2-40,H/2-40,80,80);
    }

    if(pImg.obs.complete){
        pCtx.drawImage(pImg.obs,W/2+120,H/2-40,80,80);
    }

}
previewLoop();

function parseQuestions(){
    let raw=document.getElementById("questions").value.trim();
    if(!raw)return [];
    return raw.split("\n").map(l=>{
        let parts=l.split("|");
        return {q:parts[0],a:parts[1]};
    }).filter(x=>x.q && x.a);
}function generate(){

const CFG={
    speed:parseInt(document.getElementById("speed").value),
    objScale:parseFloat(document.getElementById("objScale").value),
    qs:parseQuestions()
};

const ctx=pCtx;

let GM={
    mx:0,
    my:0,
    bgX:0,
    bgY:0,
    objs:[],
    frame:0,
    score:0,
    activeQuestion:null
};

// создаем монеты = количеству вопросов
for(let i=0;i<CFG.qs.length;i++){
    GM.objs.push({
        x:(Math.random()-0.5)*W*2,
        y:(Math.random()-0.5)*H*2,
        t:'c'
    });
}

// добавляем препятствия
for(let i=0;i<6;i++){
    GM.objs.push({
        x:(Math.random()-0.5)*W*2,
        y:(Math.random()-0.5)*H*2,
        t:'o'
    });
}

window.onmousemove=e=>{
    GM.mx=e.clientX-400-W/2;
    GM.my=e.clientY-H/2;
};

function loop(){
    requestAnimationFrame(loop);
    GM.frame++;

    ctx.clearRect(0,0,W,H);

    // бесконечный фон
    if(pImg.bg.src && pImg.bg.complete && pImg.bg.width>0){
        let bw=pImg.bg.width;
        let bh=pImg.bg.height;

        let offsetX=GM.bgX % bw;
        let offsetY=GM.bgY % bh;

        for(let x=-bw;x<W+bw;x+=bw){
            for(let y=-bh;y<H+bh;y+=bh){
                ctx.drawImage(pImg.bg,x+offsetX,y+offsetY,bw,bh);
            }
        }
    }else{
        ctx.fillStyle="#000";
        ctx.fillRect(0,0,W,H);
    }

    GM.bgX-=CFG.speed*0.5;
    GM.bgY-=CFG.speed*0.2;

    // объекты
    GM.objs.forEach(o=>{

        let sx=o.x-GM.mx+W/2;
        let sy=o.y-GM.my+H/2;
        let size=80*CFG.objScale;

        if(o.t==='c' && pImg.coin.complete){
            ctx.drawImage(pImg.coin,sx-size/2,sy-size/2,size,size);
        }

        if(o.t==='o' && pImg.obs.complete){
            ctx.drawImage(pImg.obs,sx-size/2,sy-size/2,size,size);
        }

        let dist=Math.hypot(o.x-GM.mx,o.y-GM.my);

        if(dist<60 && !GM.activeQuestion){

            if(o.t==='c' && CFG.qs.length>0){
                GM.activeQuestion=CFG.qs.shift();
                showQuestion(GM.activeQuestion);
                o.remove=true;
            }

            if(o.t==='o'){
                GM.score=Math.max(0,GM.score-1);
                o.remove=true;
            }
        }

    });

    GM.objs=GM.objs.filter(o=>!o.remove);

    ctx.fillStyle="#fff";
    ctx.fillText("Счет: "+GM.score,20,30);
}

function showQuestion(q){
    const box=document.getElementById("quiz-box");
    box.innerHTML=`
        <div>${q.q}</div>
        <input id="ans">
        <button onclick="checkAnswer('${q.a}')">Ответить</button>
    `;
    box.style.display="block";
}

window.checkAnswer=function(a){
    const val=document.getElementById("ans").value.trim();
    if(val===a){
        GM.score++;
    }
    document.getElementById("quiz-box").style.display="none";
    GM.activeQuestion=null;
};

loop();
}

</script>
</body>
</html>
