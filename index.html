<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞: –ú–∞—Å—Ç–µ—Ä 2.0</title>
    <style>
        :root { --primary: #00d2ff; --bg: #1a1a2d; --panel: #252540; --text: #e0e0ff; --accent: #ff00ff; --success: #00ff88; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 20px; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); text-transform: uppercase; text-shadow: 0 0 10px var(--primary); font-size: 24px; }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid #444; position: relative; }
        .full-width { grid-column: 1 / -1; }
        
        h2 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 18px; }
        
        /* Inputs */
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 14px; color: #aaa; }
        input[type="text"], input[type="number"] {
            width: 100%; padding: 8px; margin-top: 5px; background: #111; border: 1px solid #555; color: #fff; border-radius: 4px; box-sizing: border-box;
        }
        input[type="range"] { width: 100%; margin: 10px 0; }
        
        /* File Input Wrapper */
        .file-group { margin-top: 5px; display: flex; align-items: center; gap: 10px; }
        .status-badge { 
            font-size: 12px; font-weight: bold; color: var(--success); 
            background: rgba(0,255,136, 0.1); padding: 2px 8px; border-radius: 4px;
            display: none; /* Hidden by default */
            border: 1px solid var(--success);
        }
        .status-badge.visible { display: inline-block; }

        /* Questions */
        textarea.bulk-input {
            width: 100%; height: 150px; background: #111; color: #fff; border: 1px solid #555; 
            font-family: monospace; padding: 10px; box-sizing: border-box; resize: vertical; margin-top: 5px;
        }
        #questionsPreview {
            margin-top: 10px; max-height: 150px; overflow-y: auto; 
            background: #111; border: 1px solid #444; padding: 10px; font-size: 12px; color: #aaa;
        }
        .q-item { border-bottom: 1px solid #333; padding: 4px 0; }
        .q-item b { color: #fff; }

        /* PREVIEW CANVAS (Static Gallery) */
        #previewContainer {
            width: 100%; height: 250px; border: 2px solid var(--primary); 
            margin-bottom: 15px; background: #000; display: flex; 
            align-items: center; justify-content: center; overflow: hidden; position: relative;
        }
        #previewCanvas { width: 100%; height: 100%; object-fit: contain; }

        /* Buttons */
        .btn-main { 
            background: linear-gradient(45deg, var(--primary), #0088ff); color: #fff; border: none; 
            padding: 15px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; 
            border-radius: 5px; margin-top: 10px; text-transform: uppercase; transition: 0.3s;
        }
        .btn-main:hover { transform: scale(1.02); }

        /* Copy Section */
        #copySection { display: none; margin-top: 20px; background: #111; padding: 15px; border-radius: 5px; text-align: center; }
        .hidden-code { position: absolute; left: -9999px; }
        .btn-copy {
            background: #444; color: white; border: 2px solid #666; padding: 12px 30px; 
            font-size: 16px; cursor: pointer; border-radius: 50px;
        }
        .btn-copy.success { background: var(--success); color: #000; border-color: var(--success); }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞: –ú–∞—Å—Ç–µ—Ä</h1>
    </header>

    <div class="grid">
        
        <!-- Preview -->
        <div class="card">
            <h2>üëÅÔ∏è –í–∏–∑—É–∞–ª (–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)</h2>
            
            <div id="previewContainer">
                <canvas id="previewCanvas"></canvas>
            </div>
            
            <label>–§–æ–Ω (–ö–∞—Ä—Ç–∏–Ω–∫–∞):</label>
            <div class="file-group">
                <input type="file" id="fBg" accept="image/*" onchange="loadAsset('bg')">
                <span id="st-bg" class="status-badge">‚úÖ –ó–ê–ì–†–£–ñ–ï–ù–û</span>
            </div>
            
            <label>–ê–≤–∞—Ç–∞—Ä (–ö–∞—Ä—Ç–∏–Ω–∫–∞):</label>
            <div class="file-group">
                <input type="file" id="fBird" accept="image/*" onchange="loadAsset('bird')">
                <span id="st-bird" class="status-badge">‚úÖ –ó–ê–ì–†–£–ñ–ï–ù–û</span>
            </div>
            
            <label>–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞:</label>
            <input type="range" id="sizeRange" min="0.5" max="2.0" step="0.1" value="1.0" oninput="drawStaticPreview()">
            
            <label>–†–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–æ–≤:</label>
            <input type="range" id="objSizeRange" min="0.5" max="2.0" step="0.1" value="1.0" oninput="drawStaticPreview()">
            
            <label>–°–∫–æ—Ä–æ—Å—Ç—å –∏–≥—Ä—ã:</label>
            <input type="range" id="speedRange" min="1" max="15" value="5">
        </div>

        <!-- Settings -->
        <div class="card">
            <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            
            <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã:</label>
            <input type="text" id="txtTitle" value="–ü–û–õ–ï–¢ –ê–í–ê–¢–ê–†–ê">
            
            <label>–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –°—Ç–∞—Ä—Ç:</label>
            <input type="text" id="txtStart" value="–ò–ì–†–ê–¢–¨">
            
            <label>–¢–µ–∫—Å—Ç –ü–æ–±–µ–¥—ã / –ü–æ—Ä–∞–∂–µ–Ω–∏—è:</label>
            <div style="display:flex; gap:10px">
                <input type="text" id="txtWin" value="–ü–û–ë–ï–î–ê!">
                <input type="text" id="txtLose" value="–ù–ï–£–î–ê–ß–ê">
            </div>

            <label>–í—Ä–µ–º—è (—Å–µ–∫—É–Ω–¥—ã):</label>
            <input type="number" id="valTime" value="60">

            <h3 style="font-size:14px; margin-top:15px; color:#fff;">–û–±—ä–µ–∫—Ç—ã</h3>
            <label>–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ (–í—Ä–∞–≥):</label>
            <div class="file-group">
                <input type="file" id="fObs" accept="image/*" onchange="loadAsset('obs')">
                <span id="st-obs" class="status-badge">‚úÖ –ó–ê–ì–†–£–ñ–ï–ù–û</span>
            </div>

            <label>–ú–æ–Ω–µ—Ç–∞ (–ë–æ–Ω—É—Å):</label>
            <div class="file-group">
                <input type="file" id="fCoin" accept="image/*" onchange="loadAsset('coin')">
                <span id="st-coin" class="status-badge">‚úÖ –ó–ê–ì–†–£–ñ–ï–ù–û</span>
            </div>

            <label>–ú—É–∑—ã–∫–∞ (MP3):</label>
            <div class="file-group">
                <input type="file" id="fMusic" accept="audio/*" onchange="loadAsset('music', false)">
                <span id="st-music" class="status-badge">‚úÖ –ó–ê–ì–†–£–ñ–ï–ù–û</span>
            </div>
        </div>

        <!-- Questions -->
        <div class="card full-width">
            <h2>‚ùì –í–æ–ø—Ä–æ—Å—ã</h2>
            <p style="font-size:12px; color:#aaa; margin-bottom:5px">
                –í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫: <b>–í–æ–ø—Ä–æ—Å | –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç | –ù–µ–≤–µ—Ä–Ω—ã–π 1 | –ù–µ–≤–µ—Ä–Ω—ã–π 2</b>
            </p>
            <textarea id="bulkQuestions" class="bulk-input" oninput="updateQPreview()" placeholder="2+2? | 4 | 5 | 6"></textarea>
            
            <label>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:</label>
            <div id="questionsPreview">Waiting for input...</div>
        </div>

        <!-- Generate -->
        <div class="card full-width" style="text-align: center;">
            <button class="btn-main" onclick="generate()">üöÄ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
            
            <div id="copySection">
                <textarea id="finalCode" class="hidden-code"></textarea>
                <button class="btn-copy" id="copyBtn" onclick="doCopy()">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
                <p style="color:#666; font-size:12px; margin-top:10px;">–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –≤ Genially (Insert -> Others) –∏ —Ä–∞—Å—Ç—è–Ω–∏—Ç–µ –Ω–∞ –≤–µ—Å—å —Å–ª–∞–π–¥.</p>
            </div>
        </div>
    </div>
</div>

<script>
    const assets = { bg: null, bird: null, obs: null, coin: null, music: null };
    const pImg = { bg: new Image(), bird: new Image(), obs: new Image(), coin: new Image() };

    // --- ASSET LOADING ---
    function loadAsset(key, isImg=true) {
        const fileInp = document.getElementById(key === 'bg' ? 'fBg' : key === 'bird' ? 'fBird' : key === 'obs' ? 'fObs' : key === 'coin' ? 'fCoin' : 'fMusic');
        const badge = document.getElementById('st-'+key);
        
        if(fileInp.files && fileInp.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                assets[key] = e.target.result;
                badge.classList.add('visible'); // Show Checkmark
                
                if(isImg) {
                    pImg[key].src = e.target.result;
                    pImg[key].onload = drawStaticPreview;
                }
            }
            reader.readAsDataURL(fileInp.files[0]);
        }
    }

    // --- QUESTIONS PREVIEW ---
    function updateQPreview() {
        const raw = document.getElementById('bulkQuestions').value;
        const div = document.getElementById('questionsPreview');
        if(!raw.trim()) { div.innerHTML = "–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤"; return; }
        
        const lines = raw.split('\n').filter(l => l.trim());
        let html = '';
        lines.forEach((l, i) => {
            const p = l.split('|');
            html += `<div class="q-item"><b>${i+1}.</b> ${p[0]} <span style="color:#0f0">(${p[1]||'?'})</span></div>`;
        });
        div.innerHTML = html;
    }

    // --- STATIC CANVAS PREVIEW (NO GEOMETRY, ONLY IMAGES) ---
    const cvs = document.getElementById('previewCanvas');
    const ctx = cvs.getContext('2d');

    function drawStaticPreview() {
        // Set canvas resolution
        const cont = document.getElementById('previewContainer');
        cvs.width = cont.offsetWidth;
        cvs.height = cont.offsetHeight;
        const W = cvs.width;
        const H = cvs.height;

        ctx.clearRect(0,0,W,H);
        
        // 1. Draw BG
        if(pImg.bg.src) {
            // Draw scaled to cover
            const ratio = Math.max(W/pImg.bg.width, H/pImg.bg.height);
            const bw = pImg.bg.width * ratio;
            const bh = pImg.bg.height * ratio;
            ctx.drawImage(pImg.bg, (W-bw)/2, (H-bh)/2, bw, bh);
        } else {
            // If no BG, just black
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,W,H);
            ctx.fillStyle = "#333"; ctx.font="14px sans-serif"; ctx.textAlign="center";
            ctx.fillText("–§–æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω", W/2, H/2);
        }

        // 2. Draw Coin (Left)
        const objSc = parseFloat(document.getElementById('objSizeRange').value);
        if(pImg.coin.src) {
            let s = 60 * objSc;
            ctx.drawImage(pImg.coin, W*0.2, H*0.6, s, s);
        }

        // 3. Draw Obstacle (Right)
        if(pImg.obs.src) {
            let s = 60 * objSc;
            ctx.drawImage(pImg.obs, W*0.8 - s, H*0.6, s, s);
        }

        // 4. Draw Avatar (Center)
        const avSc = parseFloat(document.getElementById('sizeRange').value);
        if(pImg.bird.src) {
            let s = 80 * avSc;
            ctx.drawImage(pImg.bird, W/2 - s/2, H/2 - s/2, s, s);
        } else {
             // Text placeholder only
            ctx.fillStyle = "#fff"; ctx.font="12px sans-serif";
            ctx.fillText("(–ê–≤–∞—Ç–∞—Ä)", W/2, H/2 + 20);
        }
    }

    window.addEventListener('resize', drawStaticPreview);
    setTimeout(drawStaticPreview, 500); // init

    // --- GENERATE GAME CODE ---
    function parseQuestions() {
        const raw = document.getElementById('bulkQuestions').value.trim();
        if(!raw) return [];
        return raw.split('\n').filter(l => l.trim()).map(l => {
            const p = l.split('|').map(s => s.trim());
            return p.length > 2 
                ? { t: p[0], type: 'choice', c: p[1], w: p.slice(2) }
                : { t: p[0], type: 'input', c: p[1] };
        });
    }

    function generate() {
        const CONFIG = {
            title: document.getElementById('txtTitle').value,
            btn: document.getElementById('txtStart').value,
            win: document.getElementById('txtWin').value,
            lose: document.getElementById('txtLose').value,
            time: document.getElementById('valTime').value,
            speed: document.getElementById('speedRange').value,
            scale: document.getElementById('sizeRange').value,
            objScale: document.getElementById('objSizeRange').value,
            qs: parseQuestions(),
            img: assets
        };

        const CODE = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; }
    body { font-family:'Segoe UI',sans-serif; user-select:none; -webkit-user-select:none; }
    #game-box { position:absolute; top:0; left:0; width:100%; height:100%; overflow:hidden; }
    canvas { display:block; width:100%; height:100%; }
    
    /* HUD */
    .hud { position:absolute; top:15px; color:#00d2ff; font-size:clamp(20px, 4vw, 30px); font-weight:bold; text-shadow:2px 2px 0 #000; padding:5px 15px; background:rgba(0,0,0,0.6); border-radius:10px; border:1px solid #00d2ff; z-index:50; }
    
    /* Screens */
    .screen { 
        position:absolute; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.85); display:flex; flex-direction:column; 
        align-items:center; justify-content:center; z-index:100; pointer-events:auto; 
    }
    h1 { color:#00d2ff; font-size:clamp(30px, 6vw, 60px); text-transform:uppercase; text-shadow:0 0 20px #00d2ff; margin-bottom:20px; text-align:center; }
    
    .btn-play {
        background: linear-gradient(180deg, #00d2ff, #0088aa);
        border: 4px solid #fff; padding: 15px 50px;
        color: #fff; font-size: clamp(20px, 4vw, 36px); font-weight: bold; text-transform: uppercase;
        border-radius: 60px; cursor: pointer; box-shadow: 0 0 30px #00d2ff;
        transition: transform 0.1s;
    }
    .btn-play:hover { transform: scale(1.05); background: #fff; color: #0088aa; }
    .btn-play:active { transform: scale(0.95); }

    /* QUIZ POPUP (Fixed dark overlay) */
    #quiz-overlay {
        display:none; position:fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(20, 20, 35, 0.95); z-index: 200;
        flex-direction: column; align-items: center; justify-content: center;
    }
    .quiz-card {
        width: 90%; max-width: 500px; background: #252540; 
        border: 2px solid #00d2ff; padding: 20px; border-radius: 15px;
        box-shadow: 0 0 50px rgba(0,0,0,0.8); text-align: center;
    }
    .q-txt { color: #fff; font-size: 24px; margin-bottom: 20px; }
    .q-btn { 
        display: block; width: 100%; padding: 15px; margin: 10px 0; 
        background: #334; border: 1px solid #556; color: #fff; 
        font-size: 18px; cursor: pointer; border-radius: 8px; transition: 0.2s;
    }
    .q-btn:hover { background: #00d2ff; color: #000; }
    input.q-inp { width: 80%; padding: 12px; font-size: 20px; text-align: center; margin-bottom: 10px; }

</style>
</head>
<body>

<div id="game-box">
    <!-- HUD -->
    <div class="hud" style="left:15px">‚è± <span id="ui-time">0</span></div>
    <div class="hud" style="right:15px">üèÜ <span id="ui-score">0</span></div>

    <canvas id="cvs"></canvas>

    <!-- START -->
    <div id="scr-start" class="screen">
        <h1 id="mt-title">TITLE</h1>
        <button class="btn-play" onclick="GM.start()">START</button>
    </div>

    <!-- END -->
    <div id="scr-end" class="screen" style="display:none">
        <h1 id="mt-end">END</h1>
        <p style="color:#fff; font-size:30px">–°—á–µ—Ç: <span id="end-score">0</span></p>
        <button class="btn-play" onclick="GM.reset()">‚Ü∫</button>
    </div>

    <!-- QUIZ -->
    <div id="quiz-overlay">
        <div class="quiz-card">
            <div id="q-txt" class="q-txt">–í–æ–ø—Ä–æ—Å</div>
            <div id="q-body"></div>
        </div>
    </div>
</div>

<script>
const CFG = ${JSON.stringify(CONFIG)};
const IMG = CFG.img;

// Set Texts
document.getElementById('mt-title').innerText = CFG.title;
document.querySelector('#scr-start button').innerText = CFG.btn;

// Canvas Setup
const cvs = document.getElementById('cvs');
const ctx = cvs.getContext('2d');
let W, H;

function resize() {
    W = cvs.width = window.innerWidth;
    H = cvs.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// Audio
const AC = new (window.AudioContext || window.webkitAudioContext)();
let music = null; 
if(IMG.music) { music = new Audio(IMG.music); music.loop=true; music.volume=0.4; }

function sfx(t) {
    if(AC.state === 'suspended') AC.resume();
    const o = AC.createOscillator(); const g = AC.createGain();
    o.connect(g); g.connect(AC.destination);
    const now = AC.currentTime;
    
    if(t==='coin') {
        o.type='sine'; o.frequency.setValueAtTime(1000, now); g.gain.linearRampToValueAtTime(0, now+0.3);
        o.start(now); o.stop(now+0.3);
    } else if(t==='hit') {
        o.type='sawtooth'; o.frequency.setValueAtTime(100, now); o.frequency.exponentialRampToValueAtTime(10, now+0.3);
        g.gain.linearRampToValueAtTime(0, now+0.3); o.start(now); o.stop(now+0.3);
    } else if(t==='win') {
        o.type='triangle'; o.frequency.setValueAtTime(400, now); o.frequency.linearRampToValueAtTime(800, now+0.4);
        g.gain.linearRampToValueAtTime(0, now+0.5); o.start(now); o.stop(now+0.5);
    }
}

// Images
const iBg = new Image(); if(IMG.bg) iBg.src = IMG.bg;
const iBird = new Image(); if(IMG.bird) iBird.src = IMG.bird;
const iObs = new Image(); if(IMG.obs) iObs.src = IMG.obs;
const iCoin = new Image(); if(IMG.coin) iCoin.src = IMG.coin;

// Game Logic
const GM = {
    run: false, pause: false,
    frame: 0, time: 0, score: 0,
    mx: 0, my: 0, // Mouse position
    camX: 0, camY: 0, // Camera position (follows mouse slightly)
    speed: parseFloat(CFG.speed),
    objs: [],
    timerInt: null,
    
    start: () => {
        document.getElementById('scr-start').style.display = 'none';
        GM.run = true; GM.pause = false;
        GM.time = parseInt(CFG.time);
        GM.score = 0; GM.frame = 0;
        GM.objs = [];
        GM.mx = W/2; GM.my = H/2;
        
        document.getElementById('ui-time').innerText = GM.time;
        document.getElementById('ui-score').innerText = 0;

        if(AC.state==='suspended') AC.resume();
        if(music) music.play().catch(()=>{});

        // Timer
        GM.timerInt = setInterval(()=>{
            if(!GM.run || GM.pause) return;
            GM.time--;
            document.getElementById('ui-time').innerText = GM.time;
            if(GM.time <= 0) GM.end(false);
        }, 1000);

        loop();
    },

    reset: () => {
        clearInterval(GM.timerInt);
        GM.run = false; GM.pause = false;
        document.getElementById('scr-end').style.display = 'none';
        document.getElementById('scr-start').style.display = 'flex';
        document.getElementById('quiz-overlay').style.display = 'none';
        if(music) { music.pause(); music.currentTime=0; }
    },

    end: (win) => {
        GM.run = false;
        clearInterval(GM.timerInt);
        document.getElementById('scr-end').style.display = 'flex';
        const h = document.getElementById('mt-end');
        h.innerText = win ? CFG.win : CFG.lose;
        h.style.color = win ? '#0f0' : '#f00';
        document.getElementById('end-score').innerText = GM.score;
        sfx(win?'win':'hit');
    }
};

// Input
window.addEventListener('mousemove', e => { GM.mx = e.clientX; GM.my = e.clientY; });
window.addEventListener('touchmove', e => {
    e.preventDefault();
    GM.mx = e.touches[0].clientX; GM.my = e.touches[0].clientY;
}, {passive:false});

function loop() {
    if(!GM.run) return;
    requestAnimationFrame(loop);
    if(GM.pause) return;

    ctx.clearRect(0,0,W,H);

    // 1. Camera Logic (Avatar moves to Mouse)
    // Lerp camera towards mouse for smooth movement
    GM.camX += (GM.mx - GM.camX) * 0.1; 
    GM.camY += (GM.my - GM.camY) * 0.1;
    
    // 2. Infinite Background
    if(iBg.src && iBg.complete && iBg.width > 0) {
        // Create Pattern
        const pat = ctx.createPattern(iBg, 'repeat');
        ctx.save();
        // Shift pattern opposite to camera + constant speed forward illusion
        let bgSpeedY = GM.frame * GM.speed * 2;
        ctx.translate(-GM.camX, -GM.camY + bgSpeedY); 
        ctx.fillStyle = pat;
        // Draw HUGE rect around camera to ensure no white edges
        ctx.fillRect(GM.camX - W, GM.camY - H - bgSpeedY, W*3, H*3); 
        ctx.restore();
    } else {
        ctx.fillStyle = "#112"; ctx.fillRect(0,0,W,H);
    }

    // 3. Spawning Objects (World Coordinates)
    // Objects spawn far away (Z=2000), at random X/Y relative to center + some offset
    if(GM.frame % (60 - GM.speed*2) === 0) {
        let isCoin = (CFG.qs.length > 0 && Math.random() > 0.6);
        // Spawn area is wider than screen to force player to move
        let spawnW = W * 2; 
        let spawnH = H * 2;
        GM.objs.push({
            x: GM.camX + (Math.random()-0.5) * spawnW, // Spawn near where player is looking
            y: GM.camY + (Math.random()-0.5) * spawnH - H, // Start slightly above
            z: 2000, 
            type: isCoin ? 'c' : 'o'
        });
    }

    // 4. Update & Draw Objects
    GM.objs.sort((a,b) => b.z - a.z); // Painter's algo
    const scaleUsr = parseFloat(CFG.objScale || 1.0);

    for(let i=0; i<GM.objs.length; i++) {
        let o = GM.objs[i];
        o.z -= (5 + GM.speed); // Move towards camera

        if(o.z < 10) { GM.objs.splice(i,1); i--; continue; }

        // Perspective Projection
        let perspective = 600 / o.z; 
        // Parallax: World Position minus Camera Position
        let screenX = W/2 + (o.x - GM.camX) * perspective;
        let screenY = H/2 + (o.y - GM.camY) * perspective;
        let size = 100 * perspective * scaleUsr;

        // Draw
        let img = (o.type==='c') ? iCoin : iObs;
        if(img.src) {
             ctx.drawImage(img, screenX - size/2, screenY - size/2, size, size);
        } else {
             ctx.fillStyle = o.type==='c'?'gold':'red';
             ctx.beginPath(); ctx.arc(screenX, screenY, size/2, 0, 7); ctx.fill();
        }

        // Collision
        // Check only if close (z < 100) and overlapped
        if(o.z < 150 && o.z > 20) {
            let dx = screenX - GM.mx; // Mouse is basically Player Screen Pos
            let dy = screenY - GM.my;
            let dist = Math.hypot(dx, dy);
            let hitRad = (size/2) * 0.8 + (40 * parseFloat(CFG.scale)); // hitbox
            
            if(dist < hitRad) {
                GM.objs.splice(i,1); i--;
                handleHit(o.type);
            }
        }
    }

    // 5. Draw Avatar (At Mouse Position)
    let avSize = 120 * parseFloat(CFG.scale);
    if(iBird.src) {
        ctx.save();
        ctx.translate(GM.mx, GM.my);
        // Tilt based on horizontal movement
        let tilt = (GM.mx - GM.camX) * 0.2; 
        ctx.rotate(tilt * Math.PI/180);
        ctx.drawImage(iBird, -avSize/2, -avSize/2, avSize, avSize);
        ctx.restore();
    } else {
        ctx.fillStyle = '#0ff'; ctx.beginPath(); ctx.arc(GM.mx, GM.my, 20, 0, 7); ctx.fill();
    }

    GM.frame++;
}

function handleHit(type) {
    if(type === 'o') {
        sfx('hit');
        GM.time -= 5;
        // Red flash
        let f = document.createElement('div');
        f.style="position:absolute;top:0;left:0;width:100%;height:100%;background:red;opacity:0.5;z-index:90";
        document.body.appendChild(f);
        setTimeout(()=>f.remove(), 100);
        document.getElementById('ui-time').innerText = GM.time;
        if(GM.time <= 0) GM.end(false);
    } else {
        sfx('coin');
        if(CFG.qs.length > 0) {
            showQuiz();
        } else {
            GM.score++; 
            document.getElementById('ui-score').innerText = GM.score;
        }
    }
}

function showQuiz() {
    GM.pause = true;
    const q = CFG.qs[Math.floor(Math.random()*CFG.qs.length)];
    
    const ov = document.getElementById('quiz-overlay');
    const txt = document.getElementById('q-txt');
    const body = document.getElementById('q-body');
    
    ov.style.display = 'flex';
    txt.innerText = q.t;
    body.innerHTML = '';

    const check = (ans) => {
        ov.style.display = 'none';
        if(ans.trim().toLowerCase() === q.c.trim().toLowerCase()) {
            sfx('win'); GM.score++;
        } else {
            sfx('hit'); GM.time -= 10;
        }
        document.getElementById('ui-score').innerText = GM.score;
        document.getElementById('ui-time').innerText = GM.time;
        GM.pause = false;
    };

    if(q.type === 'choice') {
        let opts = [q.c, ...q.w].sort(()=>Math.random()-0.5);
        opts.forEach(o => {
            let b = document.createElement('button');
            b.className = 'q-btn'; b.innerText = o;
            b.onclick = () => check(o);
            body.appendChild(b);
        });
    } else {
        let inp = document.createElement('input'); inp.className='q-inp';
        let b = document.createElement('button'); b.className='q-btn'; b.innerText='OK';
        b.onclick = () => check(inp.value);
        body.appendChild(inp); body.appendChild(b);
        inp.focus();
    }
}
<\/script>
</body>
</html>`;
        document.getElementById('finalCode').value = CODE;
        document.getElementById('copySection').style.display = 'block';
    }

    function doCopy() {
        const txt = document.getElementById('finalCode');
        txt.select();
        document.execCommand('copy');
        const btn = document.getElementById('copyBtn');
        const orig = btn.innerText;
        btn.classList.add('success');
        btn.innerText = "–°–ö–û–ü–ò–†–û–í–ê–ù–û!";
        setTimeout(() => {
            btn.classList.remove('success');
            btn.innerText = orig;
        }, 2000);
    }
</script>
</body>
</html>
