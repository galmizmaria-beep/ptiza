<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞: –ú–∞—Å—Ç–µ—Ä</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        :root {
            --primary: #00e5ff;
            --bg: #030c1f;
            --panel: #0a193a;
            --panel-border: rgba(0, 229, 255, 0.2);
            --text: #cdefff;
            --text-dark: #6a95b3;
            --glow: rgba(0, 229, 255, 0.7);
            --success: #00ff88;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; font-size: 14px; }
        .container { max-width: 1500px; margin: 0 auto; }
        
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px -5px var(--glow); }
        h1 { margin: 0; color: var(--primary); text-transform: uppercase; text-shadow: 0 0 10px var(--primary), 0 0 20px var(--glow); font-size: 24px; font-family: 'Orbitron', sans-serif; }
        .lang-switch button { background: var(--panel); color: var(--text); border: 1px solid var(--panel-border); padding: 5px 10px; cursor: pointer; transition: 0.3s; }
        .lang-switch button:hover { background: var(--primary); color: #000; box-shadow: 0 0 10px var(--glow); }
        .lang-switch button.active { background: var(--primary); color: #000; font-weight: bold; box-shadow: 0 0 10px var(--glow); }

        .main-grid { display: grid; grid-template-columns: 1.5fr 1fr; grid-template-rows: auto 1fr; gap: 20px; height: calc(100vh - 130px); }
        .card { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid var(--panel-border); overflow-y: auto; box-shadow: inset 0 0 15px rgba(0,0,0,0.5); }
        
        .grid-col-span-2 { grid-column: 1 / -1; }
        .grid-row-span-2 { grid-row: 1 / -1; }

        h2 { margin-top: 0; color: var(--primary); border-bottom: 1px solid var(--panel-border); padding-bottom: 10px; font-size: 18px; text-shadow: 0 0 5px var(--glow); }
        h3 { font-size:16px; margin-top:15px; margin-bottom: 10px; color:#fff; border-top: 1px solid var(--panel-border); padding-top: 15px; }

        label { display: block; margin-top: 15px; font-weight: bold; color: var(--text-dark); text-transform: uppercase; font-size: 12px; }
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; margin-top: 5px; background: #040d21; border: 1px solid var(--panel-border); color: #fff; border-radius: 4px; box-sizing: border-box; transition: 0.3s; }
        input[type="text"]:focus, input[type="number"]:focus { border-color: var(--primary); box-shadow: 0 0 10px var(--glow); }
        input[type="range"] { width: 100%; margin: 5px 0; -webkit-appearance: none; background: transparent; }
        input[type="range"]::-webkit-slider-runnable-track { height: 4px; background: var(--panel-border); border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; background: var(--primary); border-radius: 50%; border: 2px solid #fff; margin-top: -6px; box-shadow: 0 0 10px var(--glow); }

        .char-previews { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 5px; min-height: 54px; max-height: 150px; overflow-y: auto; }
        .preview-item { display: flex; align-items: center; gap: 10px; background: rgba(0, 229, 255, 0.05); padding: 5px; border-radius: 4px; }
        .preview-item img { width: 40px; height: 40px; object-fit: cover; border: 2px solid var(--primary); border-radius: 5px; flex-shrink: 0; }
        .status-text { font-size: 12px; color: var(--success); text-shadow: 0 0 5px var(--success); }

        textarea.bulk-input { width: 100%; height: 100%; min-height: 250px; background: #040d21; color: #fff; border: 1px solid var(--panel-border); font-family: monospace; padding: 10px; box-sizing: border-box; resize: vertical; margin-top: 5px; transition: 0.3s; }
        textarea.bulk-input:focus { border-color: var(--primary); box-shadow: 0 0 10px var(--glow); }
        .help-text { font-size: 12px; color: var(--text-dark); margin-top: 5px; line-height: 1.4; }
        .warn-text { color: #ffab00; font-weight: bold; }

        #previewContainer { width: 100%; aspect-ratio: 16/9; border: 2px solid var(--primary); position: relative; background: var(--bg); overflow: hidden; margin-bottom: 15px; box-shadow: 0 0 20px var(--glow); border-radius: 5px;}
        #previewCanvas { width: 100%; height: 100%; display: block; }

        .btn-main { background: linear-gradient(45deg, var(--primary), #00a2ff); color: #fff; border: none; padding: 15px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 10px; text-transform: uppercase; transition: 0.3s; text-shadow: 0 0 5px #000; }
        .btn-main:hover { transform: scale(1.02); box-shadow: 0 0 20px var(--glow); }
        
        #copySection { display: none; margin-top: 20px; background: #040d21; padding: 15px; border-radius: 5px; text-align: center; }
        .btn-copy { background: var(--panel); color: white; border: 2px solid var(--panel-border); padding: 12px 30px; font-size: 16px; cursor: pointer; border-radius: 50px; display: inline-flex; align-items: center; gap: 10px; transition: all 0.3s ease; }
        .btn-copy:hover { border-color: var(--primary); box-shadow: 0 0 10px var(--glow); color: var(--primary); }
        .btn-copy.success { background: var(--success); color: #000; border-color: var(--success); box-shadow: 0 0 10px var(--success);}
        .hidden-code { position: absolute; left: -9999px; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1 data-key="title">–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞</h1>
        <div class="lang-switch">
            <button onclick="setLang('ru')" id="btn-ru" class="active">RU</button>
            <button onclick="setLang('en')" id="btn-en">EN</button>
        </div>
    </header>
    <div class="main-grid">
        <div class="card grid-row-span-2">
            <h2 data-key="sec_visual">üëÅÔ∏è –í–∏–∑—É–∞–ª</h2>
            <div id="previewContainer"><canvas id="previewCanvas"></canvas></div>
            <label data-key="lbl_size">–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞/—Å—É—â–µ—Å—Ç–≤–∞:</label>
            <input type="range" id="sizeRange" min="0.5" max="2.0" step="0.1" value="1.0">
            <label data-key="lbl_obj_size">–†–∞–∑–º–µ—Ä –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π/–º–æ–Ω–µ—Ç:</label>
            <input type="range" id="objSizeRange" min="0.5" max="2.0" step="0.1" value="1.0">
            <label data-key="lbl_speed">–°–∫–æ—Ä–æ—Å—Ç—å –∞–≤–∞—Ç–∞—Ä–∞:</label>
            <input type="range" id="speedRange" min="1" max="10" value="4">
            <h3>–ê–≤–∞—Ç–∞—Ä—ã –∏ –°—É—â–µ—Å—Ç–≤–∞</h3>
            <label data-key="lbl_avatars">–ê–≤–∞—Ç–∞—Ä—ã (–¥–æ 6 —à—Ç.):</label>
            <input type="file" id="fAvatars" accept="image/*" multiple onchange="loadMultipleAssets('avatars', 'avatar-previews')">
            <div id="avatar-previews" class="char-previews"></div>
            <label data-key="lbl_creatures">–°—É—â–µ—Å—Ç–≤–∞ (–¥–æ 6 —à—Ç.):</label>
            <input type="file" id="fCreatures" accept="image/*" multiple onchange="loadMultipleAssets('creatures', 'creature-previews')">
            <div id="creature-previews" class="char-previews"></div>
        </div>
        <div class="card">
             <h2 data-key="sec_settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –†–µ—Å—É—Ä—Å—ã</h2>
             <label data-key="lbl_gameTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
             <input type="text" id="txtTitle" value="–ü–û–õ–ï–¢ –ê–í–ê–¢–ê–†–ê">
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div><label data-key="lbl_btnStart">–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç:</label><input type="text" id="txtStart" value="–ò–ì–†–ê–¢–¨"></div>
                <div><label data-key="lbl_time">–í—Ä–µ–º—è (—Å):</label><input type="number" id="valTime" value="60"></div>
                <div><label data-key="lbl_win">–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã:</label><input type="text" id="txtWin" value="–ü–û–ë–ï–î–ê!"></div>
                <div><label data-key="lbl_lose">–¢–µ–∫—Å—Ç –ø–æ—Ä–∞–∂–µ–Ω–∏—è:</label><input type="text" id="txtLose" value="–ü–û–ü–†–û–ë–£–ô –ï–©–ï"></div>
             </div>
             <label data-key="lbl_bg">–§–æ–Ω (–±–µ—Å—à–æ–≤–Ω—ã–π):</label>
             <input type="file" id="fBg" accept="image/*" onchange="loadSingleAsset('bg')">
             <label data-key="lbl_obs">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ:</label>
             <input type="file" id="fObs" accept="image/*" onchange="loadSingleAsset('obs')">
             <label data-key="lbl_coin">–ú–æ–Ω–µ—Ç–∞:</label>
             <input type="file" id="fCoin" accept="image/*" onchange="loadSingleAsset('coin')">
             <label data-key="lbl_music">–ú—É–∑—ã–∫–∞:</label>
             <input type="file" id="fMusic" accept="audio/*" onchange="loadSingleAsset('music', false)">
             <p class="help-text warn-text" data-key="warn_size">üí° –°–æ–≤–µ—Ç: –°–∂–∏–º–∞–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (tinypng.com) –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ—Å—à–æ–≤–Ω—ã–µ —Ç–µ–∫—Å—Ç—É—Ä—ã –¥–ª—è —Ñ–æ–Ω–∞!</p>
        </div>
        <div class="card" style="display:flex; flex-direction:column;">
            <h2 data-key="sec_questions">‚ùì –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤</h2>
            <textarea id="bulkQuestions" class="bulk-input" placeholder="..."></textarea>
            <div class="help-text" data-key="help_q">–§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π 1...</div>
        </div>
        <div class="grid-col-span-2">
             <button class="btn-main" onclick="generate()" data-key="btn_gen">üöÄ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
             <div id="copySection">
                <textarea id="finalCode" class="hidden-code"></textarea>
                <button class="btn-copy" id="copyBtn" onclick="doCopy()">
                    <span id="copyIcon">üìã</span> <span id="copyText" data-key="btn_copy">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</span>
                </button>
                <p class="help-text" data-key="lbl_copy_hint">–í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ Genially (Insert -> Others).</p>
            </div>
        </div>
    </div>
</div>

<script>
    // Asset and language management logic (mostly unchanged)
    const assets = { bg: null, obs: null, coin: null, music: null, avatars: [], creatures: [] };
    let currentLang = 'ru';
    const pImg = { bg: new Image(), obs: new Image(), coin: new Image(), avatars: [], creatures: [] };
    const dict = { ru: { title: "–ü–æ–ª–µ—Ç –ê–≤–∞—Ç–∞—Ä–∞: –ú–∞—Å—Ç–µ—Ä", sec_visual: "üëÅÔ∏è –í–∏–∑—É–∞–ª", lbl_size: "–†–∞–∑–º–µ—Ä –∞–≤–∞—Ç–∞—Ä–∞/—Å—É—â–µ—Å—Ç–≤–∞:", lbl_obj_size: "–†–∞–∑–º–µ—Ä –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π/–º–æ–Ω–µ—Ç:", lbl_speed: "–°–∫–æ—Ä–æ—Å—Ç—å –∞–≤–∞—Ç–∞—Ä–∞:", sec_settings: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –†–µ—Å—É—Ä—Å—ã", lbl_gameTitle: "–ó–∞–≥–æ–ª–æ–≤–æ–∫:", lbl_btnStart: "–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç:", lbl_win: "–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã:", lbl_lose: "–¢–µ–∫—Å—Ç –ø–æ—Ä–∞–∂–µ–Ω–∏—è:", lbl_time: "–í—Ä–µ–º—è (—Å):", lbl_bg: "–§–æ–Ω (–±–µ—Å—à–æ–≤–Ω—ã–π):", lbl_obs: "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ:", lbl_coin: "–ú–æ–Ω–µ—Ç–∞:", lbl_music: "–ú—É–∑—ã–∫–∞:", sec_questions: "‚ùì –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤", lbl_avatars: "–ê–≤–∞—Ç–∞—Ä—ã (–¥–æ 6 —à—Ç.):", lbl_creatures: "–°—É—â–µ—Å—Ç–≤–∞ (–¥–æ 6 —à—Ç.):", help_q: "–§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π 1 | –ù–µ–≤–µ—Ä–Ω—ã–π 2", btn_gen: "üöÄ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£", btn_copy: "–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î", btn_copied: "–°–ö–û–ü–ò–†–û–í–ê–ù–û!", lbl_copy_hint: "–í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ Genially (Insert -> Others) –∏ —Ä–∞—Å—Ç—è–Ω–∏—Ç–µ –Ω–∞ –≤–µ—Å—å —Å–ª–∞–π–¥.", warn_size: "üí° –°–æ–≤–µ—Ç: –°–∂–∏–º–∞–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (tinypng.com) –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ—Å—à–æ–≤–Ω—ã–µ —Ç–µ–∫—Å—Ç—É—Ä—ã –¥–ª—è —Ñ–æ–Ω–∞!", val_title: "–ü–û–î–í–û–î–ù–´–ô –ú–ò–†", val_start: "–ò–ì–†–ê–¢–¨", val_win: "–ü–û–ë–ï–î–ê!", val_lose: "–ü–û–ü–†–û–ë–£–ô –ï–©–ï", game_avatar: "–ê–í–ê–¢–ê–†", game_creature: "–°–£–©–ï–°–¢–í–û", status_avatar_loaded: "–ê–≤–∞—Ç–∞—Ä", status_creature_loaded: "–°—É—â–µ—Å—Ç–≤–æ", status_loaded: "–∑–∞–≥—Ä—É–∂–µ–Ω", err_max_files: "–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ 6 —Ñ–∞–π–ª–æ–≤." }, en: { title: "Avatar Flight: Master", sec_visual: "üëÅÔ∏è Visuals", lbl_size: "Avatar/Creature Size:", lbl_obj_size: "Objects Size:", lbl_speed: "Avatar Speed:", sec_settings: "‚öôÔ∏è Settings & Resources", lbl_gameTitle: "Title:", lbl_btnStart: "Start Button:", lbl_win: "Win Text:", lbl_lose: "Lose Text:", lbl_time: "Time (s):", lbl_bg: "Background (seamless):", lbl_obs: "Obstacle:", lbl_coin: "Coin:", lbl_music: "Music:", sec_questions: "‚ùì Questions List", lbl_avatars: "Avatars (up to 6):", lbl_creatures: "Creatures (up to 6):", help_q: "Format: Question | Correct | Wrong 1 | Wrong 2", btn_gen: "üöÄ CREATE GAME", btn_copy: "COPY CODE", btn_copied: "COPIED!", lbl_copy_hint: "Paste into Genially (Insert -> Others) and stretch full screen.", warn_size: "üí° Tip: Compress images (tinypng.com) and use seamless textures for backgrounds!", val_title: "DEEP SEA", val_start: "PLAY", val_win: "VICTORY!", val_lose: "TRY AGAIN", game_avatar: "AVATAR", game_creature: "CREATURE", status_avatar_loaded: "Avatar", status_creature_loaded: "Creature", status_loaded: "loaded", err_max_files: "You can upload a maximum of 6 files." } };
    function setLang(lang) { currentLang = lang; document.querySelectorAll('[data-key]').forEach(el => { const key = el.dataset.key; if (dict[lang][key]) el.innerText = dict[lang][key]; }); document.getElementById('btn-ru').className = lang === 'ru' ? 'active' : ''; document.getElementById('btn-en').className = lang === 'en' ? 'active' : ''; const d = dict[lang]; document.getElementById('txtTitle').value = d.val_title; document.getElementById('txtStart').value = d.val_start; document.getElementById('txtWin').value = d.val_win; document.getElementById('txtLose').value = d.val_lose; document.getElementById('bulkQuestions').placeholder = d.ph_bulk; document.getElementById('copyBtn').className = 'btn-copy'; document.getElementById('copyText').innerText = d.btn_copy; }
    function loadSingleAsset(key, isImg = true) { const input = document.getElementById('f' + key.charAt(0).toUpperCase() + key.slice(1)); if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { assets[key] = e.target.result; if(isImg) { pImg[key].src = e.target.result; } }; reader.readAsDataURL(input.files[0]); } }
    function loadMultipleAssets(key, previewId) { const input = document.getElementById('f' + key.charAt(0).toUpperCase() + key.slice(1)); const previewContainer = document.getElementById(previewId); const MAX_FILES = 6; if (assets[key].length >= MAX_FILES) { alert(dict[currentLang].err_max_files); return; } const filesToLoad = Array.from(input.files).slice(0, MAX_FILES - assets[key].length); filesToLoad.forEach(file => { const reader = new FileReader(); const currentAssetIndex = assets[key].length; const itemDiv = document.createElement('div'); itemDiv.className = 'preview-item'; const img = document.createElement('img'); const statusSpan = document.createElement('span'); statusSpan.className = 'status-text'; itemDiv.appendChild(img); itemDiv.appendChild(statusSpan); previewContainer.appendChild(itemDiv); assets[key].push(null); pImg[key].push(null); reader.onload = e => { const dataUrl = e.target.result; assets[key][currentAssetIndex] = dataUrl; const pImage = new Image(); pImage.src = dataUrl; pImg[key][currentAssetIndex] = pImage; img.src = dataUrl; const typeText = key === 'avatars' ? dict[currentLang].status_avatar_loaded : dict[currentLang].status_creature_loaded; statusSpan.innerText = `‚úÖ ${typeText} ${currentAssetIndex + 1} ${dict[currentLang].status_loaded}`; }; reader.readAsDataURL(file); }); }
    
    // New Preview Canvas Logic
    const pCanvas = document.getElementById('previewCanvas');
    const pCtx = pCanvas.getContext('2d');
    let pObjs = [], pPlayer = {x:0, y:0, tx: 0, ty: 0}, pCam = {x:0, y:0}, pFrame = 0;

    function initPreview() {
        if(!pCanvas.parentElement) return;
        let W = pCanvas.width = pCanvas.parentElement.offsetWidth;
        let H = pCanvas.height = pCanvas.parentElement.offsetHeight;
        pPlayer.x = pPlayer.tx = W / 2;
        pPlayer.y = pPlayer.ty = H / 2;
        pCam.x = pPlayer.x; pCam.y = pPlayer.y;
        pObjs = Array(20).fill().map(() => ({
            x: (Math.random() - 0.5) * W * 2,
            y: (Math.random() - 0.5) * H * 2,
            t: Math.random() > 0.5 ? 'c' : 'o'
        }));
        if (pFrame === 0) previewLoop();
    }

    function previewLoop() {
        if(!pCanvas.parentElement) { pFrame = 0; return; }
        requestAnimationFrame(previewLoop);
        let W = pCanvas.width, H = pCanvas.height;
        pCtx.clearRect(0,0,W,H);
        
        const speed = parseFloat(document.getElementById('speedRange').value) * 0.5;
        pPlayer.x += (pPlayer.tx - pPlayer.x) * 0.1;
        pPlayer.y += (pPlayer.ty - pPlayer.y) * 0.1;
        pCam.x += (pPlayer.x - pCam.x) * 0.1;
        pCam.y += (pPlayer.y - pCam.y) * 0.1;

        if (pFrame % 100 === 0) {
            pPlayer.tx = Math.random() * W;
            pPlayer.ty = Math.random() * H;
        }

        pCtx.save();
        pCtx.translate(W/2 - pCam.x, H/2 - pCam.y);

        if(pImg.bg.src && pImg.bg.complete) {
            let bgW = pImg.bg.width, bgH = pImg.bg.height;
            let ptrn = pCtx.createPattern(pImg.bg, 'repeat');
            if(ptrn) { pCtx.fillStyle = ptrn; pCtx.fillRect(pCam.x-W, pCam.y-H, W*2, H*2); }
        } else { pCtx.fillStyle= '#030c1f'; pCtx.fillRect(pCam.x-W, pCam.y-H, W*2, H*2); }

        const objScale = parseFloat(document.getElementById('objSizeRange').value);
        pObjs.forEach(o => {
            let img = (o.t === 'c') ? pImg.coin : pImg.obs;
            if (img && img.complete) pCtx.drawImage(img, o.x - 25 * objScale, o.y - 25 * objScale, 50 * objScale, 50 * objScale);
        });

        const pSize = 60 * parseFloat(document.getElementById('sizeRange').value);
        const creatureImg = pImg.creatures.length > 0 ? pImg.creatures[0] : null;
        const avatarImg = pImg.avatars.length > 0 ? pImg.avatars[0] : null;
        
        pCtx.save();
        pCtx.translate(pPlayer.x, pPlayer.y);
        if (creatureImg && creatureImg.complete) pCtx.drawImage(creatureImg, -pSize / 2, -pSize / 2, pSize, pSize);
        if (avatarImg && avatarImg.complete) pCtx.drawImage(avatarImg, -pSize*0.25, -pSize*0.4, pSize*0.5, pSize*0.5);
        pCtx.restore();

        pCtx.restore();
        pFrame++;
    }

    initPreview();
    new ResizeObserver(() => initPreview()).observe(pCanvas.parentElement);
    
    function parseQuestions() { return document.getElementById('bulkQuestions').value.trim().split('\n').filter(l => l.trim() !== '').map((l, i) => { const p = l.split('|').map(s => s.trim()); return p.length > 2 ? {t:p[0],type:'choice',c:p[1],w:p.slice(2),id:i} : {t:p[0],type:'input',c:p[1],id:i}; }); }
    function generate() {
        const configJson = JSON.stringify({ title: document.getElementById('txtTitle').value, btn: document.getElementById('txtStart').value, win: document.getElementById('txtWin').value, lose: document.getElementById('txtLose').value, time: document.getElementById('valTime').value, speed: document.getElementById('speedRange').value, scale: document.getElementById('sizeRange').value, objScale: document.getElementById('objSizeRange').value, qs: parseQuestions(), img: assets, lang: {lang: currentLang, dict: dict[currentLang]}});
        const CODE = `<!DOCTYPE html><html><head><meta charset="UTF-8"><link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet"><style>html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#030c1f;color:#cdefff;font-family:'Segoe UI',sans-serif;user-select:none}#game-box{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;touch-action:none}canvas{display:block;width:100%;height:100%;pointer-events:none}.hud{position:absolute;top:15px;font-family:'Orbitron',sans-serif;color:#00e5ff;font-size:clamp(20px,4vw,30px);font-weight:700;text-shadow:0 0 5px #00e5ff,0 0 10px rgba(0,229,255,0.7);padding:5px 15px;background:rgba(10,25,58,0.8);border-radius:10px;border:1px solid rgba(0,229,255,0.3);z-index:50}.screen{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(3,12,31,0.9);backdrop-filter:blur(5px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;pointer-events:auto;transition:opacity .5s}.screen.hidden{opacity:0;pointer-events:none}h1{font-family:'Orbitron',sans-serif;color:#00e5ff;font-size:clamp(35px,7vw,70px);text-transform:uppercase;text-shadow:0 0 8px #00e5ff,0 0 20px rgba(0,229,255,0.8),0 0 35px rgba(0,229,255,0.6);margin:20px;text-align:center;position:relative}#char-select-screen h1{cursor:pointer;transition:all .5s}#char-select-screen h1:hover{transform:scale(1.05);filter:blur(1px)}#char-select-screen h1::after{content:'';position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:0;height:2px;background:#00e5ff;transition:width .5s}#char-select-screen h1:hover::after{width:100%}@keyframes bubbles{0%{transform:translateY(0) scale(0);opacity:0}50%{opacity:0.8}100%{transform:translateY(-100px) scale(1.5);opacity:0}}.bubble{position:absolute;background:rgba(0,229,255,0.3);border-radius:50%;width:10px;height:10px;animation:bubbles 3s ease-in-out infinite}button.btn-play{font-family:'Orbitron',sans-serif;background:linear-gradient(180deg,#00e5ff,#00a2ff);border:3px solid #fff;padding:15px 60px;color:#fff;font-size:clamp(24px,5vw,40px);font-weight:700;text-transform:uppercase;border-radius:60px;cursor:pointer;box-shadow:0 0 20px rgba(0,229,255,0.7),inset 0 0 10px rgba(255,255,255,0.5);transition:all .2s;text-shadow:1px 1px 2px #000;z-index:200}button.btn-play:hover:not(:disabled){transform:scale(1.05);box-shadow:0 0 35px rgba(0,229,255,1)}button.btn-play:disabled{filter:grayscale(.8) brightness(.7);cursor:not-allowed}#quiz-box{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;background:rgba(10,25,58,0.95);border:2px solid #00e5ff;padding:20px;border-radius:15px;text-align:center;z-index:200;box-shadow:0 0 30px rgba(0,229,255,0.5);backdrop-filter:blur(5px)}.selection-container{display:flex;justify-content:center;gap:8vw;width:100%;align-items:flex-start;margin-bottom:50px}.selection-group{display:flex;flex-direction:column;align-items:center;gap:15px}.selection-box{width:clamp(120px,20vw,200px);height:clamp(120px,20vw,200px);border:3px solid #00e5ff;border-radius:20px;box-shadow:0 0 15px #00e5ff,inset 0 0 10px #00e5ff;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;background:radial-gradient(ellipse at center,rgba(0,229,255,0.15) 0%,rgba(0,0,0,0) 70%)}.selection-box::before{content:attr(data-label);position:absolute;top:-45px;color:#fff;text-transform:uppercase;font-weight:700;font-size:clamp(18px,3vw,26px);text-shadow:0 0 5px #00e5ff,0 0 10px rgba(0,229,255,0.7)}.selection-box img{max-width:80%;max-height:80%;object-fit:contain;transition:transform .3s}.selection-box:hover img{transform:scale(1.1)}.choice-row{display:flex;gap:10px;justify-content:center;max-width:clamp(120px,25vw,250px);padding:5px;box-sizing:border-box;overflow-x:auto;background:rgba(0,0,0,.5);border-radius:10px;min-height:66px}.choice-thumb{width:50px;height:50px;object-fit:cover;border:3px solid rgba(0,229,255,0.3);border-radius:5px;cursor:pointer;transition:all .2s;flex-shrink:0}.choice-thumb:hover{transform:scale(1.1);border-color:#fff}.choice-thumb.active{border-color:#00e5ff;box-shadow:0 0 10px #00e5ff}</style></head><body><div id="game-box"><div class="hud" style="left:15px;display:none">‚è± <span id="ui-time">0</span></div><div class="hud" style="right:15px;display:none">üíé <span id="ui-score">0</span></div><canvas id="cvs"></canvas><div id="char-select-screen" class="screen"><h1 id="mt-title"></h1><div class="selection-container"><div class="selection-group"><div class="selection-box" id="avatar-box"><img id="avatar-display"></div><div id="avatar-choices" class="choice-row"></div></div><div class="selection-group"><div class="selection-box" id="creature-box"><img id="creature-display"></div><div id="creature-choices" class="choice-row"></div></div></div><button id="btn-play-game" class="btn-play" disabled></button></div><div id="scr-end" class="screen hidden"><h1 id="mt-end"></h1><p style="font-size:clamp(20px,4vw,30px);font-family:'Orbitron',sans-serif">–†–ï–ó–£–õ–¨–¢–ê–¢: <span id="end-score">0</span></p><button id="btn-restart" class="btn-play">‚Ü∫</button></div><div id="quiz-box"></div></div><script>
const CFG=${configJson};const IMG=CFG.img;const cvs=document.getElementById('cvs'),ctx=cvs.getContext('2d');let W,H;function resize(){W=cvs.width=window.innerWidth;H=cvs.height=window.innerHeight}window.addEventListener('resize',resize);resize();const AC=new(window.AudioContext||window.webkitAudioContext);function sfx(type){if(!AC||AC.state==='suspended')AC.resume();const t=AC.currentTime,o=AC.createOscillator(),g=AC.createGain();o.connect(g);g.connect(AC.destination);if(type==='coin'){o.type='sine';o.frequency.setValueAtTime(1200,t);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.5)}else if(type==='boom'){o.type='sawtooth';o.frequency.setValueAtTime(120,t);o.frequency.exponentialRampToValueAtTime(20,t+.4);g.gain.setValueAtTime(.2,t);g.gain.linearRampToValueAtTime(0,t+.4)}else if(type==='win'){o.type='triangle';[659,783,987].forEach((n,i)=>{o.frequency.setValueAtTime(n,t+i*.1)});g.gain.setValueAtTime(.1,t);g.gain.linearRampToValueAtTime(0,t+.4)}else if(type==='lose'){o.type='square';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(50,t+.4);g.gain.setValueAtTime(.15,t);g.gain.linearRampToValueAtTime(0,t+.4)}o.start(t);o.stop(t+.6)}
const iBg=new Image(),iObs=new Image(),iCoin=new Image(),iAvatar=new Image(),iCreature=new Image();if(IMG.bg)iBg.src=IMG.bg;if(IMG.obs)iObs.src=IMG.obs;if(IMG.coin)iCoin.src=IMG.coin;let music=null;if(IMG.music){music=new Audio(IMG.music);music.loop=true;music.volume=.4}
const titleEl=document.getElementById('mt-title');titleEl.innerText=CFG.title;document.getElementById('btn-play-game').innerText=CFG.btn;document.getElementById('avatar-box').dataset.label=CFG.lang.dict.game_avatar;document.getElementById('creature-box').dataset.label=CFG.lang.dict.game_creature;titleEl.onmouseenter=()=>{for(let i=0;i<5;i++){const b=document.createElement('div');b.className='bubble';b.style.left=Math.random()*100+'%';b.style.animationDelay=Math.random()*2+'s';titleEl.appendChild(b);setTimeout(()=>b.remove(),3000)}};let selectedAvatar=null,selectedCreature=null;function setupChoices(){const avc=document.getElementById('avatar-choices'),crc=document.getElementById('creature-choices'),btn=document.getElementById('btn-play-game');function chkSel(){if(selectedAvatar&&selectedCreature)btn.disabled=false}
IMG.avatars.forEach(s=>{const i=new Image();i.src=s;i.className='choice-thumb';i.onclick=()=>{selectedAvatar=s;document.getElementById('avatar-display').src=s;avc.querySelectorAll('img').forEach(c=>c.classList.remove('active'));i.classList.add('active');chkSel()};avc.appendChild(i)});IMG.creatures.forEach(s=>{const i=new Image();i.src=s;i.className='choice-thumb';i.onclick=()=>{selectedCreature=s;document.getElementById('creature-display').src=s;crc.querySelectorAll('img').forEach(c=>c.classList.remove('active'));i.classList.add('active');chkSel()};crc.appendChild(i)})}setupChoices();
const GM={run:false,pause:false,time:0,score:0,totalCoins:0,objs:[],player:{x:0,y:0,vx:0,vy:0},cam:{x:0,y:0},mouse:{x:0,y:0},hurt:0,timer:null,init:()=>{GM.time=parseInt(CFG.time);GM.score=0;GM.totalCoins=0;GM.objs=[];GM.hurt=0;GM.player={x:W/2,y:H/2,vx:0,vy:0};GM.cam={x:W/2,y:H/2};GM.mouse={x:W/2,y:H/2};const worldSize=2.5;const numQ=CFG.qs.length,numObs=numQ*2+10;for(let i=0;i<numQ;i++){GM.objs.push({x:Math.random()*W*worldSize,y:Math.random()*H*worldSize,t:'c',qid:i});GM.totalCoins++}
for(let i=0;i<numObs;i++)GM.objs.push({x:Math.random()*W*worldSize,y:Math.random()*H*worldSize,t:'o'});document.getElementById('ui-time').innerText=GM.time;document.getElementById('ui-score').innerText='0 / '+GM.totalCoins},start:()=>{if(!selectedAvatar||!selectedCreature)return;iAvatar.src=selectedAvatar;iCreature.src=selectedCreature;document.getElementById('char-select-screen').classList.add('hidden');document.querySelectorAll('.hud').forEach(h=>h.style.display='block');if(music)music.play().catch(e=>{});GM.run=true;loop();GM.timer=setInterval(()=>{if(GM.run&&!GM.pause){GM.time--;document.getElementById('ui-time').innerText=GM.time;if(GM.time<=0)GM.end(false)}},1e3)},end:win=>{GM.run=false;clearInterval(GM.timer);if(music)music.pause();const scr=document.getElementById('scr-end');scr.classList.remove('hidden');document.getElementById('mt-end').innerText=win?CFG.win:CFG.lose;document.getElementById('end-score').innerText=GM.score+' / '+GM.totalCoins;sfx(win?'win':'lose')},reset:()=>{document.getElementById('scr-end').classList.add('hidden');document.getElementById('char-select-screen').classList.remove('hidden');document.querySelectorAll('.hud').forEach(h=>h.style.display='none');GM.init();preLoop()}};
document.getElementById('btn-play-game').onclick=()=>{GM.init();GM.start()};document.getElementById('btn-restart').onclick=GM.reset;window.onmousemove=e=>{GM.mouse.x=e.clientX;GM.mouse.y=e.clientY};window.ontouchmove=e=>{e.preventDefault();GM.mouse.x=e.touches[0].clientX;GM.mouse.y=e.touches[0].clientY};
function loop(){if(!GM.run)return;requestAnimationFrame(loop);if(GM.pause){return}
const P=GM.player,speed=parseFloat(CFG.speed)/100;const dx=GM.mouse.x-W/2,dy=GM.mouse.y-H/2;const dist=Math.hypot(dx,dy);P.vx+=(dx/dist*speed||0);P.vy+=(dy/dist*speed||0);P.vx*=0.95;P.vy*=0.95;P.x+=P.vx;P.y+=P.vy;GM.cam.x+=(P.x-GM.cam.x)*0.1;GM.cam.y+=(P.y-GM.cam.y)*0.1;
ctx.clearRect(0,0,W,H);ctx.save();ctx.translate(W/2-GM.cam.x,H/2-GM.cam.y);
if(iBg.src&&iBg.complete){const bw=iBg.width,bh=iBg.height;ctx.fillStyle=ctx.createPattern(iBg,'repeat');ctx.fillRect(GM.cam.x-W,GM.cam.y-H,W*2,H*2)}else{ctx.fillStyle='#030c1f';ctx.fillRect(GM.cam.x-W,GM.cam.y-H,W*2,H*2)}
const pSize=80*parseFloat(CFG.scale),objSize=60*parseFloat(CFG.objScale);for(let i=GM.objs.length-1;i>=0;i--){const o=GM.objs[i];const img=o.t==='c'?iCoin:iObs;if(img.complete)ctx.drawImage(img,o.x-objSize/2,o.y-objSize/2,objSize,objSize);if(Math.hypot(o.x-P.x,o.y-P.y)<pSize/2+objSize/2){hit(GM.objs.splice(i,1)[0])}}
if(GM.hurt>0)GM.hurt--;if(!(GM.hurt>0&&Math.floor(GM.hurt/4)%2===0)){const ang=Math.atan2(P.vy,P.vx);ctx.save();ctx.translate(P.x,P.y);ctx.rotate(ang+Math.PI/2);const avSize=pSize*.5;if(iCreature.complete)ctx.drawImage(iCreature,-pSize/2,-pSize/2,pSize,pSize);if(iAvatar.complete)ctx.drawImage(iAvatar,-avSize/2,-pSize*0.4,avSize,avSize);ctx.restore()}ctx.restore()}
function preLoop(){if(GM.run)return;requestAnimationFrame(preLoop);ctx.clearRect(0,0,W,H);if(iBg.src&&iBg.complete){const offX=(Date.now()/50)%iBg.width;ctx.fillStyle=ctx.createPattern(iBg,'repeat');ctx.save();ctx.translate(-offX,0);ctx.fillRect(0,0,W+iBg.width,H);ctx.restore()}else{ctx.fillStyle='#030c1f';ctx.fillRect(0,0,W,H)}}
function hit(o){if(o.t==='o'){sfx('boom');GM.hurt=30;GM.time-=5}else if(o.t==='c'){sfx('coin');if(CFG.qs.length>0&&o.qid!==undefined){GM.pause=true;quiz(o.qid)}else{GM.score++}}document.getElementById('ui-time').innerText=GM.time;document.getElementById('ui-score').innerText=GM.score+' / '+GM.totalCoins;if(GM.totalCoins>0&&GM.score>=GM.totalCoins)GM.end(true)}
function quiz(id){const q=CFG.qs[id],box=document.getElementById('quiz-box');box.innerHTML=\`<h2>\${q.t}</h2>\`;const proc=a=>{box.style.display='none';if(a.trim().toLowerCase()===q.c.trim().toLowerCase()){sfx('win');GM.score++}else{sfx('lose');GM.time-=10}document.getElementById('ui-score').innerText=GM.score+' / '+GM.totalCoins;if(GM.totalCoins>0&&GM.score>=GM.totalCoins)GM.end(true);setTimeout(()=>GM.pause=false,200)};if(q.type==='choice'){[q.c,...q.w].sort(()=>.5-Math.random()).forEach(a=>{const b=document.createElement('button');b.className='q-btn';b.innerText=a;b.onclick=()=>proc(a);box.appendChild(b)})}box.style.display='block'}
GM.reset();
<\/script></body></html>`;
        document.getElementById('finalCode').value = CODE;
        document.getElementById('copySection').style.display = 'block';
    }
    setLang('ru');
</script>
</body>
</html>
